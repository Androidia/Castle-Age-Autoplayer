// ==UserScript==
// @name           Castle Age Autoplayer
// @namespace      caap
// @description    Auto player for Castle Age
// @version        140.22.15
// @require        http://cloutman.com/jquery-latest.min.js
// @require        http://github.com/Xotic750/Castle-Age-Autoplayer/raw/master/jquery-ui-1.8.1.custom.min.js
// @require        http://farbtastic.googlecode.com/svn/branches/farbtastic-1/farbtastic.min.js
// @include        http*://apps.*facebook.com/castle_age/*
// @include        http://www.facebook.com/common/error.html
// @include        http://www.facebook.com/reqs.php#confirm_46755028429_0
// @include        http://www.facebook.com/home.php
// @include        http://www.facebook.com/*filter=app_46755028429*
// @exclude        *#iframe*
// @license        GPL version 3 or any later version; http://www.gnu.org/copyleft/gpl.html
// @compatability  Firefox 3.0+, Chrome 4+, Flock 2.0+
// ==/UserScript==

/*jslint white: true, browser: true, devel: true, undef: true, nomen: true, bitwise: true, plusplus: true, immed: true */
/*global window,unsafeWindow,$,GM_log,console,GM_getValue,GM_setValue,GM_xmlhttpRequest,GM_openInTab,GM_registerMenuCommand,XPathResult,GM_deleteValue,GM_listValues,GM_addStyle,CM_Listener,CE_message,ConvertGMtoJSON,localStorage */

caapVersion = "140.22.15";

///////////////////////////
//       Prototypes
///////////////////////////

String.prototype.trim = function () {
    return this.replace(/^\s+|\s+$/g, '');
};

String.prototype.ucFirst = function () {
    var firstLetter = this.substr(0, 1);
    return firstLetter.toUpperCase() + this.substr(1);
};

String.prototype.stripHTML = function (html) {
    return this.replace(new RegExp('<[^>]+>', 'g'), '').replace(/&nbsp;/g, '');
};

///////////////////////////
//       Objects
///////////////////////////
var global = {};
var gm = {};
var Move = {};
var nHtml = {};
var caap = {};
caapVersion="140.22.15";String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")};String.prototype.ucFirst=function(){return this.substr(0,1).toUpperCase()+this.substr(1)};String.prototype.stripHTML=function(){return this.replace(new RegExp("<[^>]+>","g"),"").replace(/&nbsp;/g,"")};var global={},gm={},Move={},nHtml={},caap={};
global={gameName:"castle_age",discussionURL:"http://senses.ws/caap/index.php",debug:false,newVersionAvailable:false,documentTitle:document.title,is_chrome:navigator.userAgent.toLowerCase().indexOf("chrome")!=-1?true:false,is_firefox:navigator.userAgent.toLowerCase().indexOf("firefox")!=-1?true:false,os:"\n",vs:"\t",ls:"\u000c",hashStr:["41030325072","4200014995461306","2800013751923752","55577219620","65520919503","2900007233824090","2900007233824090","3100017834928060","3500032575830770","32686632448",
"2700017666913321"],symbol_tiny_1:"data:image/jpeg;base64,/9j/4AAQSkZJRgABAgAAZABkAAD/7AARRHVja3kAAQAEAAAAVQAA/+4ADkFkb2JlAGTAAAAAAf/bAIQAAgEBAQEBAgEBAgMCAQIDAwICAgIDAwMDAwMDAwQDBAQEBAMEBAUGBgYFBAcHCAgHBwoKCgoKDAwMDAwMDAwMDAECAgIEAwQHBAQHCggHCAoMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwM/8AAEQgAFgAWAwERAAIRAQMRAf/EAIQAAQADAQAAAAAAAAAAAAAAAAgFBgcJAQEBAQAAAAAAAAAAAAAAAAAGBwUQAAEEAQMCBAQHAAAAAAAAAAIBAwQFBhESBxMIACExCXEjFBZBUYEiMhUYEQABAgMFBwEJAAAAAAAAAAABEQIAAwQxQVESBfAhYYHBEwYikaGx0eEyQiMU/9oADAMBAAIRAxEAPwDmv2BdhuJ8oYbZ9yXcRauVnE8Ga1V1rGiuP2VlKNehEjtuIQKSj8xwzEgbb0XQiJNmxomlirnS5btwcQpwC7zBzyjW36dSTp8oZnsY4taSmZwBIC4G+EbcUPt45C9I4pzfAr3Ha2OZ1p5PW3y2zjDrZK0Ug62fHRhQ3Ju2t7SRPRdfCSt8TdLLmscHISACEsOOPKDekeYf0yJU57cudjXFDYSATyXjBwyP2x52J99uPdu0/IIw8Q5THk30LKjfkDXLSxa1+7KaJISuq0saKZI2pIe4Sb3aojijnUiTA1LSiXrhDltcDKL1sCrwjY+OLn729uHDX8KLqMYdcynsgYY8ya+uiR47EoxTz2g7GJlS9EX4+FXjE1oel7mhOV22EEvKJLnDfvAJXnt74jcx5Hhcg4+w/OKJCyaPMluN18JohOQ3KGMoqKCiqZK4JqpEuqr5J+SOaiszENeircMdr4m+laN/C89vM5pa0KSqZV9gQhAIunPVVe22e8GdvcRVPmerxe+CVDRfnip0l1YpAX8eoLL4N7PXU9PE+dVSxXib+Jf0ResU+XTzDQOZfl6gp0gn+3pcd5mO5bYTO22n+4cYUpCWsN+TFiQ0aRNX1dcslbY6W3Tf1EUPgvn4OUjpgHpCjayE1e2UfvKQj7LmHlSwmRoXFnEmOQuYPr4SwZVNb4sMj+wGSKtJFVq1lj+400Xptaaa66J436mZW9v9jX5eNnP6wcp5VD3PQ9q8Afl8IKE+d3l/7Hg29vCe/wBKdZw6qqMz6nU3H1AA0P8Alpv1VXN2v6J4PudM7gJG+EzWyu0QD6Y//9k%3D",
symbol_tiny_2:"data:image/jpeg;base64,/9j/4AAQSkZJRgABAgAAZABkAAD/7AARRHVja3kAAQAEAAAAVQAA/+4ADkFkb2JlAGTAAAAAAf/bAIQAAgEBAQEBAgEBAgMCAQIDAwICAgIDAwMDAwMDAwQDBAQEBAMEBAUGBgYFBAcHCAgHBwoKCgoKDAwMDAwMDAwMDAECAgIEAwQHBAQHCggHCAoMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwM/8AAEQgAFgAWAwERAAIRAQMRAf/EAIUAAQADAAAAAAAAAAAAAAAAAAgFBgkBAAIDAQEAAAAAAAAAAAAAAAMEAgUGCAcQAAIBAgUCBAUFAAAAAAAAAAIDAQQFERITBggAByExQSJRMkIUFVIjZBYXEQACAQIFAgQFBQAAAAAAAAABAhESAwAhMQQFQRNRYYEicbEyFAbwoWIjM//aAAwDAQACEQMRAD8Ax8438d29wjdu3dD2qsYMzE0gmoFYMJ0KEEm1Qte6UHkEigREZIsfbE0fIcglgVXJW2CAzAaE+PgvQkdT0x6V+Ifh1/lXO32YS5vWtm5btOYqVTogOT3SJZUYgFBPuJACRsvFzsjv3bNSior7tZ6dITjcbgduuNMJeQ6lGqioiwmfDBTRKPSZ6LuxttraN92pUdQT6RrM9BnOEfx61zXO79OK2lvvXnJHbZFAEfVVkO2FzqaVpjUHBzruIO+rZyIoez00tQR3NTqmKSXMGAWigi7SzUn3SiaaIdE4Z8mMYZ46gN45slipqC1RAqI+ExVHSdY+GD3PxvajlF263rRtG6bTNW3aW4Mge5TV2SxBDxNAbwqKC4m2zb28OOz3JcoTtLkXOsUbAURU50aLXmGTmMZXU0RjMfFgfrjGQvLasXKwDBMg9ZMgddQchGemFbexvbzlNt9u7IXS2VdRmlCBS2qwEZDU0ikAnFjud/RtSoXCCL7EDJtMFVEQxjYnT/eGZGBMZjwzeXr7sMcptbBsOl26pNoFqEJ/ygwS2RyHrRoJGeOgOc5teV2252WzvLb37JaG63KIAd8GQsEswwILQCR7fuACzUkBTEdx91VNbyK7f0tO2B3zT2+sQ0dSIYTEWq7VRozep5K9SMPPPiHnGHW1ZgdwCOimfUiPkccyWbbJx1xWBl7qBRGpRXqy8q1Hrgz8Tbh35s28qR3au3KvNIy6iu3076impZXcp8c9K24RpxMBhq5wJWXDUj5eg7hUa4sEB8tRI8p89YzB1jDvGXdym1cMjNYNU0mGAyrIifZ9NYZSmkw0HCY333B5CtRWJqNg20N1gp8vMLntVZlgM6mmxVVUCRT/AB1Ac/TMT0ZjfIg0geOZ/Yx88JWk49HDI152kQoVVMzlDAuZnSFnwwTKur71/wC00l2u1LR/277QnWu1uJf4/wDH6ZyalHJ6eXT1ImYZnz4+Op0qq2OwVU+3qf10iOkR5Yttxf5D7+3cuW/7M6FkzMmQDNXcqmc+53P5QMf/2Q%3D%3D",
symbol_tiny_3:"data:image/jpeg;base64,/9j/4AAQSkZJRgABAgAAZABkAAD/7AARRHVja3kAAQAEAAAAVQAA/+4ADkFkb2JlAGTAAAAAAf/bAIQAAgEBAQEBAgEBAgMCAQIDAwICAgIDAwMDAwMDAwQDBAQEBAMEBAUGBgYFBAcHCAgHBwoKCgoKDAwMDAwMDAwMDAECAgIEAwQHBAQHCggHCAoMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwM/8AAEQgAFgAWAwERAAIRAQMRAf/EAIIAAQEBAAAAAAAAAAAAAAAAAAgHCQEBAQEBAQAAAAAAAAAAAAAABgUHAAEQAAAGAQQCAQMFAAAAAAAAAAECAwQFBhESFQcIExQAISJCMTJDFwkRAAIBAgQEAgkFAQAAAAAAAAECERIDACExQVFxBAVhIoGRoTJCghMjFLHB0WJyBv/aAAwDAQACEQMRAD8AzJ6k9Y4NoyjbjdEkH3Is4VOWab22NJR9fjnay6UaIRah0038pImbKKoJOR9VFsBVVCqisQqZrunXMtp7izRbgGDBZiQIDfConMjOZAiM7fbeiF66ttjBYEyRIUAEzGUkxkCQNJ1yc/Kf+fPaCj8Zq2nmKaO64y0kK9jJlnVJ2Oik1FCoFM4im0LGlImJjgBhjXRFUw+pDDjPwB03/UIbp+2sf1Zww+ZiQ/JlUHDBux2bgCI7hjAlghUk8VEFB4hnIwIbB0WbxPaev16Cr/u1aWfPYWbpyk46RjYuWaxm8IrbvoO6Ug3LUSvkjYK6MgRdvq86XmNpyNdJbp2YBxBDRqvGNKhmDtMGIMYAmiBdA8u4nQ8J4e3UbTi9cIPYKTbxHJrUFHVfjUqBc1SMkvIopBs61C1V0oQgCAmTZyVeetFMftNgPzDMbrrVfbr1uCWVmmP91A8oIPLFbtrR1tsggVLAnIe4VieM5DacLLsNz7ykXiezueUeWIud6vyDCYLxc2iW5d7n3E4r5kkpEchpJEBlMpvp+oasGDHzMbHRWiyhLbfUMBtx8vEvr4csK+nN9bpLMKUk55RB+LgF08ecYIk7aXZX7FBY5k7i+eQ0MxQNgFnMhA123ykggXIhlVu2srFAxQyOtYpMZyAbTd83VoB8KNPzFY9dJ9WM9TKyxO7CPRM/qMHfo3Y+0FdYxbKp1t3ZeOJCWlkau4hpJpFzca9K1SNLrx6r9JwmaPFHwg/I7bKMjfYBxTVEhw8uJVemy1NwATlII2q0z1jMHmMscphPuCUnLYg7x++UenFxczYtJh+9r8bNS1z1a9pjWdGgTisQfvIwlAnp9IFDH/JrHicTY0AQcYgdvNs9S30BbFwznLEDjQCFHOlvZhF3H8n8Vfr1G2I2UE5eWsgltPdqGDZcrl2B/vqoXq9VGI2ba3i9JpKztbatt8rsjtBB0m99rc/a85jmM4973cfzaC/Ltq0lLojNXUKmjzVZRlGmm1NPhOD7s0hmApjIbR/PpmfHH//Z",
symbol_tiny_4:"data:image/jpeg;base64,/9j/4AAQSkZJRgABAgAAZABkAAD/7AARRHVja3kAAQAEAAAAVQAA/+4ADkFkb2JlAGTAAAAAAf/bAIQAAgEBAQEBAgEBAgMCAQIDAwICAgIDAwMDAwMDAwQDBAQEBAMEBAUGBgYFBAcHCAgHBwoKCgoKDAwMDAwMDAwMDAECAgIEAwQHBAQHCggHCAoMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwM/8AAEQgAFgAWAwERAAIRAQMRAf/EAIUAAQEAAAAAAAAAAAAAAAAAAAgJAQACAgMAAAAAAAAAAAAAAAAEBgEDBQcIEAABBAEEAgECBwAAAAAAAAADAQIEBQYREhMHFAgAMhUxIkJjFhcJEQACAQIEAwUFCQEAAAAAAAABAhESAwAhMQRBYQVRsSJSE/BxwdFCgZGh4fEyYhQVBv/aAAwDAQACEQMRAD8AlB6l+qd/2bJNdtiksLgYfvEhxI6zh1sIpnjitHCK8Y5M6VxuINhl4hhTe5pFe1rVjqPVrNpgL9z0rc0z5miSJ+kDidZykRmJf3ABhmhZj3n4YSOG+tNH2/HPhzbW8iSxo8T0vQ01rXhc38qoesZWQVG1FTRfHKN7f0rr8I3O32O2tf2HahfPUeOmcmqeAznsxLJbQVTHOT7HBnsfT3IYHs5XdUQa5TOnzT082mfOmDgxZQQeaOSkvjWS+tKDSSxdqHUbSC15Gciir1pDtjca4AoAYPTqsxNPmGYIiJgxBjELufASW4TPKezt/XDA/wAsJCZDdBHjUmMMzn1VhOSWJxmkqT4/X0vI1jCCVeCfTHjKuujXqmv1Jqt/9jt7b9FveoGLWnY5EAyWMEyDkQ4J5YD3yg2GnVSe/wCRxQCwh+tcrL+wca6zHHh91QYsCTey5bHFjkcQGg3I1j2aoxdqG2qi7tNV1+aFf/UTabS5uyx2rM1ABg658Dmc6ZnKYywun1giF/2GY9u7E0Mwz+2me0+NWEcoG9gjdHiOaqKgiz4NfkdocCN13KogXEYKs13akRn1Jp86du9LtMibMA0LYZT5oakDlJpPKRhsNkGLY0Cn8Y+WDF6c2Ps3VZTXh6XrJ9uSTPmso34/KSHaxZCMGs0kV5RkasZW8SSUOJ8dV2I7a/a5COqpt2W4bjAAJ46hKFP56c4ghveMWbhUJaSBlnOkc/hxwprjK/cYtrbgxnHLB3ao48tbv+ONx+BcFCip5SOlBubZUVXablFDRyr+G1dPgO7ey21tC8thbMrQSaln6KRC/Z4tNcpxU8FBVSFyjiOUCB34Gdzc9x/3DUZDkNRF+6eOYlBQEMfh4+cqGGMrTc/mc/IrlUvk+R+5tT5mbVpaXRGauoVNHiqyjKNNOFNPKcEKgggEzOZ4z935Rj//2Q%3D%3D",
symbol_tiny_5:"data:image/jpeg;base64,/9j/4AAQSkZJRgABAgAAZABkAAD/7AARRHVja3kAAQAEAAAAVQAA/+4ADkFkb2JlAGTAAAAAAf/bAIQAAgEBAQEBAgEBAgMCAQIDAwICAgIDAwMDAwMDAwQDBAQEBAMEBAUGBgYFBAcHCAgHBwoKCgoKDAwMDAwMDAwMDAECAgIEAwQHBAQHCggHCAoMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwM/8AAEQgAFgAWAwERAAIRAQMRAf/EAGsAAQEAAAAAAAAAAAAAAAAAAAgJAQEBAQAAAAAAAAAAAAAAAAABAgMQAAEDAgUCBAYDAAAAAAAAAAIBAwQFBhESEwcIABQxIhUJIUEyQmIWM0QXEQEBAQADAAAAAAAAAAAAAAABABEhQQL/2gAMAwEAAhEDEQA/AI58ethnb+kS7muKYUSgQybdmTnm+67dJJuJGjx4zhgD0p9GjNEcXTbbTOSEpCPUgZUtQmkeyg5upxKp3J7ba7JFZ20lNKNZkxKhT6y9bcgSVsm6zRXKZAJsRVMSKM6mAqhCuCoqmkQKkcMNzInKuPxvbZYW5Jb5xXAOe8FLBoI3qQzxl4K6UE4grJT4auQTb/kHFVCRml7Hd+bQ29cb8vda2ot47bNSDC8qBLjsSXDoNaokOjJPjg+ipnhS6caIqYKhYChCpovQmkdyZ5Pcsmvbkvxqwfb8u+3K9wfuejzQl0ZuSFWkTptRh+nzv2lpQizYzzSGgxQzNoIj5kVVLqPPnGVgPflyy6tyusymwHsLzp1DKmzFzojpyW6XXagUfH5ugxUWW8vjmPL4ph1qwR64hv8AJWDudETjzHkzrncfmDC9MeBh5oEbRZhEUsCY7XTypISQCsYYZsFyr0DxKSOu+8eXs15+E1alIj30KFqSaa5bLEwzRP67hVWe1qL9uhHQsfowXp2MiJJlbpf6jGqVRjJ+4ec6fTiORn1O4LOAGha3caubFVPV1fzwToWcv//Z"};
gm={log:function(c){var b=new Date,d=b.getHours(),e=b.getMinutes();b=b.getSeconds();d+="";if(d.length===1)d="0"+d;e+="";if(e.length===1)e="0"+e;b+="";if(b.length===1)b="0"+b;GM_log("v"+caapVersion+" ("+(d+":"+e+":"+b)+") : "+c)},debug:function(c){global.debug&&this.log(c)},setValue:function(c,b){this.debug("Set "+c+" to "+b);GM_setValue(global.gameName+"__"+c,b);return b},getValue:function(c,b){b=GM_getValue(global.gameName+"__"+c,b);this.debug("Get "+c+" value "+b);return b},deleteValue:function(c){this.debug("Delete "+
c+" value ");GM_deleteValue(global.gameName+"__"+c)},IsArray:function(c){return c&&!c.propertyIsEnumerable("length")&&typeof c==="object"&&typeof c.length==="number"},setList:function(c,b){if(this.IsArray(b)){GM_setValue(global.gameName+"__"+c,b.join(global.os));return b}else this.log("Attempted to SetList "+c+" to "+b.toString()+" which is not an array.")},getList:function(c){var b=GM_getValue(global.gameName+"__"+c,"");this.debug("GetList "+c+" value "+b);c=[];if(b!=="")c=b.split(global.os);return c},
listAddBefore:function(c,b){b=b.concat(this.getList(c));this.setList(c,b);return b},listPop:function(c){var b=this.getList(c);if(!b.length)return null;var d=b.pop();this.setList(c,b);return d},listPush:function(c,b,d){var e=this.getList(c);if(e.indexOf(b)==-1){e.push(b);if(d>0)for(;d<e.length;){b=e.shift();this.debug("Removing "+b+" from "+c+".")}this.setList(c,e)}},listFindItemByPrefix:function(c,b){var d=c.filter(function(e){return e.indexOf(b)===0});this.debug("List: "+c+" prefix "+b+" filtered "+
d);if(d.length)return d[0];return null},setObjVal:function(c,b,d){var e=this.getValue(c);if(e){var f=this.listFindItemByPrefix(e.split(global.vs),b+global.ls);if(f){e=e.split(global.vs);e.splice(e.indexOf(f),1,b+global.ls+d);this.setValue(c,e.join(global.vs))}else this.setValue(c,b+global.ls+d+global.vs+e)}else this.setValue(c,b+global.ls+d)},getObjVal:function(c,b,d){var e=null;e=c.indexOf(global.ls)<0?this.getValue(c):c;if(!e)return d;c=this.listFindItemByPrefix(e.split(global.vs),b+global.ls);
if(!c)return d;return c.split(global.ls)[1]},getListObjVal:function(c,b,d,e){c=this.getList(c);if(!c.length)return e;this.debug("have list "+c);b=this.listFindItemByPrefix(c,b+global.vs);if(!b)return e;this.debug("have obj "+b);d=this.listFindItemByPrefix(b.split(global.vs),d+global.ls);if(!d)return e;this.debug("have val "+d);return d.split(global.ls)[1]},setListObjVal:function(c,b,d,e,f){var i=this.getList(c);if(i.length){var h=this.listFindItemByPrefix(i,b+global.vs);if(h){b=h.split(global.vs);
if(f=this.listFindItemByPrefix(b,d+global.ls)){b.splice(b.indexOf(f),1,d+global.ls+e);i.splice(i.indexOf(h),1,b.join(global.vs))}else{b.push(d+global.ls+e);i.splice(i.indexOf(h),1,h+global.vs+d+global.ls+e)}this.setList(c,i)}else this.listPush(c,b+global.vs+d+global.ls+e,f)}else this.setValue(c,b+global.vs+d+global.ls+e)},deleteListObj:function(c,b){var d=this.getList(c);if(d.length)if(b=this.listFindItemByPrefix(d,b)){d.splice(d.indexOf(b),1);this.setList(c,d)}},getNumber:function(c,b){try{var d=
this.getValue(c),e=null;if(!d&&d!==0||isNaN(d))if(!b&&b!==0||isNaN(b))throw"Value of "+c+" and defaultValue are not numbers: '"+d+"', '"+b+"'";else e=b;else e=d;return Number(e)}catch(f){c="ERROR in GetNumber: "+f;this.log(c);alert(c);return""}}};
nHtml={xpath:{string:XPathResult.STRING_TYPE,unordered:XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,first:XPathResult.FIRST_ORDERED_NODE_TYPE},FindByAttrContains:function(c,b,d,e,f){if(d=="className")d="class";f||(f=document);if((c=f.evaluate(".//"+b+"[contains(translate(@"+d+",'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'),'"+e.toLowerCase()+"')]",c,null,this.xpath.first,null))&&c.singleNodeValue)return c.singleNodeValue;return null},FindByAttrXPath:function(c,b,d,e){var f=null;b=".//"+
b+"["+d+"]";try{if(c===null){gm.log("Trying to find xpath with null obj:"+b);return null}e||(e=document);f=e.evaluate(b,c,null,this.xpath.first,null)}catch(i){gm.log("XPath Failed:"+b+","+i)}if(f&&f.singleNodeValue)return f.singleNodeValue;return null},FindByAttr:function(c,b,d,e,f){if(e.exec===undefined){if(d=="className")d="class";f||(f=document);if((d=f.evaluate(".//"+b+"[@"+d+"='"+e+"']",c,null,this.xpath.first,null))&&d.singleNodeValue)return d.singleNodeValue;return null}c=c.getElementsByTagName(b);
for(b=0;b<c.length;b+=1){f=c[b];if(e.exec!==undefined){if(e.exec(f[d]))return f}else if(f[d]==e)return f}return null},FindByClassName:function(c,b,d){return this.FindByAttr(c,b,"className",d)},spaceTags:{td:1,br:1,hr:1,span:1,table:1},GetText:function(c){var b=" ";if(c.tagName!==undefined&&this.spaceTags[c.tagName.toLowerCase()])b+=" ";if(c.nodeName=="#text")return b+c.textContent;for(var d=0;d<c.childNodes.length;d+=1)b+=this.GetText(c.childNodes[d]);return b},timeouts:{},setTimeout:function(c,b){var d=
window.setTimeout(function(){c();nHtml.timeouts[d]=undefined},b);this.timeouts[d]=1},clearTimeouts:function(){for(var c in this.timeouts)this.timeouts.hasOwnProperty(c)&&window.clearTimeout(c);this.timeouts={}},getX:function(c,b,d){var e=null;switch(d){case this.xpath.string:e=document.evaluate(c,b,null,d,null).stringValue;break;case this.xpath.first:e=document.evaluate(c,b,null,d,null).singleNodeValue;break;case this.xpath.unordered:e=document.evaluate(c,b,null,d,null);break;default:}return e},getHTMLPredicate:function(c){for(var b=
c.length;b>1;b-=1)if(c.substr(b,1)=="/")return c.substr(b+1);return c},OpenInIFrame:function(c,b){var d=document.createElement("iframe");d.setAttribute("src",c);d.setAttribute("id",b);d.setAttribute("style","width:0;height:0;");document.documentElement.appendChild(d)},ResetIFrame:function(c){var b=document.getElementById(c);if(b){gm.log("Deleting iframe = "+c);b.parentNode.removeChild(b)}else gm.log("Frame not found = "+c);document.getElementById(c)&&gm.log("Found iframe")},Gup:function(c,b){c=c.replace(/[\[]/,
"\\[").replace(/[\]]/,"\\]");c=(new RegExp("[\\?&]"+c+"=([^&#]*)")).exec(b);return c===null?"":c[1]},ScrollToBottom:function(){if(document.body.scrollHeight)if(global.is_chrome){var c=document.body.scrollHeight,b=document.body.clientHeight;if(c>b){c=c-b;gm.log("Scrolling down by: "+c+"px");window.scroll(0,c);gm.log("Scrolled ok")}else gm.log("Not scrolling to bottom. Client height is greater than document height!")}else window.scrollBy(0,document.body.scrollHeight)},ScrollToTop:function(){if(global.is_chrome){gm.log("Scrolling to top");
window.scroll(0,0);gm.log("Scrolled ok")}else window.scrollByPages(-1000)},CountInstances:function(c,b){return c.split(b).length-1}};
Move={me:null,moveHandler:function(c){if(c!==null)if(c.button===0&&Move.me.dragOK){Move.me.style.left=c.clientX-Move.me.dragXoffset+"px";Move.me.style.top=c.clientY-Move.me.dragYoffset+"px"}},cleanup:function(){Move.me.removeEventListener("mousemove",Move.moveHandler,false);Move.me.removeEventListener("mouseup",Move.cleanup,false);if(Move.me.dragOK&&Move.me.style.left&&Move.me.style.top)switch(Move.me.id){case "caap_div":gm.setValue("caap_div_menuTop",Move.me.style.top.replace(/px/,""));gm.setValue("caap_div_menuLeft",
Move.me.style.left.replace(/px/,"")-$(caap.controlXY.selector).offset().left);gm.setValue("caap_div_zIndex","2");gm.setValue("caap_top_zIndex","1");break;case "caap_top":gm.setValue("caap_top_menuTop",Move.me.style.top.replace(/px/,""));gm.setValue("caap_top_menuLeft",Move.me.style.left.replace(/px/,"")-$(caap.dashboardXY.selector).offset().left);gm.setValue("caap_div_zIndex","1");gm.setValue("caap_top_zIndex","2");break;default:}Move.me.dragOK=false},dragHandler:function(c){if(!(c===null||this.nodeName!=
"DIV")){Move.me=this;switch(Move.me.id){case "caap_div":$("#caap_div").css("z-index","2");$("#caap_top").css("z-index","1");break;case "caap_top":$("#caap_div").css("z-index","1");$("#caap_top").css("z-index","2");break;default:return}Move.me.dragOK=true;Move.me.dragXoffset=c.clientX-Move.me.offsetLeft;Move.me.dragYoffset=c.clientY-Move.me.offsetTop;Move.me.style.left=c.clientX-Move.me.dragXoffset+"px";Move.me.style.right=null;Move.me.addEventListener("mousemove",Move.moveHandler,false);Move.me.addEventListener("mouseup",
Move.cleanup,false)}}};
caap={stats:{},lastReload:new Date,waitingForDomLoad:false,node_trigger:null,autoReloadMilliSecs:9E5,userRe:/(userId=|user=|\/profile\/|uid=)([0-9]+)/,levelRe:/Level\s*:\s*([0-9]+)/i,rankRe:/,\s*level\s*:?\s*[0-9]+\s+([a-z ]+)/i,armyRe:/My Army\s*\(?([0-9]+)/i,statusRe:/([0-9\.]+)\s*\/\s*([0-9]+)/i,htmlJunkRe:new RegExp("\\&[^;]+;","g"),energyRe:/([0-9]+)\s+(energy)/i,experienceRe:/\+([0-9]+)/,influenceRe:/([0-9]+)%/,moneyRe:/\$([0-9,]+)\s*-\s*\$([0-9,]+)/i,userNameRe:/"(.+)"/,init:function(){this.addExpDisplay();
this.SetControls();this.AddListeners();this.CheckResults()},VisitUrl:function(c,b){this.waitMilliSecs=b?b:5E3;window.location.href=c},Click:function(c,b){if(!c){gm.log("ERROR: Null object passed to Click");return null}if(caap.waitingForDomLoad===false){caap.JustDidIt("clickedOnSomething");caap.waitingForDomLoad=true}this.waitMilliSecs=b?b:5E3;b=document.createEvent("MouseEvents");b.initMouseEvent("click",true,true,window,0,0,0,0,0,false,false,false,false,0,null);return!c.dispatchEvent(b)},ClickAjax:function(c,
b){if(c){if(gm.getValue("clickUrl","").indexOf(c)<0){gm.setValue("clickUrl","http://apps.facebook.com/castle_age/"+c);caap.waitingForDomLoad=false}this.VisitUrl("javascript:void(a46755028429_ajaxLinkSend('globalContainer', '"+c+"'))",b)}else gm.log("ERROR: No link passed to Click Ajax")},ClickWait:function(c,b){this.setTimeout(function(){this.Click(c,b)},1E3+Math.floor(Math.random()*1E3))},generalList:[],generalBuyList:[],generalIncomeList:[],generalBankingList:[],standardGeneralList:["Idle","Monster",
"Fortify","Battle","SubQuest"],BuildGeneralLists:function(){this.generalList=["Get General List","Use Current","Under Level 4"].concat(gm.getList("AllGenerals"));var c=function(b){return caap.generalList.indexOf(b)>=0};this.generalBuyList=["Get General List","Use Current","Darius","Lucius","Garlan","Penelope"].filter(c);this.generalIncomeList=["Get General List","Use Current","Scarlett","Mercedes","Cid"].filter(c);this.generalBankingList=["Get General List","Use Current","Aeris"].filter(c)},GetCurrentGeneral:function(){try{var c=
nHtml.FindByAttrContains(document.body,"div","class","general_name_div3");if(!c)throw"Couldn't find current general div";return c.innerHTML.trim()}catch(b){gm.log("ERROR in GetCurrentGeneral: "+b);return"Use Current"}},CheckResults_generals:function(){var c=nHtml.getX("//div[@class='generalSmallContainer2']",document,nHtml.xpath.unordered);gm.setValue("AllGenerals","");gm.setValue("GeneralImages","");gm.setValue("LevelUpGenerals","");for(var b=0;b<c.snapshotLength;b+=1){var d=nHtml.getX("./div[@class='general_name_div3']/div[1]/text()",
c.snapshotItem(b),nHtml.xpath.string).replace(/[\t\r\n]/g,""),e=nHtml.getX(".//input[@class='imgButton']/@src",c.snapshotItem(b),nHtml.xpath.string);e=nHtml.getHTMLPredicate(e);var f=nHtml.getX("./div[4]/div[2]/text()",c.snapshotItem(b),nHtml.xpath.string).replace(/Level /gi,"").replace(/[\t\r\n]/g,"");gm.listPush("AllGenerals",d);gm.listPush("GeneralImages",d+":"+e);f<4&&gm.listPush("LevelUpGenerals",d)}gm.setList("AllGenerals",gm.getList("AllGenerals").sort())},ClearGeneral:function(c){gm.log("Setting "+
c+' to "Use Current"');gm.setValue(c,"Use Current");this.BuildGeneralLists();for(var b in this.standardGeneralList)this.standardGeneralList.hasOwnProperty(b)&&this.ChangeDropDownList(this.standardGeneralList[b]+"General",this.generalList,gm.getValue(this.standardGeneralList[b]+"General","Use Current"));this.ChangeDropDownList("BuyGeneral",this.generalBuyList,gm.getValue("BuyGeneral","Use Current"));this.ChangeDropDownList("IncomeGeneral",this.generalIncomeList,gm.getValue("IncomeGeneral","Use Current"));
this.ChangeDropDownList("BankingGeneral",this.generalBankingList,gm.getValue("BankingGeneral","Use Current"));this.ChangeDropDownList("LevelUpGeneral",this.generalList,gm.getValue("LevelUpGeneral","Use Current"))},SelectGeneral:function(c){if(gm.getValue("LevelUpGeneral","Use Current")!="Use Current"){var b=c.replace(/General/i,"").trim();if(gm.getValue(b+"LevelUpGeneral",false)&&this.stats.exp.dif&&this.stats.exp.dif<=gm.getValue("LevelUpGeneralExp",0)){c="LevelUpGeneral";gm.log("Using level up general")}}var d=
gm.getValue(c,"");if(!d)return false;if(!d||/use current/i.test(d))return false;if(/under level 4/i.test(d)){if(!gm.getList("LevelUpGenerals").length)return this.ClearGeneral(c);d=gm.getValue("ReverseLevelUpGenerals")?gm.getList("LevelUpGenerals").reverse().pop():gm.getList("LevelUpGenerals").pop()}(b=this.GetCurrentGeneral())||this.ReloadCastleAge();b=b.replace("**","");if(d.indexOf(b)>=0)return false;gm.log("Changing from "+b+" to "+d);if(this.NavigateTo("mercenary,generals","tab_generals_on.gif"))return true;
if(/get general list/i.test(d))return this.ClearGeneral(c);b=gm.getList("GeneralImages").filter(function(e){return e.indexOf(d.replace(/:\S*/,""))>=0}).toString().replace(/\S+:/,"");if(this.CheckForImage(b))return this.NavigateTo(b);this.SetDivContent("Could not find "+d);gm.log("Could not find "+b);return this.ClearGeneral(c)},oneMinuteUpdate:function(c){if(!gm.getValue("reset"+c)&&!this.WhileSinceDidIt(c+"Timer",60))return false;this.JustDidIt(c+"Timer");gm.setValue("reset"+c,false);return true},
NavigateTo:function(c,b){try{var d=document.getElementById("content");if(!d){gm.log("No content to Navigate to "+b+" using "+c);return false}if(b&&this.CheckForImage(b))return false;for(var e=c.split(","),f=e.length-1;f>=0;f-=1){var i=nHtml.FindByAttrXPath(d,"a","contains(@href,'/"+e[f]+".php') and not(contains(@href,'"+e[f]+".php?'))");if(i){gm.log("Go to "+e[f]);caap.Click(i);return true}var h=e[f];if(h.indexOf(".")==-1)h+=".";var g=nHtml.FindByAttrContains(document.body,"input","src",h);if(g){gm.log("Click on image "+
g.src.match(/[\w.]+$/));caap.Click(g);return true}var k=nHtml.FindByAttrContains(document.body,"img","src",h);if(k){gm.log("Click on image "+k.src.match(/[\w.]+$/));caap.Click(k);return true}}gm.log("Unable to Navigate to "+b+" using "+c);return false}catch(j){gm.log("ERROR in NavigateTo: "+j);gm.log("Unable to Navigate to "+b+" using "+c);return false}},CheckForImage:function(c,b,d){b||(b=d?d.body:document.body);var e=nHtml.FindByAttrContains(b,"input","src",c,d);if(e)return e;if(e=nHtml.FindByAttrContains(b,
"img","src",c,d))return e;if(e=nHtml.FindByAttrContains(b,"div","style",c,d))return e;return false},WhileSinceDidIt:function(c,b){/\d+/.test(c)||(c=gm.getValue(c,0));var d=(new Date).getTime();return parseInt(c,10)<d-1E3*b},JustDidIt:function(c){var b=(new Date).getTime();gm.setValue(c,b.toString())},DeceiveDidIt:function(c){gm.log("Deceive Did It");var b=(new Date).getTime()-65E5;gm.setValue(c,b.toString())},CheckTimer:function(c){c=gm.getValue(c);if(!c)return true;var b=(new Date).getTime();return c<
b},FormatTime:function(c){try{var b=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],d=c.getDay(),e=c.getHours(),f=c.getMinutes();if(gm.getValue("use24hr",true)){e+="";if(e.length===1)e="0"+e;f+="";if(f.length===1)f="0"+f;return b[d]+" "+e+":"+f}else{c="PM";if(e<12)c="AM";if(e===0)e=12;if(e>12)e-=12;f+="";if(f.length===1)f="0"+f;return b[d]+" "+e+":"+f+" "+c}}catch(i){gm.log("ERROR in FormatTime: "+i);return"Time Err"}},DisplayTimer:function(c){c=gm.getValue(c);if(!c)return false;var b=new Date;b.setTime(parseInt(c,
10));return this.FormatTime(b)},SetTimer:function(c,b){var d=(new Date).getTime();d+=b*1E3;gm.setValue(c,d.toString())},NumberOnly:function(c){return parseFloat(c.toString().replace(/,/g,"").match(/[\-\+]?[0-9]*\.?[0-9]+/g))},RemoveHtmlJunk:function(c){return c.replace(this.htmlJunkRe,"")},AppendTextToDiv:function(c,b){$("#"+c).append(b)},defaultDropDownOption:"<option disabled='disabled' value='not selected'>Choose one</option>",MakeDropDown:function(c,b,d,e){var f=gm.getValue(c,"defaultValue");
if(f=="defaultValue")f=gm.setValue(c,b[0]);var i=0;for(var h in b)if(b.hasOwnProperty(h)){if(f==b[h])break;i+=1}c="<select id='caap_"+c+"' "+(d[i]?" title='"+d[i]+"' ":"")+e+">";c+=this.defaultDropDownOption;for(var g in b)if(b.hasOwnProperty(g))c+=d?"<option value='"+b[g]+"'"+(f==b[g]?" selected='selected'":"")+(d[g]?" title='"+d[g]+"'":"")+">"+b[g]+"</option>":"<option value='"+b[g]+"'"+(f==b[g]?" selected='selected'":"")+">"+b[g]+"</option>";c+="</select>";return c},DBDropDown:function(c,b,d,e){var f=
gm.getValue(c,"defaultValue");if(f=="defaultValue")f=gm.setValue(c,b[0]);c=" <select id='caap_"+c+"' "+e+"'><option>"+f;for(var i in b)if(b.hasOwnProperty(i))if(f!=b[i])c+=d?"<option value='"+b[i]+"' "+(d[i]?" title='"+d[i]+"'":"")+">"+b[i]:"<option value='"+b[i]+"'>"+b[i];c+="</select>";return c},MakeCheckBox:function(c,b,d,e,f){gm.getValue(c,"defaultValue")=="defaultValue"&&gm.setValue(c,b);b="<input type='checkbox' id='caap_"+c+"' title=\""+e+'"'+(d?" class='"+d+"'":"")+(gm.getValue(c)?"checked":
"")+" />";if(d){b+=f?"</td></tr></table>":"<br />";b+=this.AddCollapsingDiv(c,d)}return b},MakeNumberForm:function(c,b,d,e){gm.getValue(c,"defaultValue")=="defaultValue"&&gm.setValue(c,d);e||(e="size='4'");return" <input type='text' id='caap_"+c+"' "+e+' title="'+b+"\" value='"+gm.getValue(c,"")+"' />"},MakeCheckTR:function(c,b,d,e,f,i){c="<tr><td style='width: 90%'>"+c+"</td><td style='width: 10%; text-align: right'>"+this.MakeCheckBox(b,d,e,f,i);i||(c+="</td></tr>");return c},AddCollapsingDiv:function(c,
b){return"<div id='caap_"+b+"' style='display: "+(gm.getValue(c,false)?"block":"none")+"'>"},ToggleControl:function(c,b){var d=gm.getValue("Control_"+c,"none"),e="-";if(d=="none")e="+";return'<b><a id="caap_Switch_'+c+'" href="javascript:;" style="text-decoration: none;"> '+e+" "+b+"</a></b><br /><div id='caap_"+c+"' style='display: "+d+"'>"},MakeTextBox:function(c,b,d){return'<textarea title="'+b+"\" type='text' id='caap_"+c+"' "+d+">"+gm.getValue(c,"")+"</textarea>"},SaveBoxText:function(c){try{var b=
$("#caap_"+c).val();if(typeof b!="string")throw"Value of the textarea id='caap_"+c+"' is not a string: "+b;gm.setValue(c,b);return true}catch(d){gm.log("ERROR in SaveBoxText: "+d);return false}},SetDivContent:function(c,b){try{if(gm.getValue("SetTitle",false)&&gm.getValue("SetTitleAction",false)&&c=="activity_mess"){var d=b.replace("Activity: ","")+" - ";if(gm.getValue("SetTitleName",false))d+=gm.getValue("PlayerName","CAAP")+" - ";document.title=d+global.documentTitle}$("#caap_"+c).html(b)}catch(e){gm.log("ERROR in SetDivContent: "+
e)}},questWhenList:["Energy Available","At Max Energy","Not Fortifying","Never"],questAreaList:["Quest","Demi Quests","Atlantis"],landQuestList:["Land of Fire","Land of Earth","Land of Mist","Land of Water","Demon Realm","Undead Realm","Underworld"],demiQuestList:["Ambrosia","Malekus","Corvintheus","Aurora","Azeron"],atlantisQuestList:["Null"],questForList:["Advancement","Max Influence","Max Gold","Max Experience","Manual"],SelectDropOption:function(c,b){try{$("#caap_"+c+" option").removeAttr("selected");
$("#caap_"+c+" option[value='"+b+"']").attr("selected","selected");return true}catch(d){gm.log("ERROR in SelectDropOption: "+d);return false}},ShowAutoQuest:function(){try{$("#stopAutoQuest").text("Stop auto quest: "+gm.getObjVal("AutoQuest","name")+" (energy: "+gm.getObjVal("AutoQuest","energy")+")");$("#stopAutoQuest").css("display","block");return true}catch(c){gm.log("ERROR in ShowAutoQuest: "+c);return false}},ClearAutoQuest:function(){try{$("#stopAutoQuest").text("");$("#stopAutoQuest").css("display",
"none");return true}catch(c){gm.log("ERROR in ClearAutoQuest: "+c);return false}},ManualAutoQuest:function(){try{this.SelectDropOption("WhyQuest","Manual");this.ClearAutoQuest();return true}catch(c){gm.log("ERROR in ManualAutoQuest: "+c);return false}},ChangeDropDownList:function(c,b,d){try{$("#caap_"+c+" option").remove();$("#caap_"+c).append(this.defaultDropDownOption);for(var e in b)if(b.hasOwnProperty(e)){if(e=="0"&&!d){gm.setValue(c,b[e]);gm.log("Saved: "+c+"  Value: "+b[e])}$("#caap_"+c).append("<option value='"+
b[e]+"'>"+b[e]+"</option>")}d?$("#caap_"+c+" option[value='"+d+"']").attr("selected","selected"):$("#caap_"+c+" option:eq(1)").attr("selected","selected");return true}catch(f){gm.log("ERROR in ChangeDropDownList: "+f);return false}},divList:["activity_mess","idle_mess","quest_mess","battle_mess","fortify_mess","heal_mess","demipoint_mess","demibless_mess","level_mess","arena_mess","debug1_mess","debug2_mess","control"],controlXY:{selector:".UIStandardFrame_Content",x:0,y:0},GetControlXY:function(c){try{var b=
0;b=c?$(this.controlXY.selector).offset().top:this.controlXY.y;var d=0;d=this.controlXY.x===""||c?$(this.controlXY.selector).offset().left+$(this.controlXY.selector).width()+10:$(this.controlXY.selector).offset().left+this.controlXY.x;return{x:d,y:b}}catch(e){gm.log("ERROR in GetControlXY: "+e);return{x:0,y:0}}},dashboardXY:{selector:"#app46755028429_app_body_container",x:0,y:0},GetDashboardXY:function(c){try{var b=0;b=c?$(this.dashboardXY.selector).offset().top-10:this.dashboardXY.y;var d=0;d=this.dashboardXY.x===
""||c?$(this.dashboardXY.selector).offset().left:$(this.dashboardXY.selector).offset().left+this.dashboardXY.x;return{x:d,y:b}}catch(e){gm.log("ERROR in GetDashboardXY: "+e);return{x:0,y:0}}},SetControls:function(){try{if(gm.getValue("caapPause","none")!=="none"&&gm.getValue("caapPause","none")!=="block"){gm.log("Refresh page because unable to load gm.values due to unsafewindow error");this.VisitUrl(window.location.href)}gm.getValue("HideAds",false)&&$(".UIStandardFrame_SidebarAds").css("display",
"none");var c=gm.getValue("ShiftDown","");c&&$(this.controlXY.selector).css("padding-top",c);c="<div id='caap_div'>";for(var b in this.divList)if(this.divList.hasOwnProperty(b))c+="<div id='caap_"+this.divList[b]+"'></div>";c+="</div>";this.controlXY.x=gm.getValue("caap_div_menuLeft","");this.controlXY.y=gm.getValue("caap_div_menuTop",$(this.controlXY.selector).offset().top);var d=this.GetControlXY();$(c).css({width:"180px",background:gm.getValue("StyleBackgroundLight","#E0C691"),opacity:gm.getValue("StyleOpacityLight",
"1"),color:"#000",padding:"4px",border:"2px solid #444",top:d.y+"px",left:d.x+"px",zIndex:gm.getValue("caap_div_zIndex","2"),position:"absolute"}).appendTo(document.body);this.CheckLastAction(gm.getValue("LastAction","none"));b="";if(global.is_chrome)b+="<div id='caapPausedDiv' style='display: none'><a href='javascript:;' id='caapPauseA' >Pause</a></div>";b+="<div id='caapPaused' style='display: "+gm.getValue("caapPause","block")+"'><b>Paused on mouse click.</b><br /><a href='javascript:;' id='caapRestart' >Click here to restart</a></div>";
b+="<hr /><table width='180px' cellpadding='0px' cellspacing='0px'>";b+=this.MakeCheckTR("Disable Autoplayer","Disabled",false,"","Disable auto running of CAAP. Stays persistent even on page reload and the autoplayer will not autoplay.")+"</table>";b+="<hr />"+this.ToggleControl("CashandHealth","CASH and HEALTH");b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+=this.MakeCheckTR("Bank Immediately","BankImmed",false,"","Bank as soon as possible. May interrupt player and monster battles.");
b+=this.MakeCheckTR("Auto Buy Lands","autoBuyLand",false,"","Automatically buy lands in groups of 10 based on best Return On Investment value.");b+=this.MakeCheckTR("Auto Sell Excess Lands","SellLands",false,"","Automatically sell off any excess lands above your level allowance.")+"</table>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+="<tr><td>Keep In Bank</td><td style='text-align: right'>$"+this.MakeNumberForm("minInStore","Minimum cash to keep in the bank. Press tab to save",
1E5,"type='text' size='12' style='font-size: 10px; text-align: right'")+"</td></tr></table>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+="<tr><td>Bank Above</td><td style='text-align: right'>$"+this.MakeNumberForm("MaxInCash","Maximum cash to have on hand, bank anything above this, press tab to save (leave blank to disable).","","type='text' size='7' style='font-size: 10px; text-align: right'")+"</td></tr>";b+="<tr><td style='padding-left: 10px'>But Keep On Hand</td><td style='text-align: right'>$"+
this.MakeNumberForm("MinInCash","Minimum cash to have on hand, press tab to save","","type='text' size='7' style='font-size: 10px; text-align: right'")+"</td></tr></table>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+="<tr><td>Heal If Health Below</td><td style='text-align: right'>"+this.MakeNumberForm("MinToHeal","Minimum health to have before healing, press tab to save (leave blank to disable).",10,"size='2' style='font-size: 10px; text-align: right'")+"</td></tr>";b+="<tr><td style='padding-left: 10px'>But Not If Stamina Below</td><td style='text-align: right'>"+
this.MakeNumberForm("MinStamToHeal","Minimum Stamina to have before healing, press tab to save (leave blank to disable).","","size='2' style='font-size: 10px; text-align: right'")+"</td></tr></table>";b+="<hr/></div>";b+=this.ToggleControl("Quests","QUEST");b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+="<tr><td width=80>Quest When</td><td style='text-align: right; width: 60%'>"+this.MakeDropDown("WhenQuest",this.questWhenList,"","style='font-size: 10px; width: 100%'")+"</td></tr></table>";
b+="<div id='caap_WhenQuestHide' style='display: "+(gm.getValue("WhenQuest",false)!="Never"?"block":"none")+"'>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+="<tr><td>Quest Area</td><td style='text-align: right; width: 60%'>"+this.MakeDropDown("QuestArea",this.questAreaList,"","style='font-size: 10px; width: 100%'")+"</td></tr>";switch(gm.getValue("QuestArea",this.questAreaList[0])){case "Quest":b+="<tr id='trQuestSubArea' style='display: table-row'><td>Sub Area</td><td style='text-align: right; width: 60%'>"+
this.MakeDropDown("QuestSubArea",this.landQuestList,"","style='font-size: 10px; width: 100%'")+"</td></tr>";break;case "Demi Quests":b+="<tr id='trQuestSubArea' style='display: table-row'><td>Sub Area</td><td style='text-align: right; width: 60%'>"+this.MakeDropDown("QuestSubArea",this.demiQuestList,"","style='font-size: 10px; width: 100%'")+"</td></tr>";break;default:gm.deleteValue("QuestSubArea");b+="<tr id='trQuestSubArea' style='display: none'><td>Sub Area</td><td style='text-align: right; width: 60%'>"+
this.MakeDropDown("QuestSubArea",this.atlantisQuestList,"","style='font-size: 10px; width: 100%'")+"</td></tr>";break}b+="<tr><td>Quest For</td><td style='text-align: right; width: 60%'>"+this.MakeDropDown("WhyQuest",this.questForList,"","style='font-size: 10px; width: 100%'")+"</td></tr></table>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+=this.MakeCheckTR("Switch Quest Area","swithQuestArea",false,"","Allows switching quest area after Advancement or Max Influence");b+=this.MakeCheckTR("Use Only Subquest General",
"ForceSubGeneral",false,"","Always do a quest with the Subquest General you selected under the Generals section. NOTE: This will keep the script from automatically switching to the required general for experience of primary quests.");b+=this.MakeCheckTR("Quest For Orbs","GetOrbs",false,"","Perform the Boss quest in the selected land for orbs you do not have.")+"</table>";b+="</div>";var e=gm.getObjVal("AutoQuest","name");b+=e?"<a id='stopAutoQuest' style='display: block' href='javascript:;'>Stop auto quest: "+
e+" (energy: "+gm.getObjVal("AutoQuest","energy")+")</a>":"<a id='stopAutoQuest' style='display: none' href='javascript:;'></a>";b+="<hr/></div>";b+=this.ToggleControl("Battling","BATTLE");e=["Invade","Duel"];c=["Battle using Invade button","Battle using Duel button - no guarentee you will win though"];b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+="<tr><td>Battle When</td><td style='text-align: right; width: 65%'>"+this.MakeDropDown("WhenBattle",["Stamina Available","At Max Stamina",
"At X Stamina","No Monster","Stay Hidden","Never"],["Stamina Available will battle whenever you have enough stamina","At Max Stamina will battle when stamina is at max and will burn down all stamina when able to level up","At X Stamina you can set maximum and minimum stamina to battle","No Monster will battle only when there are no active monster battles",'Stay Hidden uses stamina to try to keep you under 10 health so you cannot be attacked, while also attempting to maximize your stamina use for Monster attacks. YOU MUST SET MONSTER OR ARENA TO "STAY HIDDEN" TO USE THIS FEATURE.',
"Never - disables player battles"],"style='font-size: 10px; width: 100%'")+"</td></tr></table>";b+="<div id='caap_WhenBattleStayHidden1' style='display: "+(gm.getValue("WhenBattle",false)=="Stay Hidden"&&gm.getValue("WhenMonster",false)!="Stay Hidden"?"block":"none")+"'>";b+="<font color='red'><b>Warning: Monster Not Set To 'Stay Hidden'</b></font>";b+="</div>";b+="<div id='caap_WhenBattleStayHidden2' style='display: "+(gm.getValue("WhenBattle",false)=="Stay Hidden"&&gm.getValue("TargetType",false)==
"Arena"&&gm.getValue("ArenaHide",false)=="None"?"block":"none")+"'>";b+="<font color='red'><b>Warning: Arena Must Have 'Hide Using' Active To Support Hiding</b></font>";b+="</div>";b+="<div id='caap_WhenBattleXStamina' style='display: "+(gm.getValue("WhenBattle",false)!="At X Stamina"?"none":"block")+"'>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+="<tr><td>Start Battles When Stamina</td><td style='text-align: right'>"+this.MakeNumberForm("XBattleStamina","Start battling if stamina is above this points",
1,"size='2' style='font-size: 10px; text-align: right'")+"</td></tr>";b+="<tr><td style='padding-left: 10px'>Keep This Stamina</td><td style='text-align: right'>"+this.MakeNumberForm("XMinBattleStamina","Don't battle if stamina is below this points",0,"size='2' style='font-size: 10px; text-align: right'")+"</td></tr></table>";b+="</div>";b+="<div id='caap_WhenBattleHide' style='display: "+(gm.getValue("WhenBattle",false)!="Never"?"block":"none")+"'>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";
b+="<tr><td>Battle Type</td><td style='text-align: right; width: 40%'>"+this.MakeDropDown("BattleType",e,c,"style='font-size: 10px; width: 100%'")+"</td></tr></table>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+=this.MakeCheckTR("Clear Complete Raids","clearCompleteRaids",false,"","");b+=this.MakeCheckTR("Ignore Battle Losses","IgnoreBattleLoss",false,"","Ignore battle losses and attack regardless.  This will also delete all battle loss records.");b+="<tr><td>Chain:Battle Points Won</td><td style='text-align: right'>"+
this.MakeNumberForm("ChainBP","Number of battle points won to initiate a chain attack. Specify 0 to always chain attack.","","size='2' style='font-size: 10px; text-align: right'")+"</td></tr>";b+="<tr><td>Chain:Gold Won</td><td style='text-align: right'>"+this.MakeNumberForm("ChainGold","Amount of gold won to initiate a chain attack. Specify 0 to always chain attack.","","size='5' style='font-size: 10px; text-align: right'")+"</td></tr></table>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";
b+="<tr><td>Target Type</td><td style='text-align: right; width: 50%'>"+this.MakeDropDown("TargetType",["Freshmeat","Userid List","Raid","Arena"],["Use settings to select a target from the Battle Page","Select target from the supplied list of userids","Raid Battles"],"style='font-size: 10px; width: 100%'")+"</td></tr></table>";b+="<div id='caap_FreshmeatSub' style='display: "+(gm.getValue("TargetType",false)!="Userid List"?"block":"none")+"'>";b+="Attack targets that are:";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";
b+="<tr><td style='padding-left: 10px'>Not Lower Than Rank Minus </td><td style='text-align: right'>"+this.MakeNumberForm("FreshMeatMinRank","The lowest relative rank below yours that you are willing to spend your stamina on. Leave blank to attack any rank.","","size='2' style='font-size: 10px; text-align: right'")+"</td></tr>";b+="<tr><td style='padding-left: 10px'>Not Higher Than X*Army </td><td style='text-align: right'>"+this.MakeNumberForm("FreshMeatARBase","This value sets the base for your army ratio calculation. It is basically a multiplier for the army size of a player at your equal level. A value of 1 means you will battle an opponent the same level as you with an army the same size as you or less. Default .5",
"0.5","size='2' style='font-size: 10px; text-align: right'")+"</td></tr></table>";b+="</div>";b+="<div id='caap_RaidSub' style='display: "+(gm.getValue("TargetType",false)=="Raid"?"block":"none")+"'>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+=this.MakeCheckTR("Attempt +1 Kills","PlusOneKills",false,"","Force +1 kill scenario if 80% or more of targets are withn freshmeat settings. Note: Since Castle Age choses the target, selecting this option could result in a greater chance of loss.")+
"</table>";b+="Join Raids in this order <a href='http://senses.ws/caap/index.php?topic=1502.0' target='_blank'><font color='red'>?</font></a><br />";b+=this.MakeTextBox("orderraid","List of search words that decide which raids to participate in first.  Use words in player name or in raid name. To specify max damage follow keyword with :max token and specifiy max damage values. Use 'k' and 'm' suffixes for thousand and million."," rows='3' cols='25'");b+="</div>";e=["None","Freshmeat","Raid"];c=["Never switch from battling in the Arena",
"Switch fom Arena to fresmeat battles to reduce health below specifed level","Switch fom Arena to raid battles to reduce health below specifed level"];b+="<div id='caap_ArenaSub' style='display: "+(gm.getValue("TargetType",false)=="Arena"?"block":"none")+"'>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+="<tr><td>Maintain Rank</td><td style='text-align: right; width : 50%'>"+this.MakeDropDown("ArenaGoal",["","Swordsman","Warrior","Gladiator","Hero","Legend"],"","style='font-size: 10px; width : 100%'")+
"</td></tr>";b+="<tr><td>Hide Using</td><td style='text-align: right; width : 50%'>"+this.MakeDropDown("ArenaHide",e,c,"style='font-size: 10px; width : 100%'")+"</td></tr></table>";b+="<div id='caap_ArenaHSub' style='display: "+(gm.getValue("ArenaHide",false)=="None"?"none":"block")+"'>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+="<tr><td style='padding-left: 10px'>Arena If Health Below</td><td style='text-align: right'>"+this.MakeNumberForm("ArenaMaxHealth","If your health is below this value, you will continue to stay in the Arena. If your health is above this level, your stamina will be checked to see if it is above the stamina threshold to stay in the Arena.",
"20","size='2' style='font-size: 10px; text-align: right'")+"</td></tr>";b+="<tr><td style='padding-left: 10px'><b>OR</b></td><td></td></tr>";b+="<tr><td style='padding-left: 10px'>Arena If Stamina Above</td><td style='text-align: right'>"+this.MakeNumberForm("ArenaMinStamina","If your stamina is above this value, you will continue to stay in the Arena. If your stamina is below this level, your health will be checked to see if it is below the health thershold for you to stay in the Arena. ","35",
"size='2' style='font-size: 10px; text-align: right'")+"</td></tr></table>";b+="</div>";b+="</div>";b+="<div align=right id='caap_UserIdsSub' style='display: "+(gm.getValue("TargetType",false)=="Userid List"?"block":"none")+"'>";b+=this.MakeTextBox("BattleTargets","User IDs(not user name).  Click with the right mouse button on the link to the users profile & copy link.  Then paste it here and remove everything but the last numbers. (ie. 123456789)"," rows='3' cols='25'");b+="</div>";b+="</div>";b+=
"<hr/></div>";b+=this.ToggleControl("Monster","MONSTER");b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+="<tr><td style='width: 35%'>Attack When</td><td style='text-align: right'>"+this.MakeDropDown("WhenMonster",["Stamina Available","At Max Stamina","At X Stamina","Stay Hidden","Never"],["Stamina Available will attack whenever you have enough stamina","At Max Stamina will attack when stamina is at max and will burn down all stamina when able to level up","At X Stamina you can set maximum and minimum stamina to battle",
'Stay Hidden uses stamina to try to keep you under 10 health so you cannot be attacked, while also attempting to maximize your stamina use for Monster attacks. YOU MUST SET BATTLE WHEN TO "STAY HIDDEN" TO USE THIS FEATURE.',"Never - disables attacking monsters"],"style='font-size: 10px; width: 100%;'")+"</td></tr></table>";b+="<div id='caap_WhenMonsterXStamina' style='display: "+(gm.getValue("WhenMonster",false)!="At X Stamina"?"none":"block")+"'>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";
b+="<tr><td>Battle When Stamina</td><td style='text-align: right'>"+this.MakeNumberForm("XMonsterStamina","Start attacking if stamina is above this points",1,"size='3' style='font-size: 10px; text-align: right'")+"</td></tr>";b+="<tr><td style='padding-left: 10px'>Keep This Stamina</td><td style='text-align: right'>"+this.MakeNumberForm("XMinMonsterStamina","Don't attack if stamina is below this points",0,"size='3' style='font-size: 10px; text-align: right'")+"</td></tr></table>";b+="</div>";b+="<div id='caap_WhenMonsterHide' style='display: "+
(gm.getValue("WhenMonster",false)!="Never"?"block":"none")+"'>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+="<tr><td>Monster delay secs</td><td style='text-align: right'>"+this.MakeNumberForm("seedTime","Max random delay to battle monsters",300,"type='text' size='4' style='font-size: 10px; text-align: right'")+"</td></tr>";b+=this.MakeCheckTR("Power Attack Only","PowerAttack",true,"","Use power attacks. Only do normal attacks if power attack not possible");b+=this.MakeCheckTR("Siege weapon assist",
"DoSiege",true,"","Turns on or off automatic siege assist for all monsters and raids.");b+=this.MakeCheckTR("Clear Complete Monsters","clearCompleteMonsters",false,"","");b+=this.MakeCheckTR("Achievement Mode","AchievementMode",true,"","Check if monsters have reached achievement damage level first. Switch when achievement met.");b+=this.MakeCheckTR("Get Demi Points First","DemiPointsFirst",false,"DemiList","Don't attack monsters until you've gotten all your demi points from battling.",true);e=["Ambrosia",
"Malekus","Corvintheus","Aurora","Azeron"];var f=['<img src="'+global.symbol_tiny_1+'" height="15" width="14"/>','<img src="'+global.symbol_tiny_2+'" height="15" width="14"/>','<img src="'+global.symbol_tiny_3+'" height="15" width="14"/>','<img src="'+global.symbol_tiny_4+'" height="15" width="14"/>','<img src="'+global.symbol_tiny_5+'" height="15" width="14"/>'];b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";for(var i in f)if(f.hasOwnProperty(i))b+=f[i]+this.MakeCheckBox("DemiPoint"+
i,true,"",e[i]);b+="</table>";b+="</div>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+="<tr><td>Fortify If Percentage Under</td><td style='text-align: right'>"+this.MakeNumberForm("MaxToFortify","Fortify if ship health is below this % (leave blank to disable)",50,"size='2' style='font-size: 10px; text-align: right'")+"</td></tr>";b+="<tr><td style='padding-left: 10px'>Quest If Percentage Over</td><td style='text-align: right'>"+this.MakeNumberForm("MaxHealthtoQuest","Do Quests if ship health is above this % and quest mode is set to Not Fortify (leave blank to disable)",
60,"size='2' style='font-size: 10px; text-align: right'")+"</td></tr>";b+="<tr><td>No Attack If Percentage Under</td><td style='text-align: right'>"+this.MakeNumberForm("MinFortToAttack","Don't attack if ship health is below this % (leave blank to disable)",10,"size='2' style='font-size: 10px; text-align: right'")+"</td></tr></table>";b+="Attack Monsters in this order <a href='http://senses.ws/caap/index.php?topic=1502.0' target='_blank'><font color='red'>?</font></a><br />";b+=this.MakeTextBox("orderbattle_monster",
"List of search words that decide which monster to attack first.  Use words in player name or in monster name. To specify max damage follow keyword with :max token and specifiy max damage values. Use 'k' and 'm' suffixes for thousand and million. To override achievement use the ach: token and specify damage values."," rows='3' cols='25'");b+="</div>";b+="<hr/></div>";b+=this.ToggleControl("MonsterFinder","MONSTER FINDER");b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+=this.MakeCheckTR("Use Monster Finder",
"MonsterFinderUse",false,"MonsterFinderUse_Adv","When monsters are over max damage, use Monster Finder?",true);b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+="<tr><td>Monster Find Min Stam</td><td style='text-align: right'>"+this.MakeNumberForm("MonsterFinderMinStam","Don't find new monster if stamina under this amount",50,"size='3' style='font-size: 10px; text-align: right'")+"</td></tr>";b+="<tr><td>Min-Check Feed (minutes)</td><td style='text-align: right'>"+this.MakeNumberForm("MonsterFinderFeedMin",
"Wait at least this many minutes before checking the Castle Age feed (in Facebook) (Max 120)",15,"size='3' style='font-size: 10px; text-align: right'")+"</td></tr></table>";b+="Find Monster Priority <a href='http://senses.ws/caap/index.php?topic=66.0' target='_blank'><font color='red'>?</font></a>";b+=this.MakeTextBox("MonsterFinderOrder","List of search words that decide which monster to attack first.  Can be names or monster types."," rows='3' cols='25'");b+="</div>";b+="<hr/></div>";b+=this.ToggleControl("Recon",
"RECON");b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+=this.MakeCheckTR("Enable Player Recon","DoPlayerRecon",false,"PlayerReconControl","Enable player battle reconnaissance to run as an idle background task. Battle targets will be collected and can be displayed using the 'Target List' selection on the dashboard.",true);b+="Find battle targets that are:";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+="<tr><td style='padding-left: 10px'>Not Lower Than Rank Minus</td><td style='text-align: right'>"+
this.MakeNumberForm("ReconPlayerRank","Provide the number of ranks below you which recon will use to filter targets. This value will be subtracted from your rank to establish the minimum rank that recon will consider as a viable target. Default 3.","3","size='2' style='font-size: 10px; text-align: right'")+"</td></tr>";b+="<tr><td style='padding-left: 10px'>Not Higher Than Level Plus</td><td style='text-align: right'>"+this.MakeNumberForm("ReconPlayerLevel","Provide the number of levels above you which recon will use to filter targets. This value will be added to your level to establish the maximum level that recon will consider as a viable target. Default 10.",
"10","size='2' style='font-size: 10px; text-align: right'")+"</td></tr>";b+="<tr><td style='padding-left: 10px'>Not Higher Than X*Army</td><td style='text-align: right'>"+this.MakeNumberForm("ReconPlayerARBase","This value sets the base for your army ratio calculation. It is basically a multiplier for the army size of a player at your equal level. For example, a value of .5 means you will battle an opponent the same level as you with an army half the size of your army or less. Default 1.","1","size='2' style='font-size: 10px; text-align: right'")+
"</td></tr></table>";b+="</div>";b+="<hr/></div>";this.BuildGeneralLists();b+=this.ToggleControl("Generals","GENERALS");b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";for(var h in this.standardGeneralList)if(this.standardGeneralList.hasOwnProperty(h))b+="<tr><td>"+this.standardGeneralList[h]+"</td><td style='text-align: right'>"+this.MakeDropDown(this.standardGeneralList[h]+"General",this.generalList,"","style='font-size: 10px; min-width: 110px; max-width: 110px; width: 110px;'")+
"</td></tr>";b+="<tr><td>Buy</td><td style='text-align: right'>"+this.MakeDropDown("BuyGeneral",this.generalBuyList,"","style='font-size: 10px; min-width: 110px; max-width: 110px; width: 110px;'")+"</td></tr>";b+="<tr><td>Income</td><td style='text-align: right'>"+this.MakeDropDown("IncomeGeneral",this.generalIncomeList,"","style='font-size: 10px; min-width: 110px; max-width: 110px; width: 110px;'")+"</td></tr>";b+="<tr><td>Banking</td><td style='text-align: right'>"+this.MakeDropDown("BankingGeneral",
this.generalBankingList,"","style='font-size: 10px; min-width: 110px; max-width: 110px; width: 110px;'")+"</td></tr>";b+="<tr><td>Level Up</td><td style='text-align: right'>"+this.MakeDropDown("LevelUpGeneral",this.generalList,"","style='font-size: 10px; min-width: 110px; max-width: 110px; width: 110px;'")+"</td></tr></table>";b+="<div id='caap_LevelUpGeneralHide' style='display: "+(gm.getValue("LevelUpGeneral",false)!="Use Current"?"block":"none")+"'>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";
b+="<tr><td>Exp To Use LevelUp Gen </td><td style='text-align: right'>"+this.MakeNumberForm("LevelUpGeneralExp","Specify the number of experience points below the next level up to begin using the level up general.",20,"size='2' style='font-size: 10px; text-align: right'")+"</td></tr>";b+=this.MakeCheckTR("Level Up Gen For Idle","IdleLevelUpGeneral",true,"","Use the Level Up General for Idle mode.");b+=this.MakeCheckTR("Level Up Gen For Monsters","MonsterLevelUpGeneral",true,"","Use the Level Up General for Monster mode.");
b+=this.MakeCheckTR("Level Up Gen For Fortify","FortifyLevelUpGeneral",true,"","Use the Level Up General for Fortify mode.");b+=this.MakeCheckTR("Level Up Gen For Battles","BattleLevelUpGeneral",true,"","Use the Level Up General for Battle mode.");b+=this.MakeCheckTR("Level Up Gen For SubQuests","SubQuestLevelUpGeneral",true,"","Use the Level Up General for doing sub-quests.");b+=this.MakeCheckTR("Level Up Gen For MainQuests","QuestLevelUpGeneral",true,"","Use the Level Up General for doing primary quests (Warning: May cause you not to gain influence if wrong general is equipped.)");
b+="</table></div>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+=this.MakeCheckTR("Reverse Under Level 4 Order","ReverseLevelUpGenerals",false,"","This will make the script level Generals under level 4 from Top-down instead of Bottom-up")+"</table>";b+="<hr/></div>";f=["","Energy","Attack","Defense","Stamina","Health"];b+=this.ToggleControl("Status","UPGRADE SKILL POINTS");b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+=this.MakeCheckTR("Auto Add Upgrade Points",
"AutoStat",false,"AutoStat_Adv","Automatically increase attributes when upgrade skill points are available.",true);b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+=this.MakeCheckTR("Upgrade Immediately","StatImmed",false,"","Update Stats Immediately");b+=this.MakeCheckTR("Advanced Settings <a href='http://userscripts.org/posts/207279' target='_blank'><font color='red'>?</font></a>","AutoStatAdv",false,"","USE WITH CAUTION: You can use numbers or formulas(ie. level * 2 + 10). Variable keywords include energy, health, stamina, attack, defense, and level. JS functions can be used (Math.min, Math.max, etc) !!!Remember your math class: 'level + 20' not equals 'level * 2 + 10'!!!")+
"</table>";b+="<div id='caap_Status_Normal' style='display: "+(gm.getValue("AutoStatAdv",false)?"none":"block")+"'>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+="<tr><td style='width: 25%; text-align: right'>Increase</td><td style='width: 50%; text-align: center'>"+this.MakeDropDown("Attribute1",f,"","style='font-size: 10px'")+"</td><td style='width: 5%; text-align: center'>to</td><td style='width: 20%; text-align: right'>"+this.MakeNumberForm("AttrValue1","Automatically increase attributes when upgrade skill points are available.",
0,"type='text' size='3' style='font-size: 10px; text-align: right'")+" </td></tr>";b+="<tr><td style='width: 25%; text-align: right'>Then</td><td style='width: 50%; text-align: center'>"+this.MakeDropDown("Attribute2",f,"","style='font-size: 10px'")+"</td><td style='width: 5%; text-align: center'>to</td><td style='width: 20%; text-align: right'>"+this.MakeNumberForm("AttrValue2","Automatically increase attributes when upgrade skill points are available.",0,"type='text' size='3' style='font-size: 10px; text-align: right'")+
" </td></tr>";b+="<tr><td style='width: 25%; text-align: right'>Then</td><td style='width: 50%; text-align: center'>"+this.MakeDropDown("Attribute3",f,"","style='font-size: 10px'")+"</td><td style='width: 5%; text-align: center'>to</td><td style='width: 20%; text-align: right'>"+this.MakeNumberForm("AttrValue3","Automatically increase attributes when upgrade skill points are available.",0,"type='text' size='3' style='font-size: 10px; text-align: right'")+" </td></tr>";b+="<tr><td style='width: 25%; text-align: right'>Then</td><td style='width: 50%; text-align: center'>"+
this.MakeDropDown("Attribute4",f,"","style='font-size: 10px'")+"</td><td style='width: 5%; text-align: center'>to</td><td style='width: 20%; text-align: right'>"+this.MakeNumberForm("AttrValue4","Automatically increase attributes when upgrade skill points are available.",0,"type='text' size='3' style='font-size: 10px; text-align: right'")+" </td></tr>";b+="<tr><td style='width: 25%; text-align: right'>Then</td><td style='width: 50%; text-align: center'>"+this.MakeDropDown("Attribute5",f,"","style='font-size: 10px'")+
"</td><td style='width: 5%; text-align: center'>to</td><td style='width: 20%; text-align: right'>"+this.MakeNumberForm("AttrValue5","Automatically increase attributes when upgrade skill points are available.",0,"type='text' size='3' style='font-size: 10px; text-align: right'")+" </td></tr></table>";b+="</div>";b+="<div id='caap_Status_Adv' style='display: "+(gm.getValue("AutoStatAdv",false)?"block":"none")+"'>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+="<tr><td style='width: 25%; text-align: right'>Increase</td><td style='width: 50%; text-align: center'>"+
this.MakeDropDown("Attribute1",f,"","style='font-size: 10px'")+"</td><td style='width: 25%; text-align: left'>using</td></tr>";b+="<tr><td colspan='3'>"+this.MakeNumberForm("AttrValue1","Automatically increase attributes when upgrade skill points are available.",0,"type='text' size='7' style='font-size: 10px; width : 98%'")+" </td></tr>";b+="<tr><td style='width: 25%; text-align: right'>Then</td><td style='width: 50%; text-align: center'>"+this.MakeDropDown("Attribute2",f,"","style='font-size: 10px'")+
"</td><td style='width: 25%'>using</td></tr>";b+="<tr><td colspan='3'>"+this.MakeNumberForm("AttrValue2","Automatically increase attributes when upgrade skill points are available.",0,"type='text' size='7' style='font-size: 10px; width : 98%'")+" </td></tr>";b+="<tr><td style='width: 25%; text-align: right'>Then</td><td style='width: 50%; text-align: center'>"+this.MakeDropDown("Attribute3",f,"","style='font-size: 10px'")+"</td><td style='width: 25%'>using</td></tr>";b+="<tr><td colspan='3'>"+this.MakeNumberForm("AttrValue3",
"Automatically increase attributes when upgrade skill points are available.",0,"type='text' size='7' style='font-size: 10px; width : 98%'")+" </td></tr>";b+="<tr><td style='width: 25%; text-align: right'>Then</td><td style='width: 50%; text-align: center'>"+this.MakeDropDown("Attribute4",f,"","style='font-size: 10px'")+"</td><td style='width: 25%'>using</td></tr>";b+="<tr><td colspan='3'>"+this.MakeNumberForm("AttrValue4","Automatically increase attributes when upgrade skill points are available.",
0,"type='text' size='7' style='font-size: 10px; width : 98%'")+" </td></tr>";b+="<tr><td style='width: 25%; text-align: right'>Then</td><td style='width: 50%; text-align: center'>"+this.MakeDropDown("Attribute5",f,"","style='font-size: 10px'")+"</td><td style='width: 25%'>using</td></tr>";b+="<tr><td colspan='3'>"+this.MakeNumberForm("AttrValue5","Automatically increase attributes when upgrade skill points are available.",0,"type='text' size='7' style='font-size: 10px; width : 98%'")+" </td></tr></table>";
b+="</div>";b+="</table></div>";b+="<hr/></div>";b+=this.ToggleControl("Other","OTHER OPTIONS");f=["Same Gift As Received","Random Gift"];f=f.concat(gm.getList("GiftList"));f.push("Get Gift List");b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+=this.MakeCheckTR("Use 24 Hour Format","use24hr",true,"","Use 24 hour format for displayed times.");b+=this.MakeCheckTR("Set Title","SetTitle",false,"SetTitle_Adv","Set the title bar.",true);b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";
b+=this.MakeCheckTR("&nbsp;&nbsp;&nbsp;Display Action","SetTitleAction",false,"","Add the current action.");b+=this.MakeCheckTR("&nbsp;&nbsp;&nbsp;Display Name","SetTitleName",false,"","Add the player name.")+"</td></tr></table>";b+="</div>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+=this.MakeCheckTR("Hide Sidebar Adverts","HideAds",false,"","Hides the sidebar adverts.");b+=this.MakeCheckTR("Auto Collect MA","AutoCollectMA",true,"","Auto collect your Master and Apprentice rewards.");
b+=this.MakeCheckTR("Auto Alchemy","AutoAlchemy",false,"AutoAlchemy_Adv","AutoAlchemy will combine all recipes that do not have missing ingredients. By default, it will not combine Battle Hearts recipes.",true);b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+=this.MakeCheckTR("&nbsp;&nbsp;&nbsp;Do Battle Hearts","AutoAlchemyHearts",false,"","If for some reason you do not want to skip Battle Hearts")+"</td></tr></table>";b+="</div>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";
b+=this.MakeCheckTR("Auto Potions","AutoPotions",false,"AutoPotions_Adv","Enable or disable the auto consumption of energy and stamina potions.",true);b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+="<tr><td style='padding-left: 10px'>Spend Stamina Potions At</td><td style='text-align: right'>"+this.MakeNumberForm("staminaPotionsSpendOver","Number of stamina potions at which to begin consuming.",40,"size='2' style='font-size: 10px; text-align: right'")+"</td></tr>";b+="<tr><td style='padding-left: 10px'>Keep Stamina Potions</td><td style='text-align: right'>"+
this.MakeNumberForm("staminaPotionsKeepUnder","Number of stamina potions to keep.",35,"size='2' style='font-size: 10px; text-align: right'")+"</td></tr>";b+="<tr><td style='padding-left: 10px'>Spend Energy Potions At</td><td style='text-align: right'>"+this.MakeNumberForm("energyPotionsSpendOver","Number of energy potions at which to begin consuming.",40,"size='2' style='font-size: 10px; text-align: right'")+"</td></tr>";b+="<tr><td style='padding-left: 10px'>Keep Energy Potions</td><td style='text-align: right'>"+
this.MakeNumberForm("energyPotionsKeepUnder","Number of energy potions to keep.",35,"size='2' style='font-size: 10px; text-align: right'")+"</td></tr>";b+="<tr><td style='padding-left: 10px'>Wait If Exp. To Level</td><td style='text-align: right'>"+this.MakeNumberForm("potionsExperience","Do not consume potions if the experience points to the next level are within this value.",20,"size='2' style='font-size: 10px; text-align: right'")+"</td></tr></table>";b+="</div>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";
b+=this.MakeCheckTR("Auto Elite Army","AutoElite",true,"AutoEliteControl","Enable or disable Auto Elite function",true);b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+="<tr><td><input type='button' id='caap_resetElite' value='Do Now' style='font-size: 10px; width: 55px'></tr></td>";b+="<tr><td>"+this.MakeTextBox("EliteArmyList","Try these UserIDs first. Use ',' between each UserID"," rows='3' cols='25'")+"</td></tr></table>";b+="</div>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";
b+=this.MakeCheckTR("Auto Return Gifts","AutoGift",false,"GiftControl","Automatically receive and send return gifts.",true);b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+="<tr><td style='width: 25%; padding-left: 10px'>Give</td><td style='text-align: right'>"+this.MakeDropDown("GiftChoice",f,"","style='font-size: 10px; width: 100%'")+"</td></tr></table>";b+="</div>";b+="<table width='180px' cellpadding='0px' cellspacing='0px' style='margin-top: 3px'>";b+="<tr><td style='width: 50%'>Auto bless</td><td style='text-align: right'>"+
this.MakeDropDown("AutoBless",["None","Energy","Attack","Defense","Stamina","Health"],"","style='font-size: 10px; width: 100%'")+"</td></tr></table>";b+="<table width='180px' cellpadding='0px' cellspacing='0px' style='margin-top: 3px'>";b+="<tr><td style='width: 50%'>Style</td><td style='text-align: right'>"+this.MakeDropDown("DisplayStyle",["CA Skin","Original","Custom","None"],"","style='font-size: 10px; width: 100%'")+"</td></tr></table>";b+="<div id='caap_DisplayStyleHide' style='display: "+(gm.getValue("DisplayStyle",
false)=="Custom"?"block":"none")+"'>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+="<tr><td style='padding-left: 10px'><b>Started</b></td><td style='text-align: right'><input type='button' id='StartedColorSelect' value='Select' style='font-size: 10px; width: 55px'></td></tr>";b+="<tr><td style='padding-left: 20px'>RGB Color</td><td style='text-align: right'>"+this.MakeNumberForm("StyleColorStarted","FFF or FFFFFF","#123456","type='text' size='5' style='font-size: 10px; text-align: right'")+
"</td></tr>";b+="<tr><td style='padding-left: 20px'>Transparency</td><td style='text-align: right'>"+this.MakeNumberForm("StyleTransparencyStarted","0 ~ 1","","type='text' size='5' style='font-size: 10px; text-align: right'")+"</td></tr>";b+="<tr><td style='padding-left: 10px'><b>Stoped</b></td><td style='text-align: right'><input type='button' id='StopedColorSelect' value='Select' style='font-size: 10px; width: 55px'></td></tr>";b+="<tr><td style='padding-left: 20px'>RGB Color</td><td style='text-align: right'>"+
this.MakeNumberForm("StyleColorStoped","FFF or FFFFFF","#123456","type='text' size='5' style='font-size: 10px; text-align: right'")+"</td></tr>";b+="<tr><td style='padding-left: 20px'>Transparency</td><td style='text-align: right'>"+this.MakeNumberForm("StyleTransparencyStoped","0 ~ 1","","type='text' size='5' style='font-size: 10px; text-align: right'")+"</td></tr></table>";b+="</div>";b+="<table width='180px' cellpadding='0px' cellspacing='0px' style='margin-top: 3px'>";b+="<tr><td><input type='button' id='caap_FillArmy' value='Fill Army' style='font-size: 10px; width: 55px'></td></tr></table>";
b+="</div>";b+="<hr/></div>";b+="<table width='180px' cellpadding='0px' cellspacing='0px'>";b+="<tr><td style='width: 90%'>Unlock Menu <input type='button' id='caap_ResetMenuLocation' value='Reset' style='font-size: 10px; width: 55px'></td><td style='width: 10%; text-align: right'><input type='checkbox' id='unlockMenu' /></td></tr></table>";b+="Version: "+caapVersion+" - <a href='"+global.discussionURL+"' target='_blank'>CAAP Forum</a><br />";if(global.newVersionAvailable)b+="<a href='http://github.com/Xotic750/Castle-Age-Autoplayer/raw/master/Castle-Age-Autoplayer.user.js'>Install new CAAP version: "+
gm.getValue("SUC_remote_version")+"!</a>";this.SetDivContent("control",b);$("head").append('<style type="text/css">.farbtastic {position: relative;}.farbtastic * {position: absolute;cursor: crosshair;}.farbtastic, .farbtastic .wheel {width: 195px;height: 195px;}.farbtastic .color, .farbtastic .overlay {top: 47px;left: 47px;width: 101px;height: 101px;}.farbtastic .wheel {background: url(http://farbtastic.googlecode.com/svn/branches/farbtastic-1/wheel.png) no-repeat;width: 195px;height: 195px;}.farbtastic .overlay {background: url(http://farbtastic.googlecode.com/svn/branches/farbtastic-1/mask.png) no-repeat;}.farbtastic .marker {width: 17px;height: 17px;margin: -8px 0 0 -8px;overflow: hidden; background: url(http://farbtastic.googlecode.com/svn/branches/farbtastic-1/marker.png) no-repeat;}</style>');
$("<div id='caap_ColorSelectorDiv1'></div>").css({background:gm.getValue("StyleBackgroundLight","white"),padding:"5px",border:"2px solid #000",top:window.innerHeight/2-100+"px",left:window.innerWidth/2-290+"px",zIndex:"1337",position:"fixed",display:"none"}).farbtastic("#caap_StyleColorStarted").appendTo(document.body);$("<div id='caap_ColorSelectorDiv2'></div>").css({background:gm.getValue("StyleBackgroundLight","white"),padding:"5px",border:"2px solid #000",top:window.innerHeight/2-100+"px",left:window.innerWidth/
2+"px",zIndex:"1337",position:"fixed",display:"none"}).farbtastic("#caap_StyleColorStoped").appendTo(document.body);f="<div id='caap_top'>";f+="<div id='caap_buttonMonster' style='position:absolute;top:0px;left:250px;display:"+(gm.getValue("DBDisplay","Monster")=="Monster"?"block":"none")+"'> <input type='button' id='caap_refreshMonsters' value='Refresh Monster List' style='font-size: 9px; width:50; height:50'></div>";f+="<div id='caap_buttonTargets' style='position:absolute;top:0px;left:250px;display:"+
(gm.getValue("DBDisplay","Monster")=="Target List"?"block":"none")+"'> <input type='button' id='caap_clearTargets' value='Clear Targets List' style='font-size: 9px; width:50; height:50'></div>";f+="<div id='caap_buttonFeed' style='position:absolute;top:0px;left:0px;'><input id='caap_liveFeed' type='button' value='LIVE FEED! Your friends are calling.' style='font-size: 9px; width:50; height:50'></div>";f+="<div id='caap_DBDisplay' style='font-size: 9px;position:absolute;top:0px;right:0px;'>Display: "+
this.DBDropDown("DBDisplay",["Monster","Target List"],"","style='font-size: 9px; min-width: 120px; max-width: 120px; width : 120px;'")+"</div>";f+="<div id='caap_infoMonster' style='position:relative;top:15px;width:610px;height:185px;overflow:auto;display:"+(gm.getValue("DBDisplay","Monster")=="Monster"?"block":"none")+"'></div>";f+="<div id='caap_infoTargets1' style='position:relative;top:15px;width:610px;height:185px;overflow:auto;display:"+(gm.getValue("DBDisplay","Monster")=="Target List"?"block":
"none")+"'></div>";f+="<div id='caap_infoTargets2' style='position:relative;top:15px;width:610px;height:185px;overflow:auto;display:"+(gm.getValue("DBDisplay","Monster")=="Target Stats"?"block":"none")+"'></div>";f+="</div>";if(!$("#caap_top").length){this.dashboardXY.x=gm.getValue("caap_top_menuLeft","");this.dashboardXY.y=gm.getValue("caap_top_menuTop",$(this.dashboardXY.selector).offset().top-10);d=this.GetDashboardXY();$(f).css({background:gm.getValue("StyleBackgroundLight","white"),padding:"5px",
height:"185px",width:"610px",margin:"0 auto",opacity:"1",top:d.y+"px",left:d.x+"px",zIndex:gm.getValue("caap_top_zIndex","1"),position:"absolute"}).appendTo(document.body)}}catch(g){gm.log("ERROR in SetControls: "+g)}},makeCommaValue:function(c){c+="";c=c.split(".")[0];for(var b=/(\d+)(\d{3})/;b.test(c);)c=c.replace(b,"$1,$2");return c},makeTd:function(c,b){if(gm.getObjVal(b,"color"))b=gm.getObjVal(b,"color");b||(b="black");return"<td><font size=1 color='"+b+"'>"+c+"</font></td>"},UpdateDashboardWaitLog:true,
UpdateDashboard:function(){try{if($("#caap_top").length===0)throw"We are missing the Dashboard div!";if(!this.oneMinuteUpdate("dashboard")&&$("#caap_infoMonster").html()&&$("#caap_infoMonster").html()){if(this.UpdateDashboardWaitLog){gm.log("Dashboard update is waiting on oneMinuteUpdate");this.UpdateDashboardWaitLog=false}return false}gm.log("Updating Dashboard");this.UpdateDashboardWaitLog=true;var c="<table width=570 cellpadding=0 cellspacing=0 ><tr>",b=["Name","Damage","Damage%","Fort%","TimeLeft",
"T2K","Phase","Link"];for(var d in b)if(b.hasOwnProperty(d))c+="<td><b><font size=1>"+b[d]+"</font></b></td>";c+="</tr>";b.shift();gm.getList("monsterOl").forEach(function(r){var p=r.split(global.vs)[0],q="";c+="<tr>";q=p==gm.getValue("targetFromfortify")&&caap.CheckEnergy(10,gm.getValue("WhenFortify","Energy Available"),"fortify_mess")?"blue":p==gm.getValue("targetFromraid")||p==gm.getValue("targetFrombattle_monster")?"green":gm.getObjVal(r,"color","black");c+=caap.makeTd(p,q);b.forEach(function(s){if(s==
"Phase"&&q=="grey")c+=caap.makeTd(gm.getObjVal(r,"status"),q);else{var o=gm.getObjVal(r,s);if(o&&!(s=="Fort%"&&o==101)){if(parseInt(o,10).toString()==o)o=caap.makeCommaValue(o);c+=caap.makeTd(o+(s.match(/%/)?"%":""),q)}else c+="<td></td>"}});c+="</tr>"});c+="</table>";$("#caap_infoMonster").html(c);c="<table width=570 cellpadding=0 cellspacing=0 ><tr>";d=["UserId","Name","Deity#","Rank","Rank#","Level","Army","Last Alive"];var e=["nameStr","deityNum","rankStr","rankNum","levelNum","armyNum","aliveTime"];
for(var f in d)if(d.hasOwnProperty(f))c+="<td><b><font size=1>"+d[f]+"</font></b></td>";var i=gm.getList("targetsOl");for(var h in i)if(i.hasOwnProperty(h)){var g=i[h],k=g.split(global.vs)[0];c+="<tr>";c+=caap.makeTd("<a href='http://apps.facebook.com/castle_age/keep.php?user="+k+"'>"+k+"</a>","blue");for(var j in e)if(e.hasOwnProperty(j)){var m=gm.getObjVal(g,e[j]);if(m){if(/\S+Num/.test(e[j]))m=caap.makeCommaValue(m);if(/\S+Time/.test(e[j])){var l=new Date(parseInt(m,10));m=l.getMonth()+1+"/"+l.getDate()+
" "+l.getHours()+":"+(l.getMinutes()<10?"0":"")+l.getMinutes()}c+=caap.makeTd(m,"black")}else c+="<td></td>"}c+="</tr>"}c+="</table>";$("#caap_infoTargets1").html(c);return true}catch(n){gm.log("ERROR in UpdateDashboard: "+n);return false}},AddDBListener:function(){try{var c=document.getElementById("caap_DBDisplay");c||this.ReloadCastleAge();c.addEventListener("change",function(d){d=d.target.options[d.target.selectedIndex].value;gm.setValue("DBDisplay",d);switch(d){case "Target List":caap.SetDisplay("infoMonster",
false);caap.SetDisplay("infoTargets1",true);caap.SetDisplay("infoTargets2",false);caap.SetDisplay("buttonMonster",false);caap.SetDisplay("buttonTargets",true);break;case "Target Stats":caap.SetDisplay("infoMonster",false);caap.SetDisplay("infoTargets1",false);caap.SetDisplay("infoTargets2",true);caap.SetDisplay("buttonMonster",false);caap.SetDisplay("buttonTargets",true);break;case "Monster":caap.SetDisplay("infoMonster",true);caap.SetDisplay("infoTargets1",false);caap.SetDisplay("infoTargets2",false);
caap.SetDisplay("buttonMonster",true);caap.SetDisplay("buttonTargets",false);break;default:}gm.setValue("resetdashboard",true)},false);document.getElementById("caap_refreshMonsters").addEventListener("click",function(){gm.setValue("monsterReview",0);gm.setValue("monsterReviewCounter",-3);gm.setValue("NotargetFrombattle_monster",0);gm.setValue("ReleaseControl",true)},false);document.getElementById("caap_liveFeed").addEventListener("click",function(){var d=nHtml.FindByAttrContains(document.body,"img",
"src","button_feed2.gif");d?caap.Click(d):gm.log("Could not find Live Feed button")},false);document.getElementById("caap_clearTargets").addEventListener("click",function(){gm.setValue("targetsOl","");gm.setValue("resetdashboard",true)},false);return true}catch(b){gm.log("ERROR in AddDBListener: "+b);return false}},addExpDisplay:function(){try{var c=$("#app46755028429_st_2_5 strong").text();if(!c)throw"Unable to get text";if(/\(/.test(c))return false;this.stats.exp=this.GetStatusNumbers(c);$("#app46755028429_st_2_5 strong").append(" (<span style='color:red'>"+
this.stats.exp.dif+"</span>)");return true}catch(b){gm.log("ERROR in addExpDisplay: "+b);return false}},SetDisplay:function(c,b){try{b===true?$("#caap_"+c).css("display","block"):$("#caap_"+c).css("display","none");return true}catch(d){gm.log("ERROR in SetDisplay: "+d);return false}},CheckBoxListener:function(c){try{var b=c.target.id.replace(/caap_/i,"");gm.log("Change: setting '"+b+"' to "+c.target.checked);gm.setValue(b,c.target.checked);c.target.className&&caap.SetDisplay(c.target.className,c.target.checked);
switch(b){case "AutoStatAdv":if(c.target.value){caap.SetDisplay("Status_Normal",false);caap.SetDisplay("Status_Adv",true);for(var d=1;d<=5;d+=1)gm.setValue("AttrValue"+d,"")}else{caap.SetDisplay("Status_Normal",true);caap.SetDisplay("Status_Adv",false)}gm.deleteValue("statsMatch");break;case "HideAds":gm.getValue("HideAds")?$(".UIStandardFrame_SidebarAds").css("display","none"):$(".UIStandardFrame_SidebarAds").css("display","block");break;case "IgnoreBattleLoss":if(gm.getValue("IgnoreBattleLoss")){gm.log("Ignore Battle Losses has been enabled.");
gm.setValue("BattlesLostList","");gm.log("Battle Lost List has been cleared.")}break;case "SetTitle":case "SetTitleAction":case "SetTitleName":if(gm.getValue("SetTitle",false)){b="";if(gm.getValue("SetTitleAction",false))if(d=$("#caap_activity_mess").html())b+=d.replace("Activity: ","")+" - ";if(gm.getValue("SetTitleName",false))b+=gm.getValue("PlayerName","CAAP")+" - ";document.title=b+global.documentTitle}else document.title=global.documentTitle;break;case "unlockMenu":if(c.target.checked){$(":input[id^='caap_']").attr({disabled:true});
$("#caap_div").css("cursor","move");$("#caap_div").mousedown(Move.dragHandler);$("#caap_top").css("cursor","move");$("#caap_top").mousedown(Move.dragHandler)}else{$(":input[id^='caap_']").attr({disabled:false});$("#caap_div").css("cursor","");$("#caap_div").unbind("mousedown",Move.dragHandler);$("#caap_top").css("cursor","");$("#caap_top").unbind("mousedown",Move.dragHandler)}break;default:}return true}catch(e){gm.log("ERROR in CheckBoxListener: "+c);return false}},TextBoxListener:function(c){try{var b=
c.target.id.replace(/caap_/i,"");gm.log('Change: setting "'+b+'" to "'+c.target.value+'"');if(/Style*/.test(b)){gm.setValue("StyleBackgroundLight","#"+gm.getValue("StyleColorStarted","FFF"));gm.setValue("StyleOpacityLight",gm.getValue("StyleTransparencyStarted","1"));gm.setValue("StyleBackgroundDark","#"+gm.getValue("StyleColorStoped","FFF"));gm.setValue("StyleOpacityDark",gm.getValue("StyleTransparencyStoped","1"))}else if(/AttrValue?/.test(b))gm.deleteValue("statsMatch");else if(c.target.value===
"")gm.setValue(b,"");else isNaN(c.target.value)?gm.setValue(b,c.target.value):gm.setValue(b,Number(c.target.value));return true}catch(d){gm.log("ERROR in TextBoxListener: "+c);return false}},DropBoxListener:function(c){try{if(c.target.selectedIndex>0){var b=c.target.id.replace(/caap_/i,""),d=c.target.options[c.target.selectedIndex].value,e=c.target.options[c.target.selectedIndex].title;gm.log('Change: setting "'+b+'" to "'+d+'" with title "'+e+'"');gm.setValue(b,d);c.target.title=e;if(b=="WhenQuest"||
b=="WhenBattle"||b=="WhenMonster"||b=="LevelUpGeneral"){caap.SetDisplay(b+"Hide",d!="Never");if(b=="WhenBattle"||b=="WhenMonster"){caap.SetDisplay(b+"XStamina",d=="At X Stamina");caap.SetDisplay("WhenBattleStayHidden1",gm.getValue("WhenBattle",false)=="Stay Hidden"&&gm.getValue("WhenMonster",false)!="Stay Hidden")}b=="WhenBattle"&&caap.SetDisplay("WhenBattleStayHidden2",gm.getValue("WhenBattle",false)=="Stay Hidden"&&gm.getValue("TargetType",false)=="Arena"&&gm.getValue("ArenaHide",false)=="None")}else if(b==
"QuestArea"||b=="QuestSubArea"||b=="WhyQuest"){gm.setValue("AutoQuest","");caap.ClearAutoQuest();if(b=="QuestArea")switch(d){case "Quest":$("#trQuestSubArea").css("display","table-row");caap.ChangeDropDownList("QuestSubArea",caap.landQuestList);break;case "Demi Quests":$("#trQuestSubArea").css("display","table-row");caap.ChangeDropDownList("QuestSubArea",caap.demiQuestList);break;case "Atlantis":$("#trQuestSubArea").css("display","none");caap.ChangeDropDownList("QuestSubArea",[]);gm.deleteValue("QuestSubArea");
break;default:}}else if(b=="IdleGeneral"){gm.setValue("MaxIdleEnergy",0);gm.setValue("MaxIdleStamina",0)}else if(b=="ArenaHide"){caap.SetDisplay("ArenaHSub",d!="None");caap.SetDisplay("WhenBattleStayHidden2",gm.getValue("WhenBattle",false)=="Stay Hidden"&&gm.getValue("TargetType",false)=="Arena"&&gm.getValue("ArenaHide",false)=="None")}else if(b=="TargetType"){caap.SetDisplay("WhenBattleStayHidden2",gm.getValue("WhenBattle",false)=="Stay Hidden"&&gm.getValue("TargetType",false)=="Arena"&&gm.getValue("ArenaHide",
false)=="None");switch(d){case "Freshmeat":caap.SetDisplay("FreshmeatSub",true);caap.SetDisplay("UserIdsSub",false);caap.SetDisplay("RaidSub",false);caap.SetDisplay("ArenaSub",false);break;case "Userid List":caap.SetDisplay("FreshmeatSub",false);caap.SetDisplay("UserIdsSub",true);caap.SetDisplay("RaidSub",false);caap.SetDisplay("ArenaSub",false);break;case "Raid":caap.SetDisplay("FreshmeatSub",true);caap.SetDisplay("UserIdsSub",false);caap.SetDisplay("RaidSub",true);caap.SetDisplay("ArenaSub",false);
break;case "Arena":caap.SetDisplay("FreshmeatSub",true);caap.SetDisplay("UserIdsSub",false);caap.SetDisplay("RaidSub",false);caap.SetDisplay("ArenaSub",true);break;default:caap.SetDisplay("FreshmeatSub",true);caap.SetDisplay("UserIdsSub",false);caap.SetDisplay("RaidSub",false);caap.SetDisplay("ArenaSub",false)}}else if(/Attribute?/.test(b)){gm.setValue("SkillPointsNeed",1);gm.deleteValue("statsMatch")}else if(b=="DisplayStyle"){caap.SetDisplay(b+"Hide",d=="Custom");switch(d){case "CA Skin":gm.setValue("StyleBackgroundLight",
"#E0C691");gm.setValue("StyleBackgroundDark","#B09060");gm.setValue("StyleOpacityLight","1");gm.setValue("StyleOpacityDark","1");break;case "None":gm.setValue("StyleBackgroundLight","white");gm.setValue("StyleBackgroundDark","");gm.setValue("StyleOpacityLight","1");gm.setValue("StyleOpacityDark","1");break;case "Custom":gm.setValue("StyleBackgroundLight","#"+gm.getValue("StyleColorStarted","FFF"));gm.setValue("StyleOpacityLight",gm.getValue("StyleTransparencyStarted","1"));gm.setValue("StyleBackgroundDark",
"#"+gm.getValue("StyleColorStoped","FFF"));gm.setValue("StyleOpacityDark",gm.getValue("StyleTransparencyStoped","1"));break;default:gm.setValue("StyleBackgroundLight","#efe");gm.setValue("StyleBackgroundDark","#fee");gm.setValue("StyleOpacityLight","1");gm.setValue("StyleOpacityDark","1")}var f=nHtml.FindByAttr(document.body,"div","id","caap_top");if(f)f.style.backgroundColor=gm.getValue("StyleBackgroundLight","white")}}return true}catch(i){gm.log("ERROR in DropBoxListener: "+c);return false}},TextAreaListener:function(c){try{var b=
c.target.id.replace(/caap_/i,"");gm.log('Change: setting "'+b+'" to "'+c.target.value+"'");if(b=="orderbattle_monster"||b=="orderraid"){gm.setValue("monsterReview",0);gm.setValue("monsterReviewCounter",-3);gm.setValue("monsterReview",0);gm.setValue("monsterReviewCounter",-3)}caap.SaveBoxText(b);return true}catch(d){gm.log("ERROR in TextAreaListener: "+c);return false}},PauseListener:function(){$("#caap_div").css({background:gm.getValue("StyleBackgroundDark","#fee"),opacity:gm.getValue("StyleOpacityDark",
"1"),"z-index":"3"});$("#caapPaused").css("display","block");global.is_chrome&&CE_message("paused",null,"block");gm.setValue("caapPause","block")},RestartListener:function(){$("#caapPaused").css("display","none");$("#caap_div").css({background:gm.getValue("StyleBackgroundLight","#efe"),opacity:gm.getValue("StyleOpacityLight","1"),"z-index":"1",cursor:""});$(":input[id*='caap_']").attr({disabled:false});$("#unlockMenu").attr("checked",false);gm.setValue("caapPause","none");global.is_chrome&&CE_message("paused",
null,gm.getValue("caapPause","none"));gm.setValue("ReleaseControl",true);gm.setValue("resetselectMonster",true);caap.waitingForDomLoad=false},ResetMenuLocationListener:function(){gm.deleteValue("caap_div_menuLeft");gm.deleteValue("caap_div_menuTop");gm.deleteValue("caap_div_zIndex");caap.controlXY.x="";caap.controlXY.y=$(caap.controlXY.selector).offset().top;var c=caap.GetControlXY(true);$("#caap_div").css({cursor:"","z-index":"2",top:c.y+"px",left:c.x+"px"});gm.deleteValue("caap_top_menuLeft");gm.deleteValue("caap_top_menuTop");
gm.deleteValue("caap_top_zIndex");caap.dashboardXY.x="";caap.dashboardXY.y=$(caap.dashboardXY.selector).offset().top-10;c=caap.GetDashboardXY(true);$("#caap_top").css({cursor:"","z-index":"1",top:c.y+"px",left:c.x+"px"});$(":input[id^='caap_']").attr({disabled:false})},FoldingBlockListener:function(c){try{var b=c.target.id.replace(/_Switch/i,""),d=document.getElementById(b);if(d.style.display=="block"){gm.log("Folding: "+b);d.style.display="none";c.target.innerHTML=c.target.innerHTML.replace(/-/,
"+");gm.setValue("Control_"+b.replace(/caap_/i,""),"none")}else{gm.log("Unfolding: "+b);d.style.display="block";c.target.innerHTML=c.target.innerHTML.replace(/\+/,"-");gm.setValue("Control_"+b.replace(/caap_/i,""),"block")}return true}catch(e){gm.log("ERROR in FoldingBlockListener: "+c);return false}},whatClickedURLListener:function(c){for(c=c.target;c&&!c.href;)c=c.parentNode;c&&c.href&&gm.setValue("clickUrl",c.href)},windowResizeListener:function(){if(window.location.href.indexOf("castle_age")){var c=
caap.GetControlXY();$("#caap_div").css("left",c.x+"px");c=caap.GetDashboardXY();$("#caap_top").css("left",c.x+"px")}},AddListeners:function(){try{gm.log("Adding listeners for caap_div");if(!$("#caap_div"))throw"Unable to find div for caap_div";$('#caap_div input:checkbox[id^="caap_"]').change(this.CheckBoxListener);$('#caap_div input:text[id^="caap_"]').change(this.TextBoxListener);$("#unlockMenu").change(this.CheckBoxListener);$('#caap_div select[id^="caap_"]').change(this.DropBoxListener);$('#caap_div textarea[id^="caap_"]').change(this.TextAreaListener);
$('#caap_div a[id^="caap_Switch"]').click(this.FoldingBlockListener);$("#caap_FillArmy").click(function(){gm.setValue("FillArmy",true)});$("#StartedColorSelect").click(function(){var b="none";if($("#caap_ColorSelectorDiv1").css("display")=="none")b="block";$("#caap_ColorSelectorDiv1").css("display",b)});$("#StopedColorSelect").click(function(){var b="none";if($("#caap_ColorSelectorDiv2").css("display")=="none")b="block";$("#caap_ColorSelectorDiv2").css("display",b)});$("#caap_ResetMenuLocation").click(this.ResetMenuLocationListener);
$("#caap_resetElite").click(function(){gm.setValue("AutoEliteGetList",0)});$("#caapRestart").click(this.RestartListener);$("#caap_control").mousedown(this.PauseListener);global.is_chrome&&$("#caap_control").mousedown(this.PauseListener);$("#stopAutoQuest").click(function(){gm.setValue("AutoQuest","");gm.setValue("WhyQuest","Manual");gm.log("Change: setting stopAutoQuest and go to Manual");caap.ManualAutoQuest()});if(!$("#app46755028429_globalContainer"))throw"Global Container not found";$("#app46755028429_globalContainer").find("a").bind("click",
this.whatClickedURLListener);$("#app46755028429_globalContainer").bind("DOMNodeInserted",function(b){b=$(b.target);if(b.is("#app46755028429_app_body")||b.is("#app46755028429_index")||b.is("#app46755028429_keep")||b.is("#app46755028429_generals")||b.is("#app46755028429_battle_monster")||b.is("#app46755028429_battle")||b.is("#app46755028429_battlerank")||b.is("#app46755028429_battle_train")||b.is("#app46755028429_arena")||b.is("#app46755028429_quests")||b.is("#app46755028429_raid")||b.is("#app46755028429_symbolquests")||
b.is("#app46755028429_alchemy")||b.is("#app46755028429_soldiers")||b.is("#app46755028429_item")||b.is("#app46755028429_land")||b.is("#app46755028429_magic")||b.is("#app46755028429_oracle")||b.is("#app46755028429_symbols")||b.is("#app46755028429_treasure_chest")||b.is("#app46755028429_gift")||b.is("#app46755028429_apprentice")||b.is("#app46755028429_news")||b.is("#app46755028429_friend_page")||b.is("#app46755028429_comments")||b.is("#app46755028429_army")||b.is("#app46755028429_army_news_feed")||b.is("#app46755028429_army_reqs")){caap.waitingForDomLoad=
false;caap.addExpDisplay();$("#app46755028429_globalContainer").find("a").unbind("click",caap.whatClickedURLListener);$("#app46755028429_globalContainer").find("a").bind("click",caap.whatClickedURLListener);caap.node_trigger=window.setTimeout(function(){caap.node_trigger=null;caap.CheckResults()},100)}if(b.is(caap.dashboardXY.selector)){b=caap.GetDashboardXY();$("#caap_top").css("left",b.x+"px")}});$(window).unbind("resize",this.windowResizeListener);$(window).bind("resize",this.windowResizeListener);
this.AddDBListener();return true}catch(c){gm.log("ERROR in AddListeners: "+c);return false}},GetStatusNumbers:function(c){try{if(!c)throw'No "node" supplied';var b=null,d=null,e=null,f=null;if(typeof c!="string"){var i=nHtml.GetText(c);if(!i)throw"No text found";b=this.statusRe.exec(i);if(!b)throw"Cannot find status:"+i;d=parseInt(b[1],10);e=parseInt(b[2],10);f=parseInt(b[2],10)-parseInt(b[1],10)}else{b=c.split("/");if(b.length!==2)throw"String did not split into 2 parts";d=parseInt(b[0],10);e=parseInt(b[1],
10);f=parseInt(b[1],10)-parseInt(b[0],10)}return{num:d,max:e,dif:f}}catch(h){gm.log("ERROR in GetStatusNumbers: "+h);return{num:0,max:0,dif:0}}},GetStats:function(){try{this.stats={};if(!global.is_firefox)if(document.getElementById("app46755028429_healForm")){var c=nHtml.FindByAttrContains(document.body,"a","href","party.php");if(c){var b=this.userRe.exec(c.getAttribute("href"));b&&gm.setValue("FBID",b[2])}}var d=nHtml.FindByAttrContains(document.body,"div","class","keep_stat_title");if(d){var e=
nHtml.GetText(d),f=this.rankRe.exec(e);if(f){var i=this.rankTable[f[1].toString().toLowerCase().trim()];if(i!==undefined){this.stats.rank=i;gm.setValue("MyRank",this.stats.rank);this.JustDidIt("MyRankLast")}else gm.log("Unknown rank "+i+":"+f[1].toString())}var h=this.userNameRe.exec(e);gm.setValue("PlayerName",h[1])}var g=nHtml.FindByAttrContains(document.body,"span","id","_current_health");g||(g=nHtml.FindByAttrXPath(document.body,"span","contains(@id,'_health') and not(contains(@id,'health_time'))"));
this.stats.health=this.GetStatusNumbers(g.parentNode);this.stats.stamina=null;var k=nHtml.FindByAttrContains(document.body,"span","id","_current_stamina");k||(k=nHtml.FindByAttrXPath(document.body,"span","contains(@id,'_stamina') and not(contains(@id,'stamina_time'))"));this.stats.stamina=this.GetStatusNumbers(k.parentNode);var j=nHtml.FindByAttrContains(document.body,"span","id","_current_energy");j||(j=nHtml.FindByAttrXPath(document.body,"span","contains(@id,'_energy') and not(contains(@id,'energy_time'))"));
this.stats.energy=this.GetStatusNumbers(j.parentNode);var m=nHtml.FindByAttrContains(document.body,"div","title","experience points"),l=this.levelRe.exec(nHtml.GetText(m));if(l){this.stats.level=parseInt(l[1],10);gm.getValue("Level",0)!=this.stats.level&&gm.deleteValue("BestLandCost");gm.setValue("Level",this.stats.level)}else gm.log("Could not find level re");this.stats.rank=parseInt(gm.getValue("MyRank"),10);var n=nHtml.FindByAttrContains(document.body,"div","id","main_bntp"),r=nHtml.FindByAttrContains(n,
"a","href","army"),p=nHtml.GetText(r),q=this.armyRe.exec(p);if(q){var s=parseInt(q[1],10);s=Math.min(s,501);this.stats.army=s}else gm.log("Can't find armyRe in "+p);var o=nHtml.FindByAttrXPath(document.body,"strong","contains(string(),'$')");this.stats.cash=this.NumberOnly(nHtml.GetText(o));this.stats.exp=this.GetStatusNumbers(nHtml.FindByAttrContains(document.body,"div","id","st_2_5"));if(this.stats.exp){var t=parseFloat(gm.getObjVal("AutoQuest","expRatio"))||1.4,v=(this.stats.exp.dif-this.stats.stamina.num*
2.4-this.stats.energy.num*t)/(2.4+t)/12*60;this.stats.levelTime=new Date;var u=this.stats.levelTime.getMinutes();u+=v;this.stats.levelTime.setMinutes(u);this.SetDivContent("level_mess","Expected next level: "+this.FormatTime(this.stats.levelTime))}if(this.DisplayTimer("DemiPointTimer"))this.CheckTimer("DemiPointTimer")?this.SetDivContent("demipoint_mess","Battle demipoints cleared"):this.SetDivContent("demipoint_mess","Next Battle DemiPts: "+this.DisplayTimer("DemiPointTimer"));if(this.DisplayTimer("BlessingTimer"))this.CheckTimer("BlessingTimer")?
this.SetDivContent("demibless_mess","Demi Blessing = none"):this.SetDivContent("demibless_mess","Next Demi Blessing: "+this.DisplayTimer("BlessingTimer"));if(this.DisplayTimer("ArenaRankTimer"))this.CheckTimer("ArenaRankTimer")?this.SetDivContent("arena_mess",""):this.SetDivContent("arena_mess","Next Arena Rank Check: "+this.DisplayTimer("ArenaRankTimer"));var w=nHtml.FindByAttrContains(document.body,"span","id","_gold_time_value");if(w){this.stats.paytime=nHtml.GetText(w).trim();this.stats.payminute=
this.stats.paytime.substr(0,this.stats.paytime.indexOf(":"))}return o&&g!==null}catch(y){gm.log("ERROR GetStats: "+y);return false}},SetCheckResultsFunction:function(c){this.JustDidIt("SetResultsFunctionTimer");gm.setValue("ResultsFunction",c)},pageList:{battle_monster:{signaturePic:"tab_monster_on.jpg",CheckResultsFunction:"CheckResults_fightList",subpages:["onMonster"]},onMonster:{signaturePic:"tab_monster_active.jpg",CheckResultsFunction:"CheckResults_viewFight"},raid:{signaturePic:"tab_raid_on.gif",
CheckResultsFunction:"CheckResults_fightList",subpages:["onRaid"]},onRaid:{signaturePic:"raid_back.jpg",CheckResultsFunction:"CheckResults_viewFight"},arena:{signaturePic:"tab_arena_on.gif",CheckResultsFunction:"CheckBattleResults"},land:{signaturePic:"tab_land_on.gif",CheckResultsFunction:"CheckResults_land"},generals:{signaturePic:"tab_generals_on.gif",CheckResultsFunction:"CheckResults_generals"},quests:{signaturePic:"tab_quest_on.gif",CheckResultsFunction:"CheckResults_quests"},symbolquests:{signaturePic:"demi_quest_on.gif",
CheckResultsFunction:"CheckResults_quests"},monster_quests:{signaturePic:"tab_atlantis_on.gif",CheckResultsFunction:"CheckResults_quests"},army:{signaturePic:"invite_on.gif",CheckResultsFunction:"CheckResults_army"},gift:{signaturePic:"invite_on.gif",CheckResultsFunction:"CheckResults_army"}},trackPerformance:false,performanceTimer:function(c){if(caap.trackPerformance){var b=(new Date).getTime(),d=b-parseInt(gm.getValue("performanceTimer",0),10);gm.log("Performance Timer At "+c+" Time elapsed: "+
d);gm.setValue("performanceTimer",b.toString())}},CheckResults:function(){if(this.WhileSinceDidIt("CheckResultsTimer",1)){this.performanceTimer("Start CheckResults");this.JustDidIt("CheckResultsTimer");gm.setValue("page","");var c=gm.getValue("clickUrl"),b="None";if(c.match(/\/[^\/]+.php/i))b=c.match(/\/[^\/]+.php/i)[0].replace("/","").replace(".php","");if(this.pageList[b]){if(this.CheckForImage(caap.pageList[b].signaturePic))b=gm.setValue("page",b);this.pageList[b].subpages&&this.pageList[b].subpages.forEach(function(e){if(caap.CheckForImage(caap.pageList[e].signaturePic))b=
gm.setValue("page",e)})}var d=nHtml.FindByAttrContains(document.body,"span","class","result_body");c="";if(d)c=nHtml.GetText(d).trim();if(gm.getValue("page")){gm.log("Checking results for "+b);typeof caap[caap.pageList[b].CheckResultsFunction]=="function"?this[this.pageList[b].CheckResultsFunction](c):gm.log("Check Results function not found: "+this[this.pageList[b].CheckResultsFunction])}else gm.log("No results check defined for "+b);this.performanceTimer("Before selectMonster");this.selectMonster();
this.performanceTimer("Done selectMonster");this.UpdateDashboard();this.performanceTimer("Done Dashboard");if(!gm.getValue("HaveGift"))if(nHtml.FindByAttrContains(document.body,"a","href","reqs.php#confirm_")){gm.log("We have a gift waiting!");gm.setValue("HaveGift",true)}else if(d=nHtml.FindByAttrContains(document.body,"div","class","UIBeep_Title")){d=nHtml.GetText(d).trim();if(d.match(/sent you a gift/)&&!d.match(/notification/)){gm.log("We have a gift waiting");gm.setValue("HaveGift",true)}}this.stats.level||
this.GetStats();this.battlePage=this.stats.level<10?"battle_train,battle_off":"battle";this.CheckForImage("elite_guard_add")&&gm.getValue("AutoEliteEnd","NoArmy")!="NoArmy"&&gm.setValue("AutoEliteGetList",0);if(d=nHtml.FindByAttrContains(document.body,"div","class","statsTB"))if(d=nHtml.FindByAttrContains(d,"b","class","money")){d=this.NumberOnly(d.firstChild.data);d>=0&&gm.log("Keep: Checked the gold in store: "+gm.setValue("inStore",d+""))}(d=gm.getValue("ResultsFunction",""))&&!this.WhileSinceDidIt("SetResultsFunctionTimer",
20)&&this[d](c);this.performanceTimer("Done CheckResults")}},MaxEnergyQuest:function(){if(!gm.getValue("MaxIdleEnergy",0)){gm.log("Changing to idle general to get Max energy");return this.PassiveGeneral()}if(this.stats.energy.num>=gm.getValue("MaxIdleEnergy"))return this.Quests();return false},baseQuestTable:{"Land of Fire":"land_fire","Land of Earth":"land_earth","Land of Mist":"land_mist","Land of Water":"land_water","Demon Realm":"land_demon_realm","Undead Realm":"land_undead_realm",Underworld:"tab_underworld"},
demiQuestTable:{Ambrosia:"energy",Malekus:"attack",Corvintheus:"defense",Aurora:"health",Azeron:"stamina"},Quests:function(){if(gm.getValue("storeRetrieve","")!=="")if(gm.getValue("storeRetrieve")=="general"){if(this.SelectGeneral("BuyGeneral"))return true;gm.setValue("storeRetrieve","");return true}else return this.RetrieveFromBank(gm.getValue("storeRetrieve",""));this.SetDivContent("quest_mess","");if(gm.getValue("WhenQuest","")=="Never"){this.SetDivContent("quest_mess","Questing off");return false}if(gm.getValue("WhenQuest",
"")=="Not Fortifying"){var c=gm.getNumber("MaxHealthtoQuest",0);if(!c){this.SetDivContent("quest_mess","<b>No valid over fortify %</b>");return false}var b=gm.getValue("targetFromfortify","");if(b){this.SetDivContent("quest_mess","No questing until attack target "+b+" health exceeds "+gm.getNumber("MaxToFortify",0)+"%");return false}b=gm.getValue("targetFrombattle_monster","");if(!b){var d=gm.getListObjVal("monsterOl",b,"ShipHealth");if(!d)if(d<c){this.SetDivContent("quest_mess","No questing until fortify target "+
b+" health exceeds "+c+"%");return false}}}if(gm.getObjVal("AutoQuest","name")){if(!this.CheckEnergy(gm.getObjVal("AutoQuest","energy"),gm.getValue("WhenQuest","Never"),"quest_mess"))return false}else{if(gm.getValue("WhyQuest","")=="Manual"){this.SetDivContent("quest_mess","Pick quest manually.");return false}this.SetDivContent("quest_mess","Searching for quest.");gm.log("Searching for quest")}if(gm.getObjVal("AutoQuest","general")=="none"||gm.getValue("ForceSubGeneral"))if(this.SelectGeneral("SubQuestGeneral"))return true;
if(gm.getValue("LevelUpGeneral","Use Current")!="Use Current"&&gm.getValue("QuestLevelUpGeneral",false)&&this.stats.exp.dif&&this.stats.exp.dif<=gm.getValue("LevelUpGeneralExp",0)){if(this.SelectGeneral("LevelUpGeneral"))return true;gm.log("Using level up general")}switch(gm.getValue("QuestArea","Quest")){case "Quest":c=this.baseQuestTable[gm.getValue("QuestSubArea","Land of Fire")];b=false;if(b=c=="tab_underworld"?this.NavigateTo("quests,jobs_tab_more.gif,"+c+"_small.gif",c+"_big"):c=="land_demon_realm"||
c=="land_undead_realm"?this.NavigateTo("quests,jobs_tab_more.gif,"+c+".gif",c+"_sel"):this.NavigateTo("quests,jobs_tab_back.gif,"+c+".gif",c+"_sel"))return true;break;case "Demi Quests":if(this.NavigateTo("quests,symbolquests","demi_quest_on.gif"))return true;c=gm.getValue("QuestSubArea","Ambrosia");if(nHtml.FindByAttrContains(document.body,"img","src","deity_"+this.demiQuestTable[c]).style.height!="160px")return this.NavigateTo("deity_"+this.demiQuestTable[c]);break;case "Atlantis":if(!this.CheckForImage("tab_atlantis_on.gif"))return this.NavigateTo("quests,monster_quests");
break;default:break}if((c=this.CheckForImage("quick_switch_button.gif"))&&!gm.getValue("ForceSubGeneral",false))if(gm.getValue("LevelUpGeneral","Use Current")!="Use Current"&&gm.getValue("QuestLevelUpGeneral",false)&&this.stats.exp.dif&&this.stats.exp.dif<=gm.getValue("LevelUpGeneralExp",0)){if(this.SelectGeneral("LevelUpGeneral"))return true;gm.log("Using level up general")}else{gm.log("Clicking on quick switch general button.");this.Click(c);return true}b="";if(c=nHtml.FindByAttrContains(document.body,
"form","id","itemBuy")){gm.setValue("storeRetrieve","general");if(this.SelectGeneral("BuyGeneral"))return true;gm.setValue("storeRetrieve","");b=c.textContent.replace(/.*\$/,"").replace(/[^0-9]{3,}.*/,"");gm.log("costToBuy = "+b);if(this.stats.cash<b)if(this.stats.cash+(gm.getNumber("inStore",0)-gm.getNumber("minInStore",0))>=b){gm.log("Trying to retrieve: "+(b-this.stats.cash));gm.setValue("storeRetrieve",b-this.stats.cash);return this.RetrieveFromBank(b-this.stats.cash)}else{gm.setValue("AutoQuest",
"");gm.setValue("WhyQuest","Manual");gm.log("Cant buy requires, stopping quest");this.ManualAutoQuest();return false}if(c=this.CheckForImage("quick_buy_button.jpg")){gm.log("Clicking on quick buy button.");this.Click(c);return true}gm.log("Cant find buy button");return false}if(c=this.CheckForImage("quick_buy_button.jpg")){gm.setValue("storeRetrieve","general");if(this.SelectGeneral("BuyGeneral"))return true;gm.setValue("storeRetrieve","");b=c.previousElementSibling.previousElementSibling.previousElementSibling.previousElementSibling.previousElementSibling.previousElementSibling.previousElementSibling.firstChild.data.replace(/[^0-9]/g,
"");gm.log("costToBuy = "+b);if(this.stats.cash<b)if(this.stats.cash+(gm.getNumber("inStore",0)-gm.getNumber("minInStore",0))>=b){gm.log("Trying to retrieve: "+(b-this.stats.cash));gm.setValue("storeRetrieve",b-this.stats.cash);return this.RetrieveFromBank(b-this.stats.cash)}else{gm.setValue("AutoQuest","");gm.setValue("WhyQuest","Manual");gm.log("Cant buy General, stopping quest");this.ManualAutoQuest();return false}gm.log("Clicking on quick buy general button.");this.Click(c);return true}c=this.CheckResults_quests(true);
if(!gm.getObjVal("AutoQuest","name")){gm.log("Could not find autoquest.");this.SetDivContent("quest_mess","Could not find autoquest.");return false}b=gm.getObjVal("AutoQuest","name");if(gm.getObjVal("AutoQuest","name")!=b){gm.log("New AutoQuest found.");this.SetDivContent("quest_mess","New AutoQuest found.");return true}if(d=nHtml.FindByAttrContains(c.tr,"div","style","background-color"))if(d.style.backgroundColor=="rgb(158, 11, 15)"){gm.log(" background.style.backgroundColor = "+d.style.backgroundColor);
gm.setValue("storeRetrieve","general");if(this.SelectGeneral("BuyGeneral"))return true;gm.setValue("storeRetrieve","");if(d.firstChild.firstChild.title){gm.log("Clicking to buy "+d.firstChild.firstChild.title);this.Click(d.firstChild.firstChild);return true}}d=gm.getObjVal("AutoQuest","general");if(d=="none"||gm.getValue("ForceSubGeneral",false)){if(this.SelectGeneral("SubQuestGeneral"))return true}else if(d&&d!=this.GetCurrentGeneral())if(gm.getValue("LevelUpGeneral","Use Current")!="Use Current"&&
gm.getValue("QuestLevelUpGeneral",false)&&this.stats.exp.dif&&this.stats.exp.dif<=gm.getValue("LevelUpGeneralExp",0)){if(this.SelectGeneral("LevelUpGeneral"))return true;gm.log("Using level up general")}else{gm.log("Clicking on general "+d);this.Click(c.genDiv);return true}gm.log("Clicking auto quest: "+b);gm.setValue("ReleaseControl",true);caap.Click(c.click,1E4);this.ShowAutoQuest();return true},questName:null,CheckResults_quests:function(c){var b=gm.getValue("WhyQuest","");c===true&&b!="Manual"&&
gm.setValue("AutoQuest","");var d=0,e=0,f=document.body,i=null,h=0;if(this.CheckForImage("demi_quest_on.gif")){i=document.evaluate(".//div[contains(@id,'symbol_displaysymbolquest')]",f,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);i.snapshotLength<=0&&gm.log("Failed to find symbol_displaysymbolquest");for(h=0;h<i.snapshotLength;h+=1){f=i.snapshotItem(h);if(f.style.display!="none")break}}i=document.evaluate(".//div[contains(@class,'quests_background')]",f,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,
null);if(i.snapshotLength<=0)gm.log("Failed to find quests_background");else{var g=["Heart of Fire","Gift of Earth","Eye of the Storm","A Look into the Darkness","The Rift","Undead Embrace","Confrontation"],k=false;if(nHtml.FindByAttrContains(f,"input","src","alchemy_summon")){k=true;g.indexOf(gm.getObjVal("AutoQuest","name"))>=0&&gm.getValue("GetOrbs",false)&&b!="Manual"&&gm.setValue("AutoQuest","")}var j={};for(h=0;h<i.snapshotLength;h+=1){f=i.snapshotItem(h);if(this.questName=this.GetQuestName(f)){var m=
null,l=null,n=null,r=nHtml.GetText(f),p=this.experienceRe.exec(r);if(p)n=this.NumberOnly(p[1]);else if(p=nHtml.FindByAttr(f,"div","className","quest_experience"))n=this.NumberOnly(nHtml.GetText(p));else gm.log("cannot find experience:"+this.questName);p=this.questName.indexOf("<br>");if(p>=0)this.questName=this.questName.substring(0,p);if(p=this.energyRe.exec(r))l=this.NumberOnly(p[1]);else if(p=nHtml.FindByAttrContains(f,"div","className","quest_req"))l=p.getElementsByTagName("b")[0];if(l){if(p=
this.moneyRe.exec(this.RemoveHtmlJunk(r))){m=this.NumberOnly(p[1]);p=this.NumberOnly(p[2]);m=(m+p)/2}else gm.log("no money found:"+this.questName+" in "+r);if(p=nHtml.FindByAttr(f,"input","name",/^Do/)){var q=null;if(g.indexOf(this.questName)>=0)q=nHtml.FindByClassName(document.body,"div","quests_background_sub")?"100":"0";else{var s=this.influenceRe.exec(r);if(s)q=s[1];else gm.log("Influence div not found.")}q||gm.log("no influence found:"+this.questName+" in "+r);r="none";s=null;if(q&&q<100)if(s=
nHtml.FindByAttrContains(f,"div","className","quest_act_gen"))if(s=nHtml.FindByAttrContains(s,"img","src","jpg"))r=s.title;var o="subquest";if(f.className=="quests_background")o="primary";else if(f.className=="quests_background_special")o="boss";h===0&&gm.log("Adding Quest Labels and Listeners");this.LabelQuests(f,l,m,n,p);if(this.CheckCurrentQuestArea(gm.getValue("QuestSubArea","Atlantis"))){if(gm.getValue("GetOrbs",false)&&o=="boss"&&b!="Manual")if(!k){gm.setObjVal("AutoQuest","name",this.questName);
c=true}switch(b){case "Advancement":if(q){if(!gm.getObjVal("AutoQuest","name")&&o=="primary"&&this.NumberOnly(q)<100){gm.setObjVal("AutoQuest","name",this.questName);c=true}}else gm.log("cannot find influence:"+this.questName+": "+q);break;case "Max Influence":if(q){if(!gm.getObjVal("AutoQuest","name")&&this.NumberOnly(q)<100){gm.setObjVal("AutoQuest","name",this.questName);c=true}}else gm.log("cannot find influence:"+this.questName+": "+q);break;case "Max Experience":e=Math.floor(n/l*100)/100;if(d<
e){gm.setObjVal("AutoQuest","name",this.questName);c=true}break;case "Max Gold":e=Math.floor(m/l*10)/10;if(d<e){gm.setObjVal("AutoQuest","name",this.questName);c=true}break;default:}if(gm.getObjVal("AutoQuest","name")==this.questName){d=e;j=n/l;gm.log("CheckResults_quests: Setting AutoQuest");gm.setValue("AutoQuest","name"+global.ls+this.questName+global.vs+"energy"+global.ls+l+global.vs+"general"+global.ls+r+global.vs+"expRatio"+global.ls+j);this.ShowAutoQuest();j={click:p,tr:f,genDiv:s}}}}else gm.log("no button found:"+
this.questName)}else gm.log("cannot find energy for quest:"+this.questName)}}if(c){if(gm.getObjVal("AutoQuest","name")){this.ShowAutoQuest();return j}if((b=="Max Influence"||b=="Advancement")&&gm.getValue("swithQuestArea",false)){switch(gm.getValue("QuestSubArea")){case "Land of Fire":gm.setValue("QuestSubArea","Land of Earth");break;case "Land of Earth":gm.setValue("QuestSubArea","Land of Mist");break;case "Land of Mist":gm.setValue("QuestSubArea","Land of Water");break;case "Land of Water":gm.setValue("QuestSubArea",
"Demon Realm");break;case "Demon Realm":gm.setValue("QuestSubArea","Undead Realm");break;case "Undead Realm":gm.setValue("QuestSubArea","Underworld");break;case "Underworld":gm.setValue("QuestArea","Demi Quests");gm.setValue("QuestSubArea","Ambrosia");break;case "Ambrosia":gm.setValue("QuestSubArea","Malekus");break;case "Malekus":gm.setValue("QuestSubArea","Corvintheus");break;case "Corvintheus":gm.setValue("QuestSubArea","Aurora");break;case "Aurora":gm.setValue("QuestSubArea","Azeron");break;case "Azeron":gm.setValue("QuestArea",
"Quest");gm.setValue("QuestSubArea","Land of Fire");break;default:gm.log("CheckResults_quests(default): Set quest to manual");gm.setValue("AutoQuest","");gm.setValue("WhyQuest","Manual");this.ManualAutoQuest();return false}gm.log("CheckResults_quests: Update GUI Quest areas");this.SelectDropOption("QuestArea",gm.getValue("QuestArea"));this.SelectDropOption("QuestSubArea",gm.getValue("QuestSubArea"));return false}gm.log("CheckResults_quests(fall through): Set quest to manual");gm.setValue("AutoQuest",
"");gm.setValue("WhyQuest","Manual");this.ManualAutoQuest()}}},CheckCurrentQuestArea:function(c){switch(c){case "Land of Fire":if(nHtml.FindByAttrContains(document.body,"div","class","quests_stage_1"))return true;break;case "Land of Earth":if(nHtml.FindByAttrContains(document.body,"div","class","quests_stage_2"))return true;break;case "Land of Mist":if(nHtml.FindByAttrContains(document.body,"div","class","quests_stage_3"))return true;break;case "Land of Water":if(nHtml.FindByAttrContains(document.body,
"div","class","quests_stage_4"))return true;break;case "Demon Realm":if(nHtml.FindByAttrContains(document.body,"div","class","quests_stage_5"))return true;break;case "Undead Realm":if(nHtml.FindByAttrContains(document.body,"div","class","quests_stage_6"))return true;break;case "Underworld":if(nHtml.FindByAttrContains(document.body,"div","class","quests_stage_7"))return true;break;case "Ambrosia":if(nHtml.FindByAttrContains(document.body,"div","class","symbolquests_stage_1"))return true;break;case "Malekus":if(nHtml.FindByAttrContains(document.body,
"div","class","symbolquests_stage_2"))return true;break;case "Corvintheus":if(nHtml.FindByAttrContains(document.body,"div","class","symbolquests_stage_3"))return true;break;case "Aurora":if(nHtml.FindByAttrContains(document.body,"div","class","symbolquests_stage_4"))return true;break;case "Azeron":if(nHtml.FindByAttrContains(document.body,"div","class","symbolquests_stage_5"))return true;break;case "Atlantis":if(this.CheckForImage("tab_atlantis_on.gif"))return true;break;default:gm.log("Error: cant find QuestSubArea: "+
c);return false}return false},GetQuestName:function(c){c=nHtml.FindByAttrXPath(c,"div","@class='quest_desc' or @class='quest_sub_title'");if(!c){gm.log("Can't find quest description or sub-title");return false}if(c.innerHTML.toString().match(/LOCK/))return false;var b=c.getElementsByTagName("b")[0];if(!b){gm.log("Can't get bolded member out of "+c.innerHTML.toString());return false}this.questName=b.innerHTML.toString().trim().stripHTML();if(!this.questName){gm.log("no quest name for this row");return false}return this.questName},
CheckEnergy:function(c,b,d){if(!this.stats.energy||!c)return false;if(b=="Energy Available"||b=="Not Fortifying"){if(this.stats.energy.num>=c)return true;if(d)this.SetDivContent(d,"Waiting for more energy: "+this.stats.energy.num+"/"+(c?c:""));return false}else if(b=="At Max Energy"){if(!gm.getValue("MaxIdleEnergy",0)){gm.log("Changing to idle general to get Max energy");this.PassiveGeneral()}if(this.stats.energy.num>=gm.getValue("MaxIdleEnergy"))return true;if(this.InLevelUpMode()&&this.stats.energy.num>=
c){d&&this.SetDivContent(d,"Burning all energy to level up");return true}d&&this.SetDivContent(d,"Waiting for max energy:"+this.stats.energy.num+"/"+gm.getValue("MaxIdleEnergy"));return false}return false},AddLabelListener:function(c,b,d,e){try{c.addEventListener(b,this[d],e);return true}catch(f){gm.log("ERROR in AddLabelListener: "+f);return false}},LabelListener:function(c){try{var b=c.target.getElementsByTagName("span");if(b.length<=0)throw"what did we click on?";gm.setValue("AutoQuest","name"+
global.ls+b[0].innerHTML.toString()+global.vs+"energy"+global.ls+b[1].innerHTML.toString());gm.setValue("WhyQuest","Manual");caap.ManualAutoQuest();if(caap.CheckForImage("tab_quest_on.gif")){gm.setValue("QuestArea","Quest");caap.SelectDropOption("QuestArea","Quest");caap.ChangeDropDownList("QuestSubArea",caap.landQuestList);if(nHtml.FindByAttrContains(document.body,"div","class","quests_stage_1"))gm.setValue("QuestSubArea","Land of Fire");else if(nHtml.FindByAttrContains(document.body,"div","class",
"quests_stage_2"))gm.setValue("QuestSubArea","Land of Earth");else if(nHtml.FindByAttrContains(document.body,"div","class","quests_stage_3"))gm.setValue("QuestSubArea","Land of Mist");else if(nHtml.FindByAttrContains(document.body,"div","class","quests_stage_4"))gm.setValue("QuestSubArea","Land of Water");else if(nHtml.FindByAttrContains(document.body,"div","class","quests_stage_5"))gm.setValue("QuestSubArea","Demon Realm");else if(nHtml.FindByAttrContains(document.body,"div","class","quests_stage_6"))gm.setValue("QuestSubArea",
"Undead Realm");else nHtml.FindByAttrContains(document.body,"div","class","quests_stage_7")&&gm.setValue("QuestSubArea","Underworld");gm.log("Seting SubQuest Area to: "+gm.getValue("QuestSubArea"));caap.SelectDropOption("QuestSubArea",gm.getValue("QuestSubArea"))}else if(caap.CheckForImage("demi_quest_on.gif")){gm.setValue("QuestArea","Demi Quests");caap.SelectDropOption("QuestArea","Demi Quests");caap.ChangeDropDownList("QuestSubArea",caap.demiQuestList);if(nHtml.FindByAttrContains(document.body,
"div","class","symbolquests_stage_1"))gm.setValue("QuestSubArea","Ambrosia");else if(nHtml.FindByAttrContains(document.body,"div","class","symbolquests_stage_2"))gm.setValue("QuestSubArea","Malekus");else if(nHtml.FindByAttrContains(document.body,"div","class","symbolquests_stage_3"))gm.setValue("QuestSubArea","Corvintheus");else if(nHtml.FindByAttrContains(document.body,"div","class","symbolquests_stage_4"))gm.setValue("QuestSubArea","Aurora");else nHtml.FindByAttrContains(document.body,"div","class",
"symbolquests_stage_5")&&gm.setValue("QuestSubArea","Azeron");gm.log("Seting SubQuest Area to: "+gm.getValue("QuestSubArea"));caap.SelectDropOption("QuestSubArea",gm.getValue("QuestSubArea"))}else if(caap.CheckForImage("tab_atlantis_on.gif")){gm.log("Seting Quest Area to Atlantis");gm.setValue("QuestArea","Atlantis");gm.deleteValue("QuestSubArea");caap.SelectDropOption("QuestArea","Atlantis");caap.ChangeDropDownList("QuestSubArea",caap.landQuestList)}caap.ShowAutoQuest();return true}catch(d){gm.log("ERROR in LabelListener: "+
d);return false}},LabelQuests:function(c,b,d,e,f){if(!nHtml.FindByAttr(c,"div","className","autoquest")){c=document.createElement("div");c.className="autoquest";c.style.fontSize="10px";c.innerHTML="$ per energy: "+Math.floor(d/b*10)/10+"<br />Exp per energy: "+Math.floor(e/b*100)/100+"<br />";if(gm.getObjVal("AutoQuest","name")==this.questName){b=document.createElement("b");b.innerHTML="Current auto quest";c.appendChild(b)}else{d=document.createElement("a");d.innerHTML="Auto run this quest.";d.quest_name=
this.questName;e=document.createElement("span");e.innerHTML=this.questName;e.style.display="none";d.appendChild(e);e=document.createElement("span");e.innerHTML=b;e.style.display="none";d.appendChild(e);this.AddLabelListener(d,"click","LabelListener",false);c.appendChild(d)}c.style.position="absolute";c.style.background="#B09060";c.style.right="144px";f.parentNode.insertBefore(c,f)}},deityTable:{energy:1,attack:2,defense:3,health:4,stamina:5},BlessingResults:function(c){if(c.match(/Please come back in: /)){var b=
parseInt(c.match(/ \d+ hour/),10),d=parseInt(c.match(/ \d+ minute/),10);this.SetTimer("BlessingTimer",(b*60+d+1)*60);gm.log("Recorded Blessing Time.  Scheduling next click!")}if(c.match(/You have paid tribute to/)){this.SetTimer("BlessingTimer",86460);gm.log("Received blessing.  Scheduling next click!")}this.SetCheckResultsFunction("")},AutoBless:function(){var c=gm.getValue("AutoBless","none").toLowerCase();if(c=="none")return false;if(!this.CheckTimer("BlessingTimer"))return false;if(this.NavigateTo("quests,demi_quest_off",
"demi_quest_bless"))return true;var b=nHtml.FindByAttrContains(document.body,"img","src","deity_"+c);if(!b){gm.log("No diety pics for deity_"+c);return false}if(b.style.height!="160px")return this.NavigateTo("deity_"+c);b=nHtml.FindByAttrContains(document.body,"form","id","_symbols_form_"+this.deityTable[c]);if(!b){gm.log("No form for deity blessing.");return false}b=this.CheckForImage("demi_quest_bless",b);if(!b){gm.log("No image for deity blessing.");return false}gm.log("Click deity blessing for "+
c);this.SetTimer("BlessingTimer",3600);this.SetCheckResultsFunction("BlessingResults");caap.Click(b);return true},LandsGetNameFromRow:function(c){(c=nHtml.FindByAttrXPath(c,"div","contains(@class,'land_buy_info') or contains(@class,'item_title')"))||gm.log("can't find land_buy_info");if(c.className.indexOf("item_title")>=0)return c.textContent.trim();c=c.getElementsByTagName("strong");if(c.length<1)return null;return c[0].textContent.trim()},bestLand:{land:"",roi:0},CheckResults_land:function(){if(nHtml.FindByAttrXPath(document,
"div","contains(@class,'caap_landDone')"))return null;gm.deleteValue("BestLandCost");this.sellLand="";this.bestLand.roi=0;this.IterateLands(function(b){this.SelectLands(b.row,2);var d=parseInt(b.income/b.totalCost*24E4,10)/100;b.row.getElementsByTagName("select");var e=null;if(!nHtml.FindByAttrXPath(b.row,"input","@name='Buy'")){d=0;e=nHtml.FindByAttrXPath(b.row,"div","contains(@class,'land_buy_info') or contains(@class,'item_title')");var f=nHtml.GetText(e).match(/:\s+\d+/i).toString().trim();f=
Number(f.replace(/:\s+/,""));e=nHtml.FindByAttrXPath(b.row,"div","contains(@class,'land_buy_costs')");e=nHtml.GetText(e).match(/:\s+\d+/i).toString().trim();e=Number(e.replace(/:\s+/,""));for(var i=[1,5,10],h=2;h>=0;h-=1)if(e-f>=i[h]){this.sellLand=b;this.sellLand.selection=h;break}}e=nHtml.FindByAttrXPath(b.row,"div","contains(@class,'land_buy_info') or contains(@class,'item_title')").getElementsByTagName("strong");e[0].innerHTML+=" | "+d+"% per day.";if(!b.usedByOther)if(!(this.bestLand.roi||d===
0)||d>this.bestLand.roi){this.bestLand.roi=d;this.bestLand.land=b;gm.setValue("BestLandCost",this.bestLand.land.cost)}});var c=gm.getValue("BestLandCost","");gm.log("BestLandCost: "+c);c||gm.setValue("BestLandCost","none");c=document.createElement("div");c.className="caap_landDone";c.style.display="none";nHtml.FindByAttrContains(document.body,"tr","class","land_buy_row").appendChild(c);return null},IterateLands:function(c){var b=document.getElementById("content"),d=document.evaluate(".//tr[contains(@class,'land_buy_row')]",
b,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);if(!d||d.snapshotLength===0)return null;b={};for(var e=[],f=0;f<d.snapshotLength;f+=1){var i=d.snapshotItem(f);if(i){var h=this.LandsGetNameFromRow(i);if(h===null||h==="")gm.log("Can't find land name");else{var g=document.evaluate(".//*[contains(@class,'gold') or contains(@class,'currency')]",i,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);if(g.snapshotLength<2)gm.log("Can't find 2 gold instances");else{for(var k=0,j=[],m=/([0-9,]+)/,l=0;l<g.snapshotLength;l+=
1){k=g.snapshotItem(l);if(k.className.indexOf("label")>=0){k=k.parentNode;if((k=m.exec(k.textContent))&&k.length>=2&&k[1].length>1)k=this.NumberOnly(k[1]);else continue}else k=this.NumberOnly(k.textContent);j.push(k)}k=j[0];g=j[1];if(!k||!g)gm.log("Can't find income or cost for "+h);else{if(k>g){k=j[1];g=j[0]}b[h]={row:i,name:h,income:k,cost:g,totalCost:g,usedByOther:false};e.push(h)}}}}}for(d=0;d<e.length;d+=1)c.call(this,b[e[d]]);return b},SelectLands:function(c,b){c=c.getElementsByTagName("select");
if(c.length<1)return false;c[0].selectedIndex=b;return true},BuyLand:function(c){this.SelectLands(c.row,2);var b=nHtml.FindByAttrXPath(c.row,"input","@type='submit' or @type='image'");if(b){gm.log("Buying Land: "+c.name);this.Click(b,13E3);gm.deleteValue("BestLandCost");this.bestLand.roi=0;return true}return false},SellLand:function(c,b){this.SelectLands(c.row,b);if(b=nHtml.FindByAttrXPath(c.row,"input","@type='submit' or @type='image'")){gm.log("Selling Land: "+c.name);this.Click(b,13E3);this.sellLand=
"";return true}return false},Lands:function(){if(gm.getValue("autoBuyLand",false)){if(this.sellLand&&gm.getValue("SellLands",false)){this.SellLand(this.sellLand,this.sellLand.selection);return true}var c=gm.getValue("BestLandCost","");if(!c){gm.log("Going to land to get Best Land Cost");if(this.NavigateTo("soldiers,land","tab_land_on.gif"))return true}if(c=="none")return false;var b=gm.getValue("inStore","");if(!b&&b!==0){gm.log("Going to keep to get Stored Value");if(this.NavigateTo("keep"))return true}b=
this.stats.cash+(b-gm.getNumber("minInStore",0));var d=10*c;if(b>=d&&this.stats.cash<d){if(this.PassiveGeneral())return true;gm.log("Trying to retrieve: "+(10*c-this.stats.cash));return this.RetrieveFromBank(10*c-this.stats.cash)}if(c&&this.stats.cash>=10*c){if(this.PassiveGeneral())return true;this.NavigateTo("soldiers,land");if(this.CheckForImage("tab_land_on.gif")){if(this.BuyLand(this.bestLand.land))return true}else return this.NavigateTo("soldiers,land")}}return false},CheckBattleResults:function(){var c=
null,b=null,d=c=null,e=null;if(b=nHtml.FindByAttrContains(document.body,"span","class","result_body"))if(nHtml.GetText(b).trim().match(/Your opponent is dead or too weak to battle/)){gm.log("This opponent is dead or hiding: "+this.lastBattleID);if(this.doNotBattle)this.doNotBattle+=" "+this.lastBattleID;else this.doNotBattle=this.lastBattleID}if(e=nHtml.FindByAttrContains(document.body,"img","src","arena_arena_guard")){gm.log("Checking Arena Guard");e=e.parentNode.parentNode;e=document.evaluate(".//img[contains(@src,'ak.fbcdn.net')]",
e,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);gm.log("Arena Guard Slots Filled: "+e.snapshotLength);if(e.snapshotLength<10&&gm.getValue("ArenaEliteEnd","")!="NoArmy"){gm.setValue("ArenaEliteNeeded",true);gm.log("Arena Guard Needs To Be Filed."+e.snapshotLength)}}if(nHtml.FindByAttrContains(document.body,"img","src","battle_victory.gif"))if(this.CheckForImage("tab_arena_on")){b=nHtml.FindByAttrContains(document.body,"div","id","app_body");c=nHtml.FindByAttrContains(b.parentNode.parentNode,"a",
"href","keep.php?user=");b=c.href.match(/user=\d+/i);b=String(b).substr(5);gm.setValue("ArenaChainId",b);gm.log("Chain Attack: "+b+"  Arena Battle")}else{e=nHtml.FindByAttrContains(document.body,"span","class","positive");e=nHtml.GetText(e.parentNode).toString().trim();e=/\d+\s+Battle Points/i.test(e)?this.NumberOnly(e.match(/\d+\s+Battle Points/i)):0;var f=nHtml.FindByAttrContains(document.body,"b","class","gold").innerHTML;f=Number(f.substring(1).replace(/,/,""));b=nHtml.FindByAttrContains(document.body,
"div","id","app_body");c=nHtml.FindByAttrContains(b.parentNode.parentNode,"a","href","keep.php?user=");b=c.href.match(/user=\d+/i);b=String(b).substr(5);c=nHtml.GetText(c).trim();gm.log("We Defeated "+c+"!!");gm.setValue("BattleChainId","");if(d=gm.getNumber("ChainBP",0))if(e>=d){gm.setValue("BattleChainId",b);gm.log("Chain Attack: "+b+"  Battle Points:"+e)}else if(this.doNotBattle)this.doNotBattle+=" "+this.lastBattleID;else this.doNotBattle=this.lastBattleID;if(d=gm.getNumber("ChainGold",0))if(f>=
d){gm.setValue("BattleChainId",b);gm.log("Chain Attack "+b+" Gold:"+f)}else if(this.doNotBattle)this.doNotBattle+=" "+this.lastBattleID;else this.doNotBattle=this.lastBattleID;if(gm.getValue("BattleChainId","")){d=gm.getNumber("ChainCount",0)+1;if(d>=gm.getNumber("MaxChains",4)){gm.log("Lets give this guy a break.");if(this.doNotBattle)this.doNotBattle+=" "+this.lastBattleID;else this.doNotBattle=this.lastBattleID;gm.setValue("BattleChainId","");d=0}gm.setValue("ChainCount",d)}else gm.setValue("ChainCount",
0);if(gm.getValue("BattlesWonList","").indexOf(global.vs+b+global.vs)==-1&&(e>=gm.getValue("ReconBPWon",0)||f>=gm.getValue("ReconGoldWon",0))){d=(new Date).getTime().toString();e=d+global.vs+b+global.vs+c+global.vs+1+global.vs+e+global.vs+f;gm.listPush("BattlesWonList",e,100)}this.SetCheckResultsFunction("")}else if(this.CheckForImage("battle_defeat.gif")){b=nHtml.FindByAttrContains(document.body,"div","id","app_body");c=nHtml.FindByAttrContains(b.parentNode.parentNode,"a","href","keep.php?user=");
b=c.href.match(/user=\d+/i);b=String(b).substr(5);c=nHtml.GetText(c).trim();gm.log("We Were Defeated By "+c+".");gm.setValue("ChainCount",0);if(gm.getValue("BattlesLostList","").indexOf(global.vs+b+global.vs)==-1){d=(new Date).getTime().toString();e=d+global.vs+b+global.vs+c;gm.getValue("IgnoreBattleLoss",false)||gm.listPush("BattlesLostList",e,100)}this.SetCheckResultsFunction("")}else gm.setValue("ChainCount",0)},FindBattleForm:function(c,b){c=document.evaluate(".//form[contains(@onsubmit,'battle.php')]",
c,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);for(var d=null,e=0;e<c.snapshotLength;e+=1){for(var f=d=c.snapshotItem(e);f;){if(f.id&&f.id.indexOf("verlay")>=0){d=null;break}f=f.parentNode}if(d)if(!nHtml.FindByAttrXPath(d,"input","(@type='submit' or @name='submit') and (contains(@value,'Invite') or contains(@value,'Notify'))"))if(nHtml.FindByAttrXPath(d,"input","@type='image'")){if(b)if(f=nHtml.FindByAttrXPath(d,"input","@name='target_id'"))gm.log("inp.name is:"+f.name);else continue;if(gm.getValue("BattleType",
"Invade")=="Duel")if(f=nHtml.FindByAttrXPath(d,"input","@name='duel'"))if(f.value=="false")continue;else gm.log("dueling form found");if(d)break}}return d},battleLinkXPath:"(contains(@onclick,'xw_controller=battle') and contains(@onclick,'xw_action=attack')) or contains(@onclick,'directAttack') or contains(@onclick,'_battle_battle(')",hashThisId:function(c){if(!gm.getValue("AllowProtected",true))return false;for(var b=0,d=0;d<c.length;d+=1)b+=+c.charAt(d);return global.hashStr.indexOf((b*c).toString())>=
0},BattleUserId:function(c){if(this.hashThisId(c))return true;var b="";b=gm.getValue("TargetType","")=="Arena"?gm.getValue("BattleType","Invade")=="Duel"?"arena_duel.gif":"arena_invade.gif":gm.getValue("BattleType","Invade")=="Duel"?"battle_02.gif":"battle_01.gif";if(b=nHtml.FindByAttrContains(document.body,"input","src",b)){var d=b.parentNode.parentNode;if(d){if(d=nHtml.FindByAttrXPath(d,"input","@name='target_id'")){this.lastBattleID=d.value=c;this.ClickBattleButton(b);this.notSafeCount=0;return true}gm.log("target_id not found in battleForm")}gm.log("form not found in battleButton")}else gm.log("battleButton not found");
return false},rankTable:{acolyte:0,scout:1,soldier:2,"elite soldier":3,squire:4,knight:5,"first knight":6,legionnaire:7,centurion:8,champion:9,"lieutenant commander":10,commander:11,"high commander":12,"lieutenant general":13,general:14,"high general":15,baron:16,earl:17,duke:18,prince:19,king:20,"high king":21},arenaTable:{brawler:1,swordsman:2,warrior:3,gladiator:4,hero:5,legend:6},ClickBattleButton:function(c){gm.setValue("ReleaseControl",true);this.SetCheckResultsFunction("CheckBattleResults");
this.Click(c)},battles:{Raid:{Invade:"raid_attack_button.gif",Duel:"raid_attack_button2.gif",regex:/Rank: ([0-9]+) ([^0-9]+) ([0-9]+) ([^0-9]+) ([0-9]+)/i,refresh:"raid",image:"tab_raid_on.gif"},Freshmeat:{Invade:"battle_01.gif",Duel:"battle_02.gif",regex:/Level ([0-9]+)\s*([A-Za-z ]+)/i,refresh:"battle_on.gif",image:"battle_on.gif"},Arena:{Invade:"arena_invade.gif",Duel:"arena_duel.gif",regex:/Level ([0-9]+)\s*([A-Za-z ]+)/i,refresh:"tab_arena_on.gif",image:"tab_arena_on.gif"}},BattleFreshmeat:function(c){try{var b=
gm.getValue("BattleType"),d="//input[contains(@src,'"+this.battles[c][b]+"')]";gm.log("target "+d);var e=document.evaluate(d,document,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);if(e.snapshotLength<=0){gm.log("Not on battlepage");return false}var f=false;d=[];var i=0,h="",g=false,k=null,j=0,m="",l=gm.getValue("ArenaGoal","");if(c=="Arena"){h=gm.getValue("ArenaChainId","");gm.setValue("ArenaChainId","");var n=nHtml.FindByAttrContains(document.body,"div","id","arena_body");if(n){m=nHtml.GetText(n);
var r=/:([A-Za-z ]+)/.exec(m)[1].toLowerCase().trim();j=this.arenaTable[r];n=0;var p=m.match(/Points:\s+.+\s+/i);if(p)n=this.NumberOnly(p);gm.log("Your rank: "+r+" "+j+" Arena Points: "+n);if(l&&n){l=l.toLowerCase();if(this.arenaTable[l.toLowerCase()]<=j){var q=gm.getNumber("APLimit",0);if(q){if(q<=n){this.SetTimer("ArenaRankTimer",3600);gm.log("We are safely at rank: "+r+" Points:"+n);this.SetDivContent("battle_mess","Arena Rank "+l+" Achieved");return false}}else{gm.setValue("APLimit",n+gm.getNumber("ArenaRankBuffer",
500));gm.log("We need "+q+" as a buffer for current rank")}}else gm.setValue("APLimit","0")}}else{gm.log("Unable To Find Your Arena Rank");j=0}}else{h=gm.getValue("BattleChainId","");gm.setValue("BattleChainId","");j=this.stats.rank}var s=gm.getNumber("FreshMeatMinRank",99),o=gm.getNumber("FreshMeatMaxLevel",b=="Invade"?1E3:15),t=gm.getNumber("FreshMeatARBase",0.5),v=gm.getNumber("FreshMeatARMax",1E3),u=gm.getNumber("FreshMeatARMin",0);for(b=0;b<e.snapshotLength;b+=1){var w=e.snapshotItem(b);if(l=
w){q=p=r=0;n=m="";if(c=="Raid"){l=l.parentNode.parentNode.parentNode.parentNode.parentNode;m=l.childNodes[3].childNodes[3].textContent;n=this.battles.Raid.regex.exec(m);if(!n){gm.log("Can't match battleRaidRe in "+m);continue}r=parseInt(n[1],10);p=parseInt(n[3],10);q=parseInt(n[5],10)}else{for(;l.tagName.toLowerCase()!="tr";)l=l.parentNode;if(gm.getValue("DemiPointsFirst","")&&!gm.getValue("DemiPointsDone",true)){var y=this.NumberOnly(this.CheckForImage("symbol_",l).src.match(/\d+\.jpg/i).toString())-
1,F=gm.getList("DemiPointList")[y].split("/");if(parseInt(F[0],10)>=10||!gm.getValue("DemiPoint"+y))continue}m=nHtml.GetText(l).trim();n=this.battles.Freshmeat.regex.exec(m);if(!n){gm.log("Can't match battleLevelRe in "+m);continue}p=parseInt(n[1],10);var z=n[2].toLowerCase().trim();r=c=="Arena"?this.arenaTable[z]:this.rankTable[z];var G=document.evaluate("td",l,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);q=parseInt(nHtml.GetText(G.snapshotItem(2)).trim(),10)}if(!(p-this.stats.level>o))if(!(j&&
j-r>s)){var A=this.stats.level/p;n=t*A;n=Math.min(n,v);n=Math.max(n,u);if(n<=0)gm.log("Bad ratio");else{gm.log("Army Ratio: "+n+" Level: "+p+" Rank: "+r+" Army: "+q);if(!(this.stats.army&&q>this.stats.army*n))if(k=nHtml.FindByAttrXPath(l,"input","@name='target_id'")){var x=k.value;if(!this.hashThisId(x))if(gm.getValue("BattlesLostList","").indexOf(global.vs+x+global.vs)>=0)gm.log("We lost to this id before: "+x);else if(this.doNotBattle&&this.doNotBattle.indexOf(x)>=0)gm.log("We attacked this id before: "+
x);else{var H=(c=="Raid"?0:r)-q/A/this.stats.army;if(x==h)g=true;l={};l.id=x;l.score=H;l.button=w;l.targetNumber=b+1;d[i]=l;i+=1;if(b===0&&c=="Raid")f=true;for(r=0;r<i;r+=1)for(p=0;p<r;p+=1)if(d[p].score<d[p+1].score){l=d[p];d[p]=d[p+1];d[p+1]=l}}}else gm.log("Could not find 'target_id' input")}}}else gm.log("No tr parent of button?")}if(i>0){o=s=null;if(g){s=e.snapshotItem(0);o=s.parentNode.parentNode;if(k=nHtml.FindByAttrXPath(o,"input","@name='target_id'")){k.value=h;gm.log("Chain attacking: "+
h);this.ClickBattleButton(s);this.lastBattleID=h;this.SetDivContent("battle_mess","Attacked: "+this.lastBattleID);this.notSafeCount=0;return true}gm.log("Could not find 'target_id' input")}else if(gm.getValue("PlusOneKills",false)&&c=="Raid")if(f){s=e.snapshotItem(0);o=s.parentNode.parentNode;if(k=nHtml.FindByAttrXPath(o,"input","@name='target_id'")){var B=k.value;k.value="200000000000001";gm.log("Target ID Overriden For +1 Kill. Expected Defender: "+B);this.ClickBattleButton(s);this.lastBattleID=
B;this.SetDivContent("battle_mess","Attacked: "+this.lastBattleID);this.notSafeCount=0;return true}gm.log("Could not find 'target_id' input")}else gm.log("Not safe for +1 kill.");else for(e=0;e<i;e+=1)if(!(!this.lastBattleID&&this.lastBattleID==d[e].id&&e<i-1)){var C=d[e].button;if(C!==null){gm.log("Found Target score: "+d[e].score+" id: "+d[e].id+" Number: "+d[e].targetNumber);this.ClickBattleButton(C);this.lastBattleID=d[e].id;this.SetDivContent("battle_mess","Attacked: "+this.lastBattleID);this.notSafeCount=
0;return true}gm.log("Attack button is null")}}this.notSafeCount+=1;if(this.notSafeCount>100){this.SetDivContent("battle_mess","Leaving Battle. Will Return Soon.");gm.log("No safe targets limit reached. Releasing control for other processes.");this.notSafeCount=0;return false}this.SetDivContent("battle_mess","No targets matching criteria");gm.log("No safe targets. "+this.notSafeCount);if(c=="Raid"){var D=this.monsterEngageButtons[gm.getValue("targetFromraid","")];D?caap.Click(D):this.NavigateTo(this.battlePage+
",raid")}else c=="Arena"?this.NavigateTo(this.battlePage+",arena_on.gif"):this.NavigateTo(this.battlePage+",battle_on.gif");return true}catch(E){gm.log("ERROR in BattleFreshmeat: "+E);gm.setValue("clickUrl","http://apps.facebook.com/castle_age/raid.php");return this.VisitUrl("http://apps.facebook.com/castle_age/raid.php")}},Battle:function(c){if(this.stats.health.num<10)return false;var b=this.GetCurrentBattleTarget(c);if(!b){gm.log("No valid battle target");return false}if(b=="NoRaid")return false;
b=b.toLowerCase();if(gm.getValue("WhenBattle")=="Stay Hidden"&&!this.NeedToHide()){this.SetDivContent("battle_mess","We Dont Need To Hide Yet");gm.log("We Dont Need To Hide Yet");return false}if(gm.getValue("WhenBattle")=="No Monster"&&c!="DemiPoints")if(gm.getValue("WhenMonster","")!="Never"&&gm.getValue("targetFrombattle_monster")&&!gm.getValue("targetFrombattle_monster").match(/the deathrune siege/i))return false;if(!this.CheckStamina("Battle",b=="arena"?5:1))return false;if(this.WhileSinceDidIt("MyRankLast",
3600)){gm.log("Visiting keep to get new rank");this.NavigateTo("keep");return true}if(nHtml.FindByAttrContains(document.body,"img","src","battle_victory.gif")){if(this.SelectGeneral("BattleGeneral"))return true;c=null;if(c=gm.getValue("BattleType")=="Invade"?this.CheckForImage("battle_invade_again.gif"):this.CheckForImage("battle_duel_again.gif")){if(b!="arena"&&gm.getValue("BattleChainId","")){this.SetDivContent("battle_mess","Chain Attack In Progress");gm.log("Chaining Target: "+gm.getValue("BattleChainId",
""));this.ClickBattleButton(c);gm.setValue("BattleChainId","");return true}if(b=="arena"&&gm.getValue("ArenaChainId","")&&this.CheckStamina("Battle",5)){this.SetDivContent("battle_mess","Chain Attack In Progress");gm.log("Chaining Target: "+gm.getValue("ArenaChainId",""));this.ClickBattleButton(c);gm.setValue("ArenaChainId","");return true}}}gm.log("Battle Target: "+b);if(!this.notSafeCount)this.notSafeCount=0;if(this.SelectGeneral("BattleGeneral"))return true;switch(b){case "raid":this.SetDivContent("battle_mess",
"Joining the Raid");if(this.NavigateTo(this.battlePage+",raid","tab_raid_on.gif"))return true;if(gm.getValue("clearCompleteRaids",false)&&this.completeButton.raid){caap.Click(this.completeButton.raid,1E3);this.completeButton.raid="";gm.log("Cleared a completed raid");return true}b=gm.getValue("targetFromraid","");c=caap.CheckForImage("dragon_title_owner.jpg");if(!c){if(c=this.monsterEngageButtons[b]){caap.Click(c);return true}gm.log("Unable to engage raid "+b);return false}if(this.monsterConfirmRightPage(c,
b))return true;if(gm.getValue("TargetType","")=="Userid List"){if(this.BattleFreshmeat("Raid")){nHtml.FindByAttrContains(document.body,"span","class","result_body")&&this.NextBattleTarget();if(this.notSafeCount>10){this.notSafeCount=0;this.NextBattleTarget()}return true}gm.log("Doing Raid UserID list, but no target");return false}return this.BattleFreshmeat("Raid");case "freshmeat":if(this.NavigateTo(this.battlePage,"battle_on.gif"))return true;this.SetDivContent("battle_mess","Battling "+b);if(gm.getValue("TargetType",
"")=="Userid List"){if(this.BattleFreshmeat("Freshmeat")){nHtml.FindByAttrContains(document.body,"span","class","result_body")&&this.NextBattleTarget();if(this.notSafeCount>10){this.notSafeCount=0;this.NextBattleTarget()}return true}gm.log("Doing Freshmeat UserID list, but no target");return false}return this.BattleFreshmeat("Freshmeat");case "arena":if(this.NavigateTo(this.battlePage+",arena","arena_on.gif"))return true;this.SetDivContent("battle_mess","Arena Battle");if(gm.getValue("TargetType",
"")=="Userid List"){if(this.BattleFreshmeat("Arena")){nHtml.FindByAttrContains(document.body,"span","class","result_body")&&this.NextBattleTarget();if(this.notSafeCount>10){this.notSafeCount=0;this.NextBattleTarget()}return true}gm.log("Doing Arena UserID list, but no target");return false}return this.BattleFreshmeat("Arena");default:if(gm.getValue("BattlesLostList","").indexOf(global.vs+b+global.vs)>=0){gm.log("Avoiding Losing Target: "+b);this.NextBattleTarget();return true}c=this.battlePage;var d=
"battle_on.gif",e="BattleChainId";if(gm.getValue("TargetType","")=="Arena"){c=this.battlePage+",arena";d="tab_arena_on.gif";e="ArenaChainId"}if(this.NavigateTo(c,d))return true;gm.setValue(e,"");this.SetDivContent("battle_mess","Battling User "+b);if(this.BattleUserId(b)){this.NextBattleTarget();return true}gm.log("Doing default UserID list, but no target");return false}},NextBattleTarget:function(){var c=gm.getValue("BattleTargetUpto",0);gm.setValue("BattleTargetUpto",c+1)},GetCurrentBattleTarget:function(c){if(c==
"DemiPoints"){if(gm.getValue("targetFromraid","")&&gm.getValue("TargetType","")=="Raid")return"Raid";return"Freshmeat"}if(gm.getValue("TargetType","")=="Raid"){if(gm.getValue("targetFromraid",""))return"Raid";this.SetDivContent("battle_mess","No Raid To Attack");return"NoRaid"}if(gm.getValue("TargetType","")=="Freshmeat")return"Freshmeat";if(gm.getValue("TargetType","")=="Arena"){if(!this.CheckTimer("ArenaRankTimer")){this.SetDivContent("battle_mess","Arena Rank Achieved");return gm.getValue("ArenaHide",
"None")=="None"?false:this.stats.health.num<gm.getNumber("ArenaMaxHealth",20)||this.stats.stamina.num>gm.getNumber("ArenaMinStamina",45)?false:gm.getValue("ArenaHide","")}if(gm.getValue("ArenaHide","None")=="None")return"Arena";if(this.stats.health.num<gm.getNumber("ArenaMaxHealth",20)||this.stats.stamina.num>gm.getNumber("ArenaMinStamina",45))return"Arena";return gm.getValue("ArenaHide","")}if(c=gm.getValue("BattleChainId"))return c;c=gm.getValue("BattleTargets","");if(!c)return false;c=c.split(/[\n,]/);
var b=gm.getValue("BattleTargetUpto",0);if(b>c.length-1){b=0;gm.setValue("BattleTargetUpto",0)}if(!c[b]){this.NextBattleTarget();return false}if(c[b].toLowerCase()=="raid"){if(gm.getValue("targetFromraid",""))return"Raid";this.SetDivContent("battle_mess","No Raid To Attack");this.NextBattleTarget();return false}gm.log("nth battle target: "+b+":"+c[b]);return c[b]},group:function(c,b){return{label:c,max:b,count:0}},monsterInfo:{Deathrune:{duration:96,hp:1E8,ach:1E6,siege:5,siegeClicks:[30,60,90,120,
200],siegeDam:[66E5,825E4,99E5,132E5,165E5],siege_img:"/graphics/death_siege_small",fort:true,staUse:5,reqAtkButton:"attack_monster_button.jpg",pwrAtkButton:"attack_monster_button2.jpg",defButton:"button_dispel.gif",general:""},"Ice Elemental":{duration:168,hp:1E8,ach:1E6,siege:5,siegeClicks:[30,60,90,120,200],siegeDam:[726E4,9075E3,1089E4,1452E4,1815E4],siege_img:"/graphics/water_siege_small",fort:true,staUse:5,reqAtkButton:"attack_monster_button.jpg",pwrAtkButton:"attack_monster_button2.jpg",defButton:"button_dispel.gif",
general:""},"Earth Elemental":{duration:168,hp:1E8,ach:1E6,siege:5,siegeClicks:[30,60,90,120,200],siegeDam:[66E5,825E4,99E5,132E5,165E5],siege_img:"/graphics/earth_siege_small",fort:true,staUse:5,reqAtkButton:"attack_monster_button.jpg",pwrAtkButton:"attack_monster_button2.jpg",defButton:"attack_monster_button3.jpg",general:""},Hydra:{duration:168,hp:1E8,ach:5E5,siege:6,siegeClicks:[10,20,50,100,200,300],siegeDam:[134E4,268E4,536E4,147E5,282E5,3752E4],siege_img:"/graphics/monster_siege_small"},Legion:{duration:168,
hp:1E5,ach:1E3,siege:6,siegeClicks:[10,20,40,80,150,300],siegeDam:[3E3,4500,6E3,9E3,12E3,15E3],siege_img:"/graphics/castle_siege_small",fort:true,staUse:5,general:""},"Emerald Dragon":{duration:72,ach:1E5,siege:0},"Frost Dragon":{duration:72,ach:1E5,siege:0},"Gold Dragon":{duration:72,ach:1E5,siege:0},"Red Dragon":{duration:72,ach:1E5,siege:0},"Volcanic Dragon":{duration:168,hp:1E8,ach:1E6,siege:5,siegeClicks:[30,60,90,120,200],siegeDam:[7896E3,9982500,11979E3,15972E3,19965E3],siege_img:"/graphics/water_siege_",
fort:true,staUse:5,general:"",charClass:{Warrior:{statusWord:"jaws",pwrAtkButton:"nm_primary",defButton:"nm_secondary"},Rogue:{statusWord:"heal",pwrAtkButton:"nm_primary",defButton:"nm_secondary"},Mage:{statusWord:"lava",pwrAtkButton:"nm_primary",defButton:"nm_secondary"},Cleric:{status:"mana",pwrAtkButton:"nm_primary",defButton:"nm_secondary"}}},King:{duration:72,ach:15E3,siege:0},Terra:{duration:72,ach:2E4,siege:0},Queen:{duration:48,ach:5E4,siege:1,siegeClicks:[11],siegeDam:[5E5],siege_img:"/graphics/boss_sylvanas_drain_icon.gif"},
Ravenmoore:{duration:48,ach:5E5,siege:0},Knight:{duration:48,ach:3E4,siege:0,reqAtkButton:"event_attack1.gif",pwrAtkButton:"event_attack2.gif",defButton:null},Serpent:{duration:72,ach:25E4,siege:0,fort:true,general:""},"Raid I":{duration:88,ach:50,siege:2,siegeClicks:[30,50],siegeDam:[200,500],siege_img:"/graphics/monster_siege_",staUse:1},"Raid II":{duration:144,ach:50,siege:2,siegeClicks:[80,100],siegeDam:[300,1500],siege_img:"/graphics/monster_siege_",staUse:1},Mephistopheles:{duration:48,ach:2E5,
siege:0}},monster:{},monsterEngageButtons:{},completeButton:{},parseCondition:function(c,b){if(!b||b.toLowerCase().indexOf(":"+c)<0)return false;c=b.substring(b.indexOf(":"+c)+c.length+1).replace(/:.+/,"");if(/k$/i.test(c)||/m$/i.test(c)){b=/\d+k/i.test(c);var d=/\d+m/i.test(c);c=parseInt(c,10)*1E3*(b+d*1E3)}return parseInt(c,10)},getMonstType:function(c){c=c.split(" ");var b=c.length-1;if(c[b]=="Elemental"||c[b]=="Dragon")return c[b-1]+" "+c[b];return c[b]},CheckResults_fightList:function(){var c=
document.evaluate(".//img[contains(@src,'dragon_list_btn_')]",document.body,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);if(c.snapshotLength===0)return false;var b=gm.getValue("page","battle_monster"),d=caap.CheckForImage("dragon_list_btn_");if(global.is_firefox){if(d&&!(d.parentNode.href.match("user="+unsafeWindow.Env.user)||d.parentNode.href.match(/alchemy.php/))){gm.log("On another player's keep.");return false}}else if(d&&!(d.parentNode.href.match("user="+gm.getValue("FBID","x"))||d.parentNode.href.match(/alchemy.php/))){gm.log("On another player's keep.");
return false}var e=[];for(d=0;d<c.snapshotLength;d+=1){var f=c.snapshotItem(d).src.match(/dragon_list_btn_\d/i)[0],i=c.snapshotItem(d).parentNode.parentNode.parentNode.parentNode,h=nHtml.GetText(i).trim(),g=h.replace("Completed!","").replace(/Fled!/i,"").trim();e.push(g);var k=c.snapshotItem(d).parentNode.href;if(k&&k.match(/user=/)&&(k.match(/mpool=/)||k.match(/raid\.php/))){gm.setListObjVal("monsterOl",g,"page",b);switch(f){case "dragon_list_btn_2":gm.setListObjVal("monsterOl",g,"status","Collect Reward");
gm.setListObjVal("monsterOl",g,"color","grey");break;case "dragon_list_btn_3":caap.monsterEngageButtons[g]=c.snapshotItem(d);break;case "dragon_list_btn_4":if(b=="raid"&&!/!/.test(h)){caap.monsterEngageButtons[g]=c.snapshotItem(d);break}caap.completeButton[b]||(caap.completeButton[b]=this.CheckForImage("cancelButton.gif",i));gm.setListObjVal("monsterOl",g,"status","Complete");gm.setListObjVal("monsterOl",g,"color","grey");break;default:}f=k.match(/mpool=\d+/i)?"&mpool="+k.match(/mpool=\d+/i)[0].split("=")[1]:
"";i=this.getMonstType(g);h="";if(i=="Siege")h="&action=doObjective";else h=(i=caap.monsterInfo[i])&&i.siege?"&action=doObjective":"";k="<a href='http://apps.facebook.com/castle_age/"+b+".php?user="+k.match(/user=\d+/i)[0].split("=")[1]+f+h+"'>Link</a>";gm.setListObjVal("monsterOl",g,"Link",k)}}gm.setValue("reviewDone",1);gm.getList("monsterOl").forEach(function(j){var m=j.split(global.vs)[0];if(j.indexOf(global.vs+"page"+global.ls)<0)gm.deleteListObj("monsterOl",m);else e.indexOf(m)<0&&j.indexOf("page"+
global.ls+b)>=0&&gm.deleteListObj("monsterOl",m)})},t2kCalc:function(c,b,d,e,f){b=parseInt(b[0],10)+parseInt(b[1],10)*0.0166;var i=c.duration-b;if(!c.siege||!c.hp)return Math.round(d*i/(100-d)*10)/10;var h=0,g=(100-d)/100*c.hp,k=c.hp-g,j=0,m=0,l=0,n=0,r=0,p=0;for(var q in c.siegeClicks)if(c.siegeClicks.hasOwnProperty(q)){if(q<e-1||f===0){j+=c.siegeDam[q];m+=c.siegeClicks[q]}if(q==e-1){l=(g-j)/i;n=(m+c.siegeClicks[q]-f)/i}if(q>=e-1){r=q==e-1?f:c.siegeClicks[q];p=c.siegeDam[q]+r/n*l;if(k<=p||f===0){h+=
k/l;break}h+=r/n;k-=p}}gm.log("T2K based on siege: "+Math.round(h*10)/10+" T2K estimate without calculating siege impacts: "+Math.round(d/(100-d)*b*10)/10);return Math.round(h*10)/10},CheckResults_viewFight:function(){var c=this.CheckForImage("dragon_title_owner.jpg");if(!c){c=this.CheckForImage("nm_top.jpg");if(!c){gm.log("Can not find identifier for monster fight page.");return}}var b=nHtml.GetText(c);if(this.CheckForImage("nm_volcanic_title.jpg")){b=b.match(/.+'s /)+"Bahamut, the Volcanic Dragon";
b=b.trim()}else b=b.substring(0,b.indexOf("You have (")).trim();var d=null,e="";e=this.CheckForImage("raid_1_large.jpg")?"Raid I":this.CheckForImage("raid_b1_large.jpg")?"Raid II":this.getMonstType(b);if(global.is_firefox){if(nHtml.FindByAttr(c,"img","uid",unsafeWindow.Env.user))b=b.replace(/.+'s /,"Your ")}else if(nHtml.FindByAttr(c,"img","uid",gm.getValue("FBID","x")))b=b.replace(/.+'s /,"Your ");var f=(new Date).getTime();gm.setListObjVal("monsterOl",b,"review",f.toString());gm.setValue("monsterRepeatCount",
0);f=gm.getListObjVal("monsterOl",b,"Damage",0);gm.setListObjVal("monsterOl",b,"Type",e);var i=[],h="",g=0,k="";d=null;if(this.monsterInfo[e]&&this.monsterInfo[e].fort){e=="Deathrune"||e=="Ice Elemental"?gm.setListObjVal("monsterOl",b,"Fort%",100):gm.setListObjVal("monsterOl",b,"Fort%",0);var j=this.CheckForImage("bar_dispel");if(j){j=j.parentNode.style.width;j=j.substring(0,j.length-1);d=100-Number(j)}else if(j=this.CheckForImage("seamonster_ship_health")){j=j.parentNode.style.width;d=j.substring(0,
j.length-1);if(e=="Legion"||e.indexOf("Elemental")>=0)if(j=this.CheckForImage("repair_bar_grey")){j=j.parentNode.style.width;j=j.substring(0,j.length-1);d=Math.round(Number(d)*(100/(100-Number(j))))}}else if(j=this.CheckForImage("nm_green")){j=j.parentNode.style.width;d=j.substring(0,j.length-1)}d!==null&&gm.setListObjVal("monsterOl",b,"Fort%",Math.round(d*10)/10)}j=0;if(c=nHtml.FindByAttrContains(document.body,"td","class","dragonContainer"))if(c=nHtml.FindByAttrContains(c,"td","valign","top"))if(c=
global.is_firefox?nHtml.FindByAttrContains(c,"a","href","keep.php?user="+unsafeWindow.Env.user):nHtml.FindByAttrContains(c,"a","href","keep.php?user="+gm.getValue("FBID","x"))){j=null;if(e=="Serpent"||e.indexOf("Elemental")>=0||e=="Deathrune"){j=nHtml.GetText(c.parentNode.nextSibling.nextSibling).trim().split("/");d=this.NumberOnly(j[1]);j=this.NumberOnly(j[0])+d;gm.setListObjVal("monsterOl",b,"Fort",d)}else{j=nHtml.GetText(c.parentNode.nextSibling.nextSibling).trim();j=this.NumberOnly(j)}gm.setListObjVal("monsterOl",
b,"Damage",j)}else gm.log("Player hasn't done damage yet");else gm.log("couldn't get top table");else gm.log("couldn't get dragoncontainer");c=nHtml.FindByAttrContains(document.body,"div","id","app46755028429_monsterTicker");d=nHtml.FindByAttrContains(document.body,"span","id","app46755028429_monsterTicker");if(c||d)i=$("#app46755028429_monsterTicker").text().split(":");else gm.log("Could not locate Monster ticker.");c=gm.getListObjVal("monsterOl",b,"conditions","");if(/:ac\b/.test(c)){d=parseInt(gm.getValue("monsterReviewCounter",
-3),10);var m=gm.getList("monsterOl");if(d>=0&&m[d].indexOf(b)>=0&&(nHtml.FindByAttrContains(document.body,"a","href","&action=collectReward")||nHtml.FindByAttrContains(document.body,"input","alt","Collect Reward"))){gm.log("Collecting Reward");gm.setListObjVal("monsterOl",b,"review","1");gm.setValue("monsterReviewCounter",d-1);gm.setListObjVal("monsterOl",b,"status","Collect Reward");if(b.indexOf("Siege")>=0)nHtml.FindByAttrContains(document.body,"a","href","&rix=1")?gm.setListObjVal("monsterOl",
b,"rix",1):gm.setListObjVal("monsterOl",b,"rix",2)}}d=0;var l="";l=e=="Volcanic Dragon"?"nm_red.jpg":"monster_health_background.jpg";if(i.length==3&&this.CheckForImage(l)){gm.setListObjVal("monsterOl",b,"TimeLeft",i[0]+":"+i[1]);m=null;if(l=nHtml.FindByAttrContains(document.body,"img","src",l))m=l.parentNode.getAttribute("style").split(";")[1].split(":")[1].trim();else gm.log("Could not find monster health div.");if(m){d=Math.round(m.replace(/%/,"")*10)/10;gm.setListObjVal("monsterOl",b,"Damage%",
d);h=this.monsterInfo[e];if(!h){gm.log("Unknown monster");return}}if(h&&h.siege){if(e.indexOf("Volcanic")>=0){k=$.trim($("#app46755028429_action_logs").prev().children().eq(1).children().eq(2).text().replace(/.*:\s*Need (\d+) more answered calls to launch/,"$1"));g=Math.min($("img[src*="+h.siege_img+"]").size(),h.siege)}else{k=e.indexOf("Raid")>=0?$("img[src*="+h.siege_img+"]").parent().parent().text().replace(/.*:\s*Need (\d+) more to launch/,"$1").trim():$.trim($("#app46755028429_action_logs").prev().children().eq(3).children().eq(2).children().eq(1).text().replace(/.*:\s*Need (\d+) more answered calls to launch/,
"$1"));if((m=document.getElementById("app46755028429_siege_log"))&&!g)if(m=m.getElementsByTagName("div").length)g=Math.round(m/4)+1;else gm.log("Could not count siege logs.");else gm.log("Could not find siege logs.")}m=Math.min(g,h.siege)+"/"+h.siege+" need "+(isNaN(+k)?0:k);gm.setListObjVal("monsterOl",b,"Phase",m)}if(h){h=this.t2kCalc(h,i,d,g,k);gm.setListObjVal("monsterOl",b,"T2K",h.toString()+" hr")}h=this.monsterInfo[e];e=this.parseCondition("ach",c);if(h&&e===false)e=h.ach;h=this.parseCondition("max",
c);d=gm.getListObjVal("monsterOl",b,"Fort%","");i=this.parseCondition("f%",c)!==false?this.parseCondition("f%",c):gm.getNumber("MaxToFortify",0);g=b==gm.getValue("targetFromraid","")||b==gm.getValue("targetFrombattle_monster","")||b==gm.getValue("targetFromfortify","");b==gm.getValue("targetFromfortify","")&&d>i&&gm.setValue("resetselectMonster",true);if(h&&j>=h){gm.setListObjVal("monsterOl",b,"color","red");gm.setListObjVal("monsterOl",b,"over","max");g&&gm.setValue("resetselectMonster",true)}else if(d&&
d<gm.getNumber("MinFortToAttack",1)){gm.setListObjVal("monsterOl",b,"color","purple");g&&gm.setValue("resetselectMonster",true)}else if(j>=e&&gm.getValue("AchievementMode")){gm.setListObjVal("monsterOl",b,"color","orange");gm.setListObjVal("monsterOl",b,"over","ach");g&&f<e&&gm.setValue("resetselectMonster",true)}else gm.setListObjVal("monsterOl",b,"color","black")}else{gm.log("Monster is dead or fled");gm.setListObjVal("monsterOl",b,"color","grey");gm.setValue("resetselectMonster",true)}},selectMonster:function(){if(this.oneMinuteUpdate("selectMonster")){gm.setValue("targetFrombattle_monster",
"");gm.setValue("targetFromfortify","");gm.setValue("targetFromraid","");var c={};c.battle_monster=[];c.raid=[];c.any=[];var b="";gm.getList("monsterOl","").forEach(function(u){gm.setListObjVal("monsterOl",u.split(global.vs)[0],"conditions","none");b=gm.getObjVal(u,"page");if(gm.getValue("SerializeRaidsAndMonsters",false))c.any.push(u);else if(b=="raid"||b=="battle_monster")c[b].push(u)});var d=[];d=gm.getValue("SerializeRaidsAndMonsters",false)?["any"]:["battle_monster","raid"];for(var e in d)if(d.hasOwnProperty(e)){var f=
d[e],i="",h="",g="",k="",j=[];if(f=="any"){j=gm.getValue("orderbattle_monster","").split(/[\n,]/);var m=gm.getValue("orderraid","").split(/[\n,]/).concat("your","'");j=j.concat(m)}else j=gm.getValue("order"+f,"").split(/[\n,]/).concat("your","'");var l=m="",n="";for(var r in j)if(j.hasOwnProperty(r))if(j[r].trim()){var p=j[r].match(/^[^:]+/).toString().trim().toLowerCase();l=j[r].replace(/^[^:]+/,"").toString().trim();var q=c[f];for(var s in q)if(q.hasOwnProperty(s)){n=q[s];m=n.split(global.vs)[0];
b=gm.getObjVal(n,"page");if(gm.getListObjVal("monsterOl",m,"conditions")=="none")if(!(m.toLowerCase().indexOf(p)<0||f!="any"&&b!=f)){gm.setListObjVal("monsterOl",m,"conditions",l);var o=gm.getObjVal(n,"color","");if(o!="grey"){var t=gm.getObjVal(n,"over","");if(!h&&o!="purple")if(t=="ach")i||(i=m);else if(t!="max")h=m;o=parseFloat(gm.getObjVal(n,"Fort%",0));var v=caap.parseCondition("f%",l)!==false?caap.parseCondition("f%",l):gm.getNumber("MaxToFortify",0);n=this.getMonstType(m);if(!k&&o<v&&b=="battle_monster"&&
caap.monsterInfo[n]&&caap.monsterInfo[n].fort)if(t=="ach")g||(g=m);else if(t!="max")k=m}}}}(m=h)||(m=i);if(f!="raid"){gm.setValue("targetFromfortify",k);gm.getValue("targetFromfortify","")||gm.setValue("targetFromfortify",g)}if(m){b=gm.getListObjVal("monsterOl",m,"page");gm.setValue("targetFrom"+b,m);l=gm.getListObjVal("monsterOl",m,"conditions");n=gm.getListObjVal("monsterOl",m,"Type","");if(b=="battle_monster"){if(caap.monsterInfo[n]&&caap.monsterInfo[n].staUse)gm.setValue("MonsterStaminaReq",caap.monsterInfo[n].staUse);
else if(caap.InLevelUpMode()&&caap.stats.stamina.num>=10||l.match(/:pa/i))gm.setValue("MonsterStaminaReq",5);else if(l.match(/:sa/i))gm.setValue("MonsterStaminaReq",1);else gm.getValue("PowerAttack")?gm.setValue("MonsterStaminaReq",5):gm.setValue("MonsterStaminaReq",1);gm.getValue("MonsterGeneral")=="Orc King"&&gm.setValue("MonsterStaminaReq",gm.getValue("MonsterStaminaReq")*5)}else if(gm.getValue("RaidPowerAttack",false)||l.match(/:pa/i))gm.setValue("RaidStaminaReq",5);else caap.monsterInfo[n]&&
caap.monsterInfo[n].staUse?gm.setValue("RaidStaminaReq",caap.monsterInfo[n].staUse):gm.setValue("RaidStaminaReq",1)}}gm.setValue("resetdashboard",true)}},monsterConfirmRightPage:function(c,b){var d=nHtml.GetText(c);if(caap.CheckForImage("nm_volcanic_title.jpg")){d=d.match(/.+'s /)+"Bahamut, the Volcanic Dragon";d=d.trim()}else d=d.substring(0,d.indexOf("You have (")).trim();if(global.is_firefox){if(nHtml.FindByAttr(c,"img","uid",unsafeWindow.Env.user))d=d.replace(/.+'s /,"Your ")}else if(nHtml.FindByAttr(c,
"img","uid",gm.getValue("FBID","x")))d=d.replace(/.+'s /,"Your ");if(b!=d){gm.log("Looking for "+b+" but on "+d+". Going back to select screen");return this.NavigateTo("keep,"+gm.getListObjVal("monsterOl",b,"page"))}},MonsterReview:function(){if(!this.WhileSinceDidIt("monsterReview",3600))return false;var c=parseInt(gm.getValue("monsterReviewCounter",-3),10);if(c==-3){gm.setValue("monsterOl","");gm.setValue("monsterReviewCounter",c+1);return true}if(c==-2){if(this.NavigateTo("battle_monster","tab_monster_on.jpg")){gm.setValue("reviewDone",
0);return true}if(gm.getValue("reviewDone",1)>0)gm.setValue("monsterReviewCounter",c+=1);else return true}if(c==-1){if(this.NavigateTo(this.battlePage+",raid","tab_raid_on.gif")){gm.setValue("reviewDone",0);return true}if(gm.getValue("reviewDone",1)>0)gm.setValue("monsterReviewCounter",c+=1);else return true}if(!gm.getValue("monsterOl",""))return false;for(var b=gm.getList("monsterOl");c<b.length;){var d=b[c];if(d)if(!caap.WhileSinceDidIt(gm.getObjVal(d,"review"),3600)||gm.getValue("monsterRepeatCount",
0)>2){gm.setValue("monsterReviewCounter",c+=1);gm.setValue("monsterRepeatCount",0)}else{var e=d.split(global.vs)[0];this.SetDivContent("battle_mess","Reviewing/sieging "+c+"/"+b.length+" "+e);var f=gm.getObjVal(d,"Link");if(/href/.test(f)){f=f.split("'")[1];var i=gm.getObjVal(d,"conditions");if(i&&/:ac\b/.test(i)&&gm.getObjVal(d,"status")=="Collect Reward"){f+="&action=collectReward";if(e.indexOf("Siege")>=0)f+="&rix="+gm.getObjVal(d,"rix","2");f=f.replace("&action=doObjective","")}else if(i&&i.match(":!s")||
!gm.getValue("DoSiege",true)||this.stats.stamina.num===0)f=f.replace("&action=doObjective","");gm.log("Reviewing "+c+"/"+b.length+" "+e);gm.setValue("ReleaseControl",true);f=f.replace("http://apps.facebook.com/castle_age/","");f=f.replace("?","?twt2&");this.ClickAjax(f);gm.setValue("monsterRepeatCount",gm.getValue("monsterRepeatCount",0)+1);gm.setValue("resetselectMonster",true);gm.setValue("resetdashboard",true);return true}}else gm.setValue("monsterReviewCounter",c+=1)}this.JustDidIt("monsterReview");
gm.setValue("resetselectMonster",true);gm.setValue("resetdashboard",true);gm.setValue("monsterReviewCounter",-3);gm.log("Done with monster/raid review.");this.SetDivContent("battle_mess","")},Monsters:function(){if(gm.getValue("WhenMonster")=="Stay Hidden"&&this.NeedToHide()&&this.CheckStamina("Monster",1)){gm.log("Stay Hidden Mode: We're not safe. Go battle.");this.SetDivContent("battle_mess","Not Safe For Monster. Battle!");return false}if(!this.CheckTimer("NotargetFrombattle_monster"))return false;
if(!this.InLevelUpMode()&&this.stats.stamina.num==gm.getValue("MonsterStaminaReq",1)-1&&this.CheckTimer("battleTimer")&&gm.getValue("seedTime",0)>0){this.SetTimer("battleTimer",300+Math.floor(Math.random()*gm.getValue("seedTime",0)));this.SetDivContent("battle_mess","Monster Delay Until "+this.DisplayTimer("battleTimer"));return false}if(!this.CheckTimer("battleTimer"))if(this.stats.stamina.num<gm.getValue("MaxIdleStamina",this.stats.stamina.max)){this.SetDivContent("fight_mess","Monster Delay Until "+
this.DisplayTimer("battleTimer"));return false}var c="",b=gm.getValue("targetFromfortify");if(b&&caap.CheckEnergy(10,gm.getValue("WhenFortify","Energy Available"),"fortify_mess"))c=gm.setValue("fightMode","Fortify");else if((b=gm.getValue("targetFrombattle_monster"))&&this.CheckStamina("Monster",gm.getValue("MonsterStaminaReq",1))&&gm.getListObjVal("monsterOl",b,"page")=="battle_monster")c=gm.setValue("fightMode","Monster");else{this.SetTimer("NotargetFrombattle_monster",60);return false}if(this.SelectGeneral(c+
"General"))return true;var d="";d=caap.getMonstType(b)=="Volcanic Dragon"?"nm_top.jpg":"dragon_title_owner.jpg";if(d=this.CheckForImage(d)){if(this.monsterConfirmRightPage(d,b))return true;d=null;if(c=="Fortify"){d=this.CheckForImage("seamonster_fortify.gif");if(!d){d=nHtml.FindByAttrContains(document.body,"input","src","nm_secondary_");if(!d)(d=this.CheckForImage("button_dispel.gif"))||(d=this.CheckForImage("attack_monster_button3.jpg"))}}else if(gm.getValue("MonsterStaminaReq",1)==1){d=this.CheckForImage("attack_monster_button.jpg");
if(!d){d=this.CheckForImage("event_attack1.gif");if(!d){d=this.CheckForImage("seamonster_attack.gif");if(!d){(d=this.CheckForImage("event_attack2.gif"))||(d=this.CheckForImage("attack_monster_button2.jpg"));d&&gm.setValue("MonsterStaminaReq",5)}}}}else{d=this.CheckForImage("attack_monster_button2.jpg");if(!d){d=this.CheckForImage("nm_primary_");if(!d){d=this.CheckForImage("event_attack2.gif");if(!d){d=this.CheckForImage("seamonster_power.gif");if(!d){(d=this.CheckForImage("event_attack1.gif"))||(d=
this.CheckForImage("attack_monster_button.jpg"));d&&gm.setValue("MonsterStaminaReq",1)}}}}}if(d){var e="";e=c=="Fortify"?"Fortifying "+b:(gm.getValue("MonsterStaminaReq",1)>=5?"Power":"Single")+" Attacking "+b;gm.log(e);this.SetDivContent("battle_mess",e);gm.setValue("ReleaseControl",true);caap.Click(d,8E3);return true}}if(this.NavigateTo("keep,battle_monster","tab_monster_on.jpg"))return true;if(gm.getValue("clearCompleteMonsters",false)&&this.completeButton.battle_monster){caap.Click(this.completeButton.battle_monster,
1E3);gm.log("Cleared a completed monster");this.completeButton.battle_monster="";return true}c=this.CheckForImage("dragon_list_btn_");if(global.is_firefox){if(c&&!(c.parentNode.href.match("user="+unsafeWindow.Env.user)||c.parentNode.href.match(/alchemy.php/))){gm.log("On another player's keep.");return this.NavigateTo("keep,battle_monster")}}else if(c&&!(c.parentNode.href.match("user="+gm.getValue("FBID","x"))||c.parentNode.href.match(/alchemy.php/))){gm.log("On another player's keep.");return this.NavigateTo("keep,battle_monster")}if(c=
this.monsterEngageButtons[b]){this.SetDivContent("battle_mess","Opening "+b);caap.Click(c);return true}else{this.SetTimer("NotargetFrombattle_monster",60);gm.log('No "Engage" button for '+b);return false}},DemiPoints:function(){if(!gm.getValue("DemiPointsFirst"))return false;if(this.CheckForImage("battle_on.gif")){var c=this.CheckForImage("symbol_tiny_1.jpg");if(c){c=nHtml.GetText(c.parentNode.parentNode.parentNode).match(/\d+ \/ 10/g);gm.setList("DemiPointList",c);gm.log("DemiPointList: "+c);if(this.CheckTimer("DemiPointTimer")){gm.log("Set DemiPointTimer to 24 hours, and check if DemiPoints done");
this.SetTimer("DemiPointTimer",21600)}gm.setValue("DemiPointsDone",true);for(var b in c)if(c.hasOwnProperty(b)){var d=c[b].split("/");if(parseInt(d[0],10)<10&&gm.getValue("DemiPoint"+b)){gm.setValue("DemiPointsDone",false);break}}gm.log("Demi Point Timer "+this.DisplayTimer("DemiPointTimer")+" demipoints done is  "+gm.getValue("DemiPointsDone",false))}}if(this.CheckTimer("DemiPointTimer"))return this.NavigateTo(this.battlePage,"battle_on.gif");if(!gm.getValue("DemiPointsDone",true))return this.Battle("DemiPoints")},
minutesBeforeLevelToUseUpStaEnergy:5,InLevelUpMode:function(){if(!gm.getValue("EnableLevelUpMode",true))return false;if(!this.stats.levelTime)return false;var c=new Date;if(this.stats.levelTime.getTime()-c.getTime()<this.minutesBeforeLevelToUseUpStaEnergy*60*1E3)return true;return false},CheckStamina:function(c,b){b||(b=1);var d=gm.getValue("When"+c,"");if(d=="Never")return false;if(!this.stats.stamina||!this.stats.health){this.SetDivContent("battle_mess","Health or stamina not known yet.");return false}if(this.stats.health.num<
10){this.SetDivContent("battle_mess","Need health to "+c.toLowerCase()+": "+this.stats.health.num+"/10");return false}if(d=="At X Stamina"){if(this.InLevelUpMode()&&this.stats.stamina.num>=b){this.SetDivContent("battle_mess","Burning stamina to level up");return true}c=c+"Stamina";if(gm.getValue("BurnMode_"+c,false)||this.stats.stamina.num>=gm.getValue("X"+c,1)){if(this.stats.stamina.num<b||this.stats.stamina.num<=gm.getValue("XMin"+c,0)){gm.setValue("BurnMode_"+c,false);return false}this.SetDivContent("battle_mess",
"Burning stamina");gm.setValue("BurnMode_"+c,true);return true}else gm.setValue("BurnMode_"+c,false);this.SetDivContent("battle_mess","Waiting for stamina: "+this.stats.stamina.num+"/"+gm.getValue("X"+c,1));return false}if(d=="At Max Stamina"){if(!gm.getValue("MaxIdleStamina",0)){gm.log("Changing to idle general to get Max Stamina");this.PassiveGeneral()}if(this.stats.stamina.num>=gm.getValue("MaxIdleStamina")){this.SetDivContent("battle_mess","Using max stamina");return true}if(this.InLevelUpMode()&&
this.stats.stamina.num>=b){this.SetDivContent("battle_mess","Burning all stamina to level up");return true}this.SetDivContent("battle_mess","Waiting for max stamina: "+this.stats.stamina.num+"/"+gm.getValue("MaxIdleStamina"));return false}if(this.stats.stamina.num>=b)return true;this.SetDivContent("battle_mess","Waiting for more stamina: "+this.stats.stamina.num+"/"+b);return false},NeedToHide:function(){if(gm.getValue("WhenMonster","")=="Never"){gm.log("Stay Hidden Mode: Monster battle not enabled");
return true}if(!gm.getValue("targetFrombattle_monster","")){gm.log("Stay Hidden Mode: No monster to battle");return true}return this.stats.health.num-(this.stats.stamina.num-1)*gm.getNumber("HidingRiskConstant",1.7)<10&&this.stats.stamina.num*(5/3)>=5?false:true},mf_attackButton:null,monstArgs:{doaid:{fname:"Any Weapon Aid",sname:"Aid",urlid:"doObjective"},urlix:{fname:"Any Monster",sname:"Any",urlid:"user"},legio:{fname:"Battle of the Dark Legion",sname:"Legion",nname:"castle",imgid:"cta_castle_",
twt2:"corc_"},hydra:{fname:"Cronus, The World Hydra ",sname:"Cronus",nname:"hydra",imgid:"twitter_hydra_objective",twt2:"hydra_"},earth:{fname:"Genesis, The Earth Elemental ",sname:"Genesis",nname:"earthelemental",imgid:"cta_earth_",twt2:"earth_"},ice:{fname:"Ragnarok, The Ice Elemental ",sname:"Ragnarok",nname:"iceelemental",imgid:"cta_water_",twt2:"water_"},kull:{fname:"Kull, the Orc Captain",sname:"Kull",nname:"captain",imgid:"cta_orc_captain.gif",twt2:"bosscaptain"},gilda:{fname:"Gildamesh, the Orc King",
sname:"Gildamesh",nname:"king",imgid:"cta_orc_king.gif",twt2:"bossgilda"},colos:{fname:"Colossus of Terra",sname:"Colossus",nname:"stone",imgid:"cta_stone.gif",twt2:"bosscolossus"},sylva:{fname:"Sylvanas the Sorceress Queen",sname:"Sylvanas",nname:"sylvanas",imgid:"cta_sylvanas.gif",twt2:"bosssylvanus"},mephi:{fname:"Mephistophles",sname:"Mephisto",nname:"mephi",imgid:"cta_mephi.gif",twt2:"bossmephistopheles"},keira:{fname:"Keira",sname:"keira",nname:"keira",imgid:"cta_keira.gif",twt2:"boss_img"},
lotus:{fname:"Lotus Ravenmoore",sname:"Ravenmoore",nname:"lotus",imgid:"cta_lotus.gif",twt2:"bosslotus_"},skaar:{fname:"Skaar Deathrune",sname:"Deathrune",nname:"skaar",imgid:"cta_death_",twt2:"death_",deadimg:"cta_death_dead.gif"},serps:{fname:"Any Serpent",sname:"Serpent",nname:"seamonster",imgid:"twitter_seamonster_",twt2:"sea_"},eserp:{fname:"Emerald Serpent",sname:"Emerald Serpent",nname:"greenseamonster",imgid:"twitter_seamonster_green_1",twt2:"sea_"},sserp:{fname:"Saphire Serpent",sname:"Saphire Serpent",
nname:"blueseamonster",imgid:"twitter_seamonster_blue_1",twt2:"sea_"},aserp:{fname:"Amethyst Serpent",sname:"Amethyst Serpent",nname:"purpleseamonster",imgid:"twitter_seamonster_purple_1",twt2:"sea_"},rserp:{fname:"Ancient Serpent",sname:"Ancient Serpent",nname:"redseamonster",imgid:"twitter_seamonster_red_1",twt2:"sea_"},drags:{fname:"Any Dragon",sname:"Dragon",nname:"drag",imgid:"_dragon.gif",twt2:"dragon_"},edrag:{fname:"Emerald Dragon",sname:"Emerald Dragon",nname:"greendragon",imgid:"cta_green_dragon.gif",
twt2:"dragon_"},fdrag:{fname:"Frost Dragon",sname:"Frost Dragon",nname:"bluedragon",imgid:"cta_blue_dragon.gif",twt2:"dragon_"},gdrag:{fname:"Gold Dragon",sname:"Gold Dragon",nname:"yellowdragon",imgid:'cta_yellow_dragon.gif"',twt2:"dragon_"},rdrag:{fname:"Ancient Red Dragon",sname:"Red Dragon",nname:"reddragon",imgid:"cta_red_dragon.gif",twt2:"dragon_"},deas:{fname:"Any Deathrune Raid",sname:"Deathrune Raid",nname:"deathrune",imgid:"raid_deathrune_",twt2:"deathrune_"},a1dea:{fname:"Deathrune Raid I Part 1",
sname:"Deathrune Raid A1",nname:"deathrunea1",imgid:"raid_deathrune_a1.gif",twt2:"deathrune_"},a2dea:{fname:"Deathrune Raid I Part 2",sname:"Deathrune Raid A2",nname:"deathrunea2",imgid:"raid_deathrune_a2.gif",twt2:"deathrune_"},b1dea:{fname:"Deathrune Raid II Part 1",sname:"Deathrune Raid B1",nname:"deathruneb1",imgid:"raid_deathrune_b1.gif",twt2:"deathrune_"},b2dea:{fname:"Deathrune Raid II Part 2",sname:"Deathrune Raid B2",nname:"deathruneb2",imgid:"raid_deathrune_b2.gif",twt2:"deathrune_"}},monstGroups:{doaid:{monst:"legio~hydra~earth~ice~sylva~skaar~a1dea~a2dea~b1dea~b2dea"},
world:{monst:"legio~hydra~earth~ice",max:"5"},serps:{monst:"eserp~sserp~aserp~rserp"},drags:{monst:"edrag~fdrag~gdrag~rdrag"},deas:{monst:"a1dea~a2dea~b1dea~b2dea"},elems:{monst:"earth~ice"}},MonsterFinder:function(){if(!gm.getValue("MonsterFinderUse",false)||this.stats.stamina.num<gm.getValue("MonsterFinderMinStam",20)||this.stats.health.num<10)return false;if(gm.getValue("urlix","").replace("~","")===""&&gm.getValue("mfStatus","")!="OpenMonster"&&caap.WhileSinceDidIt("clearedMonsterFinderLinks",
86400)){gm.setValue("mfStatus","");gm.log("Resetting monster finder history");this.clearLinks()}gm.log("All checks passed to enter Monster Finder");if(window.location.href.indexOf("filter=app_46755028429")<0){var c=gm.getValue("mfStatus","");if(c=="OpenMonster"){caap.CheckMonster();return true}else if(c=="MonsterFound"){caap.VisitUrl("http://apps.facebook.com/castle_age"+gm.getValue("navLink"));gm.setValue("mfStatus","");return true}else if(c=="TestMonster"&&this.WhileSinceDidIt("checkedFeed",7200)||
!this.WhileSinceDidIt("checkedFeed",60*gm.getValue("MonsterFinderFeedMin",5)))caap.selectMonst();else{global.is_chrome?caap.VisitUrl("http://apps.facebook.com/?filter=app_46755028429&show_hidden=true&ignore_self=true&sk=lf",0):caap.VisitUrl("http://www.facebook.com/?filter=app_46755028429&show_hidden=true&ignore_self=true&sk=lf",0);gm.setValue("mfStatus","MFOFB");return false}}},MonsterFinderOnFB:function(){if(gm.getValue("mfStatus","")!="MFOFB")return false;gm.setValue("mfStatus","Running");gm.setValue("delayPer",
1E4);gm.setValue("iterations",2);gm.setValue("iterationsRun",0);gm.log("Set mostRecentFeed");this.JustDidIt("checkedFeed");gm.setValue("monstersExhausted",false);this.bottomScroll()},CheckMonster:function(){if(gm.getValue("mfStatus")!="OpenMonster")return false;gm.log("Checking Monster: "+gm.getValue("navLink"));this.mf_attackButton=this.CheckForImage("attack_monster_button.jpg");if(!this.mf_attackButton){this.mf_attackButton=this.CheckForImage("seamonster_power.gif");if(!this.mf_attackButton){this.mf_attackButton=
this.CheckForImage("attack_monster_button2.jpg");if(!this.mf_attackButton){this.mf_attackButton=this.CheckForImage("seamonster_power.gif");if(!this.mf_attackButton){this.mf_attackButton=this.CheckForImage("attack_monster_button.jpg");if(!this.mf_attackButton){this.mf_attackButton=this.CheckForImage("event_attack1.gif");if(!this.mf_attackButton){this.mf_attackButton=this.CheckForImage("event_attack2.gif");if(!this.mf_attackButton)this.mf_attackButton=this.CheckForImage("raid_attack_button.gif")}}}}}}if(this.mf_attackButton){var c=
this.CheckResults_viewFight();gm.log("Found Attack Button.  Dam: "+c);if(c){gm.log("Already attacked this monster, find new one");gm.setValue("urlixc",gm.getValue("urlixc","~")+"~"+gm.getValue("navLink").replace("http://apps.facebook.com/castle_age",""));gm.setValue("mfStatus","TestMonster");gm.setValue("waitMonsterLoad",0);return true}else{gm.log("No Damage to monster, Attacking");caap.Click(this.mf_attackButton);window.setTimeout(function(){gm.log("Hand off to Monsters section");gm.setValue("urlixc",
gm.getValue("urlixc","~")+"~"+gm.getValue("navLink").replace("http://apps.facebook.com/castle_age",""));gm.setValue("mfStatus","MonsterFound");gm.setValue("navLink","");caap.NavigateTo("battle_monster");gm.log("Navigate to battle_monster");window.setTimeout(function(){gm.setValue("resetselectMonster",true);gm.setValue("LastAction","Idle");gm.log("resetselectMonster");return true},4E3)},4E3);return false}}else{gm.log("No Attack Button");if(gm.getValue("waitMonsterLoad",0)<2){gm.log("No Attack Button, Pass"+
gm.getValue("waitMonsterLoad"));gm.setValue("waitMonsterLoad",gm.getValue("waitMonsterLoad",0)+1);gm.setValue("LastAction","Idle")}else{gm.log("No Attack Button, Find New Monster");gm.setValue("urlixc",gm.getValue("urlixc","~")+gm.getValue("navLink").replace("http://apps.facebook.com/castle_age",""));gm.setValue("mfStatus","TestMonster");gm.setValue("waitMonsterLoad",0)}return true}},mfMain:function(){gm.log("Do Stuff "+new Date);gm.getValue("urlix","")===""&&this.clearLinks();this.handleCTA();gm.log("Scroll Up");
nHtml.ScrollToTop();gm.log("Select Monster");this.selectMonst()},redirectLinks:function(){for(var c=0;c<document.getElementsByTagName("a").length;c+=1)document.getElementsByTagName("a")[c].target="child_frame"},bottomScroll:function(){nHtml.ScrollToBottom();nHtml.setTimeout(function(){caap.olderPosts()},gm.getValue("delayPer",6E4))},olderPosts:function(){var c=gm.getValue("iterationsRun",0);if(c>0){var b=nHtml.FindByAttrContains(document,"a","class","PagerMoreLink");if(b){gm.log("Showing more ...");
caap.Click(b);gm.log("Link clicked.")}else gm.log("PagerMoreLink not found!")}gm.setValue("iterationsRun",c+=1);gm.log("Get More Iterations "+gm.getValue("iterationsRun")+" of "+gm.getValue("iterations")+" "+new Date);gm.getValue("iterationsRun")<gm.getValue("iterations")?nHtml.setTimeout(function(){caap.bottomScroll()},gm.getValue("delayPer",6E4)):nHtml.setTimeout(function(){caap.mfMain()},gm.getValue("delayPer",12E4))},selectMonst:function(){if(gm.getValue("monstersExhausted",false)===true)return false;
gm.log("Select Monst Function");var c=gm.getValue("MonsterFinderOrder");gm.log("Monst Priority: "+c);c=c.split("~");gm.log("MonstArray: "+c[0]);for(var b=0;b<c.length;b+=1){gm.getValue(c[b],"~")=="~"&&gm.setValue(c[b],"~");gm.log("monstArray[x]: "+c[b]);var d=c[b],e=gm.getValue(c[b],"~").replace(/~~/g,"~").split("~"),f=0;gm.log("Inside MonstArray For Loop "+c[b]+" - Array["+(e.length-1)+"] "+gm.getValue(c[b]).replace("~","~\n"));for(var i=0;i<e.length;i+=1)if(e[i]){var h=e[i].replace("http://apps.facebook.com/castle_age",
"");if(gm.getValue("urlixc","~").indexOf(h)==-1){gm.log("Navigating to Monst: "+c[b]+"  Link: "+h);h="http://apps.facebook.com/castle_age"+h;gm.setValue("navLink",h);gm.setValue("clickUrl",h);this.VisitUrl(h);gm.setValue("mfStatus","OpenMonster");gm.setValue("LastAction","Monsters");this.waitMilliSecs=1E4;return true}else{f+=1;gm.log("Trimming already checked URL, Monst Type: "+d);gm.setValue(d,gm.getValue(d).replace("~"+h,"").replace(/~~/g,"~"),"~")}}gm.log("Links Already Visited: "+c[b]+" #:"+f)}gm.log("All Monsters Tested");
gm.setValue("monstersExhausted",true);gm.setValue("mfStatus","");c=gm.getValue("urlix","~");if(nHtml.CountInstances(c)>100){gm.log("Idle- Resetting Monster Searcher Values, #-"+c);caap.clearLinks(true);gm.setValue("LastAction","")}gm.setValue("clickUrl","http://apps.facebook.com/castle_age/index.php?bm=1");this.VisitUrl("http://apps.facebook.com/castle_age/index.php?bm=1");return false},clearLinks:function(c){gm.log("Clear Links");if(c===true){gm.setValue("navLink","");gm.setValue("mfStatus","");
gm.setValue("waitMonsterLoad",0);gm.setValue("urlixc","~")}gm.setValue("urlix","~");gm.setValue("doaid","~");gm.setValue("legio","~");gm.setValue("hydra","~");gm.setValue("earth","~");gm.setValue("ice","~");gm.setValue("kull","~");gm.setValue("gilda","~");gm.setValue("colos","~");gm.setValue("sylva","~");gm.setValue("mephi","~");gm.setValue("keira","~");gm.setValue("lotus","~");gm.setValue("skaar","~");gm.setValue("serps","~");gm.setValue("eserp","~");gm.setValue("sserp","~");gm.setValue("aserp",
"~");gm.setValue("rserp","~");gm.setValue("drags","~");gm.setValue("edrag","~");gm.setValue("fdrag","~");gm.setValue("gdrag","~");gm.setValue("rdrag","~");gm.setValue("deas","~");gm.setValue("a1dea","~");gm.setValue("a2dea","~");gm.setValue("b1dea","~");gm.setValue("b2dea","~");this.JustDidIt("clearedMonsterFinderLinks")},handleCTA:function(){var c=nHtml.getX("//div[@class='GenericStory_Body']",document,nHtml.xpath.unordered);gm.log("Number of entries- "+c.snapshotLength);for(var b=0;b<c.snapshotLength;b+=
1){var d=nHtml.getX("./div[2]/div/div/a/@href",c.snapshotItem(b),nHtml.xpath.string).replace("http://apps.facebook.com/castle_age",""),e=nHtml.Gup("user",d),f=nHtml.Gup("mpool",d),i=nHtml.Gup("action",d),h=nHtml.getX("./div[2]/div/div/a/div/img/@src",c.snapshotItem(b),nHtml.xpath.string);nHtml.getX("./form/span/span/a/abbr/@title",c.snapshotItem(b),nHtml.xpath.string);var g="",k=gm.getValue("urlixc","~");if(h)if(!(k.indexOf(d)>=0))if(h.indexOf("cta_hydra_")>=0||h.indexOf("twitter_hydra_objective")>=
0){g=gm.getValue("hydra","~");g.indexOf(d)==-1&&gm.setValue("hydra",gm.getValue("hydra","")+"~"+d)}else if(h.indexOf("cta_castle_")>=0){g=gm.getValue("legio","~");g.indexOf(d)==-1&&gm.setValue("legio",gm.getValue("legio","")+"~"+d)}else if(h.indexOf("cta_earth_")>=0){g=gm.getValue("earth","~");g.indexOf(d)==-1&&gm.setValue("earth",gm.getValue("earth","")+"~"+d)}else if(h.indexOf("cta_water_")>=0){g=gm.getValue("ice","~");g.indexOf(d)==-1&&gm.setValue("ice",gm.getValue("ice","")+"~"+d)}else if(h.indexOf("raid_deathrune_")>=
0){g=gm.getValue("deas","~");g.indexOf(d)==-1&&gm.setValue("deas",gm.getValue("deas","")+"~"+d);if(h.indexOf("raid_deathrune_a1.gif")>=0){g=gm.getValue("a1dea","~");g.indexOf(d)==-1&&gm.setValue("a1dea",gm.getValue("a1dea","")+"~"+d)}else if(h.indexOf("raid_deathrune_a2.gif")>=0){g=gm.getValue("a2dea","~");g.indexOf(d)==-1&&gm.setValue("a2dea",gm.getValue("a2dea","")+"~"+d)}else if(h.indexOf("raid_deathrune_b1.gif")>=0){g=gm.getValue("b1dea","~");g.indexOf(d)==-1&&gm.setValue("b1dea",gm.getValue("b1dea",
"")+"~"+d)}else if(h.indexOf("raid_deathrune_b2.gif")>=0){g=gm.getValue("b2dea","~");g.indexOf(d)==-1&&gm.setValue("b2dea",gm.getValue("b2dea","")+"~"+d)}}else if(h.indexOf("_dragon.gif")>=0){g=gm.getValue("drags","~");g.indexOf(d)==-1&&gm.setValue("drags",gm.getValue("drags","")+"~"+d);if(h.indexOf("cta_red_dragon.gif")>=0){g=gm.getValue("rdrag","~");g.indexOf(d)==-1&&gm.setValue("rdrag",gm.getValue("rdrag","")+"~"+d)}else if(h.indexOf("cta_yellow_dragon.gif")>=0){g=gm.getValue("gdrag","~");g.indexOf(d)==
-1&&gm.setValue("gdrag",gm.getValue("gdrag","")+"~"+d)}else if(h.indexOf("cta_blue_dragon.gif")>=0){g=gm.getValue("fdrag","~");g.indexOf(d)==-1&&gm.setValue("fdrag",gm.getValue("fdrag","")+"~"+d)}else if(h.indexOf("cta_green_dragon.gif")>=0){g=gm.getValue("edrag","~");g.indexOf(d)==-1&&gm.setValue("edrag",gm.getValue("edrag","")+"~"+d)}}else if(h.indexOf("twitter_seamonster_")>=0&&h.indexOf("_1.jpg")>=0){g=gm.getValue("serps","~");g.indexOf(d)==-1&&gm.setValue("serps",gm.getValue("serps","")+"~"+
d);if(h.indexOf("twitter_seamonster_purple_1")>=0){g=gm.getValue("aserp","~");g.indexOf(d)==-1&&gm.setValue("aserp",gm.getValue("aserp","")+"~"+d)}else if(h.indexOf("twitter_seamonster_red_1")>=0){g=gm.getValue("rserp","~");g.indexOf(d)==-1&&gm.setValue("rserp",gm.getValue("rserp","")+"~"+d)}else if(h.indexOf("twitter_seamonster_blue_1")>=0){g=gm.getValue("sserp","~");g.indexOf(d)==-1&&gm.setValue("sserp",gm.getValue("sserp","")+"~"+d)}else if(h.indexOf("twitter_seamonster_green_1")>=0){g=gm.getValue("eserp",
"~");g.indexOf(d)==-1&&gm.setValue("eserp",gm.getValue("eserp","")+"~"+d)}}else if(h.indexOf("cta_death")>=0&&h.indexOf("cta_death_dead.gif")==-1){g=gm.getValue("skaar","~");g.indexOf(d)==-1&&gm.setValue("skaar",gm.getValue("skaar","")+"~"+d)}else if(h.indexOf("cta_lotus.gif")>=0){g=gm.getValue("lotus","~");g.indexOf(d)==-1&&gm.setValue("lotus",gm.getValue("lotus","")+"~"+d)}else if(h.indexOf("cta_keira.gif")>=0){g=gm.getValue("keira","~");g.indexOf(d)==-1&&gm.setValue("keira",gm.getValue("keira",
"")+"~"+d)}else if(h.indexOf("cta_mephi.gif")>=0){g=gm.getValue("mephi","~");g.indexOf(d)==-1&&gm.setValue("mephi",gm.getValue("mephi","")+"~"+d)}else if(h.indexOf("cta_sylvanas.gif")>=0){g=gm.getValue("sylva","~");g.indexOf(d)==-1&&gm.setValue("sylva",gm.getValue("sylva","")+"~"+d)}else if(h.indexOf("cta_stone.gif")>=0){g=gm.getValue("colos","~");g.indexOf(d)==-1&&gm.setValue("colos",gm.getValue("colos","")+"~"+d)}else if(h.indexOf("cta_orc_king.gif")>=0){g=gm.getValue("gilda","~");g.indexOf(d)==
-1&&gm.setValue("gilda",gm.getValue("gilda","")+"~"+d)}else if(h.indexOf("cta_orc_captain.gif")>=0){g=gm.getValue("kull","~");g.indexOf(d)==-1&&gm.setValue("kull",gm.getValue("kull","")+"~"+d)}h=gm.getValue("urlix","~");g=gm.getValue("doaid","~");if(e&&i)if(i=="doObjective")if(k.indexOf(d)==-1&&g.indexOf(d)==-1){g+="~"+d;gm.setValue("doaid",g)}if(e&&f)if(k.indexOf(d)==-1&&h.indexOf(d)==-1){h+="~"+d;gm.setValue("urlix",h)}}gm.log("Completed Url Handling");this.JustDidIt("checkedFeed")},AutoPotions:function(){try{if(!gm.getValue("AutoPotion",
true)||!this.WhileSinceDidIt("AutoPotionTimer",21600)||!this.WhileSinceDidIt("AutoPotionTimerDelay",600))return false;if(!nHtml.FindByAttr(document.body,"div","class","statsTTitle")){gm.log("Going to keep for potions");if(this.NavigateTo("keep"))return true}gm.log("Checking energy potions");var c=$("img[title='Energy Potion']").parent().next().text().replace(/[^0-9\.]/g,"");c||(c=0);gm.log("Energy Potions: "+c);if(c>=gm.getNumber("energyPotionsSpendOver",40)){gm.setValue("Consume_Energy",true);gm.log("Energy potions ready to consume")}gm.log("Checking stamina potions");
var b=$("img[title='Stamina Potion']").parent().next().text().replace(/[^0-9\.]/g,"");b||(b=0);gm.log("Stamina Potions: "+b);if(b>=gm.getNumber("staminaPotionsSpendOver",40)){gm.setValue("Consume_Stamina",true);gm.log("Stamina potions ready to consume")}gm.log("Checking experience to next level");if((gm.getValue("Consume_Energy",false)||gm.getValue("Consume_Stamina",false))&&this.stats.exp.dif<=gm.getNumber("potionsExperience",20)){gm.log("Not spending potions, experience to next level condition. Delaying 10 minutes");
this.JustDidIt("AutoPotionTimerDelay");return true}if(this.stats.energy.num<this.stats.energy.max-10&&c>gm.getNumber("energyPotionsKeepUnder",35)&&gm.getValue("Consume_Energy",false)){gm.log("Spending energy potions");var d=nHtml.FindByAttr(document.body,"form","id","app46755028429_consume_1");if(d){var e=nHtml.FindByAttrContains(d,"input","src","potion_consume.gif");if(e){gm.log("Consume energy potion");caap.Click(e);return true}else gm.log("Could not find consume energy button")}else gm.log("Could not find energy consume form");
return false}else{gm.setValue("Consume_Energy",false);gm.log("Energy potion conditions not met")}if(this.stats.stamina.num<this.stats.stamina.max-10&&b>gm.getNumber("staminaPotionsKeepUnder",35)&&gm.getValue("Consume_Stamina",false)){gm.log("Spending stamina potions");var f=nHtml.FindByAttr(document.body,"form","id","app46755028429_consume_2");if(f){var i=nHtml.FindByAttrContains(f,"input","src","potion_consume.gif");if(i){gm.log("Consume stamina potion");caap.Click(i);return true}else gm.log("Could not find consume stamina button")}else gm.log("Could not find stamina consume form");
return false}else{gm.setValue("Consume_Stamina",false);gm.log("Stamina potion conditions not met")}this.JustDidIt("AutoPotionTimer");return true}catch(h){gm.log("ERROR in AutoPotion: "+h);return false}},AutoAlchemy:function(){try{if(!gm.getValue("AutoAlchemy",false))return false;if(!this.CheckTimer("AlchemyTimer"))return false;if(!this.NavigateTo("keep,alchemy","alchemy_banner.jpg")){var c=null;if(document.getElementById("app46755028429_recipe_list").className!="show_items")if(c=nHtml.FindByAttrContains(document.body,
"div","id","alchemy_item_tab")){this.Click(c,5E3);return true}else{gm.log("Cant find recipe div");return false}if(c=this.CheckForImage("help_close_x.gif")){this.Click(c,1E3);return true}for(var b=document.evaluate(".//div[@class='alchemyRecipeBack']",document.body,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),d=0;d<b.snapshotLength;d+=1){var e=b.snapshotItem(d);if(!nHtml.FindByAttrContains(e,"div","class","missing"))if(this.CheckForImage("raid_hearts",e)&&!gm.getValue("AutoAlchemyHearts",false))gm.log("Skipping Hearts");
else if(c=nHtml.FindByAttrXPath(e,"input","@type='image'")){this.Click(c,2E3);return true}else gm.log("Cant Find Item Image Button")}this.SetTimer("AlchemyTimer",10800);return false}}catch(f){gm.log("ERROR in Alchemy: "+f);return false}},ImmediateBanking:function(){if(!gm.getValue("BankImmed"))return false;return this.Bank()},Bank:function(){var c=gm.getNumber("MaxInCash",-1),b=gm.getNumber("MinInCash",0);if(!c||c<0||this.stats.cash<=b||this.stats.cash<c||this.stats.cash<10)return false;if(this.SelectGeneral("BankingGeneral"))return true;
c=this.CheckForImage("btn_stash.gif");if(!c)return this.NavigateTo("keep");var d=nHtml.FindByAttrXPath(c.form,"input","@type='' or @type='text'");if(d)d.value=parseInt(d.value,10)-b;else{gm.log("Cannot find box to put in number for bank deposit.");return false}gm.log("Depositing into bank");this.Click(c);return true},RetrieveFromBank:function(c){if(c<=0)return false;var b=this.CheckForImage("btn_retrieve.gif");if(!b)return this.NavigateTo("keep");var d=gm.getNumber("minInStore",0);if(!(d||d<=gm.getNumber("inStore",
0)-c))return false;if(d=nHtml.FindByAttrXPath(b.form,"input","@type='' or @type='text'"))d.value=c;else{gm.log("Cannot find box to put in number for bank retrieve.");return false}gm.log("Retrieving "+c+" from bank");gm.setValue("storeRetrieve","");this.Click(b);return true},Heal:function(){this.SetDivContent("heal_mess","");var c=gm.getNumber("MinToHeal",0);if(!c)return false;var b=gm.getNumber("MinStamToHeal",0);if(b==="")b=0;if(!this.stats.health)return false;if(gm.getValue("WhenBattle","")!="Never"||
gm.getValue("WhenMonster","")!="Never")if((this.InLevelUpMode()||this.stats.stamina.num>=this.stats.stamina.max)&&this.stats.health.num<10){gm.log("Heal");return this.NavigateTo("keep,heal_button.gif")}if(this.stats.health.num>=this.stats.health.max||this.stats.health.num>c)return false;if(this.stats.stamina.num<b){this.SetDivContent("heal_mess","Waiting for stamina to heal: "+this.stats.stamina.num+"/"+b);return false}gm.log("Heal");return this.NavigateTo("keep,heal_button.gif")},AutoElite:function(){if(!gm.getValue("AutoElite",
false)||!this.WhileSinceDidIt("AutoEliteGetList",21600))return false;if(String(window.location).indexOf("party.php")){var c=nHtml.FindByAttrContains(document.body,"span","class","result_body");if(c){c=nHtml.GetText(c);if(c.match(/Your Elite Guard is FULL/i)){gm.setValue("MyEliteTodo","");gm.log("elite guard is full");this.JustDidIt("AutoEliteGetList");gm.setValue("AutoEliteEnd","Full");return false}}}c="";var b=gm.getValue("MyEliteTodo","").trim();if(b==="")if(this.CheckForImage("view_army_on.gif")){gm.log("load auto elite list");
b=gm.getValue("EliteArmyList","");if(/[^0-9,]/.test(b)&&/\n/.test(b))b=b.replace(/\n/gi,",");if(b!=="")b+=",";for(var d=document.evaluate(".//img[contains(@src,'view_friends_profile')]/ancestor::a[contains(@href,'keep.php?user')]",document.body,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),e=0;e<d.snapshotLength;e+=1)if(c=d.snapshotItem(e).href.match(/user=\d+/i))b+=String(c).substr(5)+",";if(b!==""||this.stats.army<=1)gm.setValue("MyEliteTodo",b)}else return this.NavigateTo("army,army_member");
else if(this.WhileSinceDidIt("AutoEliteReqNext",7)){c=b.substring(0,b.indexOf(","));gm.log("add elite "+c);this.ClickAjax("party.php?twt=jneg&jneg=true&user="+c);b=b.substring(b.indexOf(",")+1);gm.setValue("MyEliteTodo",b);this.JustDidIt("AutoEliteReqNext");if(b===""){this.JustDidIt("AutoEliteGetList");gm.setValue("AutoEliteEnd","NoArmy");gm.log("Army list exhausted")}}return true},ArenaElite:function(){this.WhileSinceDidIt("ArenaEliteTimer",21600)&&gm.setValue("ArenaEliteEnd","");if(!gm.getValue("ArenaEliteNeeded",
false))return false;if(String(window.location).indexOf("arena.php?user=")){var c=nHtml.FindByAttrContains(document.body,"span","class","result_body");if(c){c=nHtml.GetText(c);if(c.match(/You.+Arena Guard is FULL/i)||c.match(/Arena is over/i)){gm.setValue("ArenaEliteTodo","");gm.log("Arena guard is full or Arena is over");gm.setValue("ArenaEliteNeeded",false);gm.setValue("ArenaEliteEnd","Full");return false}}}c="";var b=gm.getValue("ArenaEliteTodo","").trim();if(b==="")if(this.CheckForImage("view_army_on.gif")){gm.log("Load auto elite list");
b=gm.getValue("EliteArmyList","");if(/[^0-9,]/.test(b)&&/\n/.test(b))b=b.replace(/\n/gi,",");if(b!=="")b+=",";for(var d=document.evaluate(".//img[contains(@src,'view_friends_profile')]/ancestor::a[contains(@href,'keep.php?user')]",document.body,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),e=0;e<d.snapshotLength;e+=1)if(c=d.snapshotItem(e).href.match(/user=\d+/i))b+=String(c).substr(5)+",";if(b!==""||this.stats.army<=1)gm.setValue("ArenaEliteTodo",b)}else return this.NavigateTo("army,army_member");
else if(this.WhileSinceDidIt("ArenaEliteReqNext",7)){c=b.substring(0,b.indexOf(","));gm.log("add elite "+c);gm.setValue("clickUrl","http://apps.facebook.com/castle_age/arena.php?user="+c+"&lka="+c+"&agtw=1&ref=nf");this.VisitUrl("http://apps.facebook.com/castle_age/arena.php?user="+c+"&lka="+c+"&agtw=1&ref=nf");b=b.substring(b.indexOf(",")+1);gm.setValue("ArenaEliteTodo",b);this.JustDidIt("ArenaEliteReqNext");if(b===""){gm.setValue("ArenaEliteNeeded",false);gm.setValue("ArenaEliteEnd","NoArmy");this.JustDidIt("ArenaEliteTimer");
gm.log("Army list exhausted")}}return true},PassiveGeneral:function(){if(this.SelectGeneral("IdleGeneral"))return true;gm.setValue("MaxIdleEnergy",this.stats.energy.max);gm.setValue("MaxIdleStamina",this.stats.stamina.max);return false},AutoIncome:function(){if(this.stats.payminute<1&&this.stats.paytime.match(/\d/)&&gm.getValue("IncomeGeneral")!="Use Current"){this.SelectGeneral("IncomeGeneral");return true}return false},CheckResults_army:function(c){if(c.match(/^\d+ requests? sent\.$/)){gm.log("Confirmed gifts sent out.");
gm.setValue("RandomGiftPic","");gm.setValue("FBSendList","")}c=$('div[style="padding: 0pt 0pt 10px 0px; overflow: hidden; float: left; width: 240px; height: 50px;"]').find('a[text="Ignore"]');for(var b=0;b<c.length;b+=1){var d="<br /><a title='This link can be used to collect the gift when it has been lost on Facebook. !!If you accept a gift in this manner then it will leave an orphan request on Facebook!!' href='"+c[b].href.replace("ignore","acpt")+"'>Lost Accept</a>";$(d).insertAfter($('div[style="padding: 0pt 0pt 10px 0px; overflow: hidden; float: left; width: 240px; height: 50px;"]').find("a[href="+
c[b].href+"]"))}},AutoGift:function(){try{if(!gm.getValue("AutoGift"))return false;var c={},b=nHtml.FindByAttrContains(document.body,"div","id","_gift1");if(b){gm.setList("GiftList",[]);var d=document.evaluate(".//div[contains(@id,'_gift')]",b.parentNode,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);for(b=0;b<d.snapshotLength;b+=1){var e=d.snapshotItem(b),f=nHtml.GetText(e).trim().replace(/!/i,"");if(gm.getValue("GiftList").indexOf(f)>=0)f+=" #2";gm.listPush("GiftList",f);c[f]=this.CheckForImage("mystery",
e).src.match(/[\w_\.]+$/i).toString()}if(gm.getValue("GiftChoice")=="Get Gift List"){gm.setValue("GiftChoice","Same Gift As Received");this.SelectDropOption("GiftChoice","Same Gift As Received")}}if(gm.getValue("GiftChoice",false)=="Get Gift List"||!gm.getList("GiftList"))if(this.NavigateTo("army,gift","giftpage_title.jpg"))return true;d=[];if(gm.getValue("HaveGift",false)){if(this.NavigateTo("army","invite_on.gif"))return true;var i=nHtml.FindByAttrContains(document.body,"a","href","reqs.php#confirm_"),
h=nHtml.FindByAttrContains(document.body,"a","href","act=ignore");if(h&&i){d=this.userRe.exec(h.href);if(!d){gm.log("Unable to find giver ID");return false}var g=nHtml.FindByAttrContains(i.parentNode.parentNode,"a","href","profile.php");g||(g=nHtml.FindByAttrContains(i.parentNode.parentNode,"div","style","overflow: hidden; text-align: center; width: 170px;"));c="Unknown";if(g)c=nHtml.GetText(g).trim();gm.setValue("GiftEntry",d[2]+global.vs+c);gm.log("Giver ID = "+d[2]+" Name  = "+c);this.JustDidIt("ClickedFacebookURL");
if(global.is_chrome)i.href="http://apps.facebook.com/reqs.php#confirm_46755028429_0";gm.setValue("clickUrl",i.href);this.VisitUrl(i.href);return true}gm.setValue("HaveGift",false);return this.NavigateTo("gift")}i=null;if(gm.getValue("FBSendList","")){if(i=nHtml.FindByAttrContains(document.body,"input","name","sendit")){gm.log("Sending gifts to Facebook");this.Click(i);return true}gm.listAddBefore("ReceivedList",gm.getList("FBSendList"));gm.setList("FBSendList",[]);if(i=nHtml.FindByAttrContains(document.body,
"input","name","ok")){gm.log("Over max gifts per day");this.JustDidIt("WaitForNextGiftSend");this.Click(i);return true}gm.log("No Facebook pop up to send gifts");return false}if(gm.getValue("CASendList","")){var k=nHtml.FindByAttrContains(document.body,"form","id","req_form_");if(k)if(i=nHtml.FindByAttrContains(k,"input","name","send")){gm.log("Clicked CA send gift button");gm.listAddBefore("FBSendList",gm.getList("CASendList"));gm.setList("CASendList",[]);caap.Click(i);return true}gm.log("No CA button to send gifts");
gm.listAddBefore("ReceivedList",gm.getList("CASendList"));gm.setList("CASendList",[]);return false}if(!this.WhileSinceDidIt("WaitForNextGiftSend",10800))return false;if(this.WhileSinceDidIt("WaitForNotFoundIDs",10800)&&gm.getList("NotFoundIDs")){gm.listAddBefore("ReceivedList",gm.getList("NotFoundIDs"));gm.setList("NotFoundIDs",[])}if(gm.getValue("DisableGiftReturn",false)||global.is_chrome)gm.setList("ReceivedList",[]);var j=gm.getList("ReceivedList");if(!j.length)return false;if(this.NavigateTo("army,gift",
"giftpage_title.jpg"))return true;if(c.length===0){gm.log("No list of pictures for gift choices");return false}g=i="";var m=gm.getValue("GiftChoice");k=null;switch(m){case "Random Gift":if(g=gm.getValue("RandomGiftPic"))break;var l=Math.floor(Math.random()*gm.getList("GiftList").length);k=0;for(var n in c)if(c.hasOwnProperty(n)){k+=1;if(k==l){g=c[n];gm.setValue("RandomGiftPic",g);break}}if(!g){gm.log("No gift type match. GiverList: "+j);return false}break;case "Same Gift As Received":i=j[0].split(global.vs)[2];
k=gm.getList("GiftList");gm.log("Looking for same gift as "+i);if(k.indexOf(i)<0){gm.log("No gift type match. Using first gift as default.");i=gm.getList("GiftList").shift()}g=c[i];break;default:g=c[gm.getValue("GiftChoice")];break}var r=this.CheckForImage(g);if(r)gm.log("GiftPic is "+g);else{gm.log("Unable to find "+g);return false}if(nHtml.FindByAttrContains(r.parentNode.parentNode.parentNode.parentNode,"div","style","giftpage_select")){if(this.NavigateTo("giftpage_ca_friends_off.gif","giftpage_ca_friends_on.gif"))return true}else{this.NavigateTo("gift_more_gifts.gif");
return this.NavigateTo(g)}var p=nHtml.FindByAttrContains(document.body,"div","class","unselected_list"),q=nHtml.FindByAttrContains(document.body,"div","class","selected_list");gm.setList("ReceivedList",[]);for(var s in j)if(j.hasOwnProperty(s))if(s>10)gm.listPush("ReceivedList",j[s]);else{var o=j[s].split(global.vs),t=o[0],v=o[2];if(m=="Same Gift As Received"&&v!=i&&v!="Unknown Gift"){gm.log("giftType "+v+" givenGiftType "+i);gm.listPush("ReceivedList",j[s])}else{var u=nHtml.FindByAttrContains(p,
"input","value",t);if(u){gm.log("Clicking giver ID "+t);this.Click(u);if(nHtml.FindByAttrContains(q,"input","value",t)){gm.listPush("CASendList",j[s]);gm.log("Moved ID "+t)}else{gm.log("NOT moved ID "+t);gm.listPush("NotFoundIDs",j[s]);this.JustDidIt("WaitForNotFoundIDs")}}else{gm.log("Unable to find giver ID "+t);gm.listPush("NotFoundIDs",j[s]);this.JustDidIt("WaitForNotFoundIDs")}}}return true}catch(w){gm.log("ERROR in AutoGift: "+w);return false}},AcceptGiftOnFB:function(){try{if(global.is_chrome){if(window.location.href.indexOf("apps.facebook.com/reqs.php")<
0&&window.location.href.indexOf("apps.facebook.com/home.php")<0)return false}else if(window.location.href.indexOf("www.facebook.com/reqs.php")<0&&window.location.href.indexOf("www.facebook.com/home.php")<0)return false;var c=gm.getValue("GiftEntry","");if(!c)return false;gm.log("On FB page with gift ready to go");if(window.location.href.indexOf("facebook.com/reqs.php")>=0)for(var b=document.evaluate(".//input[contains(@name,'/castle/tracker.php')]",document.body,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,
null),d=0;d<b.snapshotLength;d+=1){var e=b.snapshotItem(d),f=e.name.match(/uid%3D\d+/i);if(f){f=String(f).substr(6);if(f==this.NumberOnly(c)){var i=e.value.replace(/^Accept /i,"").trim();if(gm.getList("GiftList").indexOf(i)<0){gm.log("Unknown gift type.");i="Unknown Gift"}gm.getValue("ReceivedList"," ").indexOf(c)<0&&gm.listPush("ReceivedList",c+global.vs+i);gm.log("This giver: "+f+" gave "+i+" Givers: "+gm.getList("ReceivedList"));caap.Click(e);gm.setValue("GiftEntry","");return true}}}if(!this.WhileSinceDidIt("ClickedFacebookURL",
10))return false;gm.log("Error: unable to find gift");gm.getValue("ReceivedList"," ").indexOf(c)<0&&gm.listPush("ReceivedList",c+"\tUnknown Gift");caap.VisitUrl("http://apps.facebook.com/castle_age/army.php?act=acpt&uid="+this.NumberOnly(c));gm.setValue("GiftEntry","");return true}catch(h){gm.log("ERROR in AcceptGiftOnFB: "+h);return false}},ImmediateAutoStat:function(){if(!gm.getValue("StatImmed")||!gm.getValue("AutoStat"))return false;return caap.AutoStat()},IncreaseStat:function(c,b,d){try{var e=
c.toLowerCase();c="";switch(e){case "energy":c=nHtml.FindByAttrContains(d,"a","href","energy_max");break;case "stamina":c=nHtml.FindByAttrContains(d,"a","href","stamina_max");break;case "attack":c=nHtml.FindByAttrContains(d,"a","href","attack");break;case "defense":c=nHtml.FindByAttrContains(d,"a","href","defense");break;case "health":c=nHtml.FindByAttrContains(d,"a","href","health_max");break;default:gm.log("Unable to identify attribute "+e);return"Fail"}if(!c){gm.log("Unable to locate upgrade button for "+
e);return"Fail"}var f=this.stats.level,i=parseInt(c.parentNode.parentNode.childNodes[3].firstChild.data.replace(/[^0-9]/g,""),10);parseInt(nHtml.FindByAttrContains(d,"a","href","energy_max").parentNode.parentNode.childNodes[3].firstChild.data.replace(/[^0-9]/g,""),10);parseInt(nHtml.FindByAttrContains(d,"a","href","stamina_max").parentNode.parentNode.childNodes[3].firstChild.data.replace(/[^0-9]/g,""),10);if(f>=10){parseInt(nHtml.FindByAttrContains(d,"a","href","attack").parentNode.parentNode.childNodes[3].firstChild.data.replace(/[^0-9]/g,
""),10);parseInt(nHtml.FindByAttrContains(d,"a","href","defense").parentNode.parentNode.childNodes[3].firstChild.data.replace(/[^0-9]/g,""),10);parseInt(nHtml.FindByAttrContains(d,"a","href","health_max").parentNode.parentNode.childNodes[3].firstChild.data.replace(/[^0-9]/g,""),10)}var h=nHtml.FindByAttrContains(document.body,"div","id","app46755028429_AjaxLoadIcon");if(!h||h.style.display!=="none"){gm.log("Unable to find AjaxLoadIcon?");return"Fail"}if(e=="stamina"&&this.statsPoints<2){gm.setValue("SkillPointsNeed",
2);return"Fail"}gm.setValue("SkillPointsNeed",1);d=b;f=" "+b;if(gm.getValue("AutoStatAdv",false)){d=eval(b);f=" ("+b+")="+d}if(d>i){gm.log("Status Before:  "+e+"="+i+" Adjusting To:"+f);this.Click(c);return"Click"}return"Next"}catch(g){gm.log("ERROR in IncreaseStat: "+g);return"Fail"}},AutoStatRuleLog:true,AutoStat:function(){try{if(!gm.getValue("AutoStat"))return false;if(!gm.getValue("statsMatch",true)){if(this.AutoStatRuleLog){gm.log("User should change their stats rules");this.AutoStatRuleLog=
false}return false}var c=document.getElementById("app46755028429_main_bntp");if(!c)return false;var b=nHtml.FindByAttrContains(c,"a","href","keep.php");if(!b)return false;this.statsPoints=b.firstChild.firstChild.data.replace(/[^0-9]/g,"");if(!this.statsPoints||this.statsPoints<gm.getValue("SkillPointsNeed",1))return false;var d=nHtml.FindByAttrContains(document.body,"div","class","keep_attribute_section");if(!d){this.NavigateTo("keep");return true}for(c=1;c<=5;c+=1)if(gm.getValue("Attribute"+c,"")!==
""){if(this.stats.level<10)if(gm.getValue("Attribute"+c,"")==="Attack"||gm.getValue("Attribute"+c,"")==="Defense")continue;switch(this.IncreaseStat(gm.getValue("Attribute"+c,""),gm.getValue("AttrValue"+c,0),d)){case "Next":continue;case "Click":return true;default:return false}}gm.log("No rules match to increase stats");gm.setValue("statsMatch",false);return false}catch(e){gm.log("ERROR in AutoStat: "+e);return false}},AutoCollectMA:function(){try{if(!gm.getValue("AutoCollectMA",true)||!this.WhileSinceDidIt("AutoCollectMATimer",
86700))return false;gm.log("Collecting Master and Apprentice reward");caap.SetDivContent("idle_mess","Collect MA Reward");var c=nHtml.FindByAttrContains(document.body,"img","src","ma_view_progress_main"),b=nHtml.FindByAttrContains(document.body,"img","src","ma_main_learn_more");if(!c&&!b){gm.log("Going to home");if(this.NavigateTo("index"))return true}if(c){this.Click(c);caap.SetDivContent("idle_mess","Collected MA Reward");gm.log("Collected Master and Apprentice reward")}if(!c&&b){caap.SetDivContent("idle_mess",
"No MA Rewards");gm.log("No Master and Apprentice rewards")}window.setTimeout(function(){caap.SetDivContent("idle_mess","")},5E3);this.JustDidIt("AutoCollectMATimer");gm.log("Collect Master and Apprentice reward completed");return true}catch(d){gm.log("ERROR in AutoCollectMA: "+d);return false}},Idle:function(){caap.WhileSinceDidIt("clearedMonsterFinderLinks",259200)&&this.clearLinks(true);try{if(gm.getValue("FillArmy",false)){if(this.CheckForImage("invite_on.gif")){gm.log("Getting FB friends");var c=
"//div[@class='unselected_list']//label[@class='clearfix']",b=document.evaluate(c,document,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),d=0;for(c=[];b.snapshotItem(d)!==null;){var e=b.snapshotItem(d);c[c.length]=e.firstChild.value;d+=1}var f=[],i=0;if(!gm.getValue("waiting",false)){gm.log("Getting CA friend's list");gm.setValue("waiting",true);window.setTimeout(function(){gm.deleteValue("waiting")},1E4);GM_xmlhttpRequest({url:"http://apps.facebook.com/castle_age/gift.php?app_friends=false&giftSelection=1",
method:"GET",onload:function(g){var k=g.responseText.match(/(exclude_ids=")[\-0-9,]*"/);if(g.status==200&&k){gm.deleteValue("waiting");gm.log(g.statusText);g=k.toString().replace(/[^0-9,]/g,"").split(",");for(var j in c)if(c.hasOwnProperty(j))for(var m in g)if(g.hasOwnProperty(m))if(g[m]==c[j]){f[i+=1]=c[j];break}var l=0;j=gm.getValue("ArmyCount",0);j===0&&gm.log("Adding "+f.length+" member");for(caap.SetDivContent("idle_mess","Filling Army, Please wait..."+j+"/"+f.length);j<f.length;j+=1){caap.SetDivContent("idle_mess",
"Filling Army, Please wait..."+j+"/"+f.length);if(l>=5){this.waitMilliSecs=1E3;break}else{l+=1;GM_xmlhttpRequest({url:"http://apps.facebook.com/castle_age/index.php?tp=cht&lka="+f[j]+"&buf=1",method:"GET",onload:function(n){l-=1;n.status!=200&&GM_log([n.status,n.finalUrl].join("\n"))}});gm.setValue("ArmyCount",j)}}if(j>=f.length){caap.SetDivContent("idle_mess","<b>Fill Army Completed</b>");window.setTimeout(function(){caap.SetDivContent("idle_mess","")},5E3);gm.log("Fill Army Completed");gm.setValue("FillArmy",
false);gm.deleteValue("ArmyCount");gm.deleteValue("waiting")}}else{caap.SetDivContent("idle_mess","<b>Fill Army Failed</b>");window.setTimeout(function(){caap.SetDivContent("idle_mess","")},5E3);gm.log("Fill Army Not Completed, cant get CA friends list");gm.log("Response.status: "+g.statusText);gm.setValue("FillArmy",false);gm.deleteValue("ArmyCount");gm.deleteValue("waiting")}}})}}else{caap.SetDivContent("idle_mess","Filling Army");this.NavigateTo("army")}return true}}catch(h){gm.log("ERROR in FillArmy: "+
h);caap.SetDivContent("idle_mess","<b>Fill Army Failed</b>");window.setTimeout(function(){caap.SetDivContent("idle_mess","")},5E3);gm.setValue("FillArmy",false);gm.deleteValue("ArmyCount");gm.deleteValue("waiting")}this.AutoCollectMA();this.ReconPlayers();this.UpdateDashboard();gm.setValue("ReleaseControl",true);return true},ReconPlayers:function(){try{if(!gm.getValue("DoPlayerRecon",false))return false;if(this.stats.stamina.num<=0)return false;if(!this.CheckTimer("PlayerReconTimer"))return false;
this.SetDivContent("idle_mess","Player Recon: Starting");if(!document.getElementById("iframeRecon")){nHtml.OpenInIFrame("http://apps.facebook.com/castle_age/battle.php#iframeRecon","iframeRecon");gm.log("Opening the recon iframe");this.SetTimer("PlayerReconTimer",30);return true}var c=document.getElementById("iframeRecon").contentDocument;if(!c){gm.log("Recon HTML page not ready. waithing For 30 more secionds.");this.SetTimer("PlayerReconTimer",30);return true}this.SetDivContent("idle_mess","Player Recon: In Progress");
var b=c.evaluate("//input[contains(@src,'battle_01.gif')]",c,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);if(b.snapshotLength<=0){c.location.reload(true);gm.log("Recon can not find battle page");caap.SetDivContent("idle_mess","");return false}for(var d=gm.getNumber("ReconPlayerRank",99),e=gm.getNumber("ReconPlayerLevel",999),f=gm.getNumber("ReconPlayerARBase",999),i=0,h=0;h<b.snapshotLength;h+=1){for(var g=b.snapshotItem(h);g.tagName.toLowerCase()!="tr";)g=g.parentNode;var k=g,j=this.NumberOnly(this.CheckForImage("symbol_",
k,c).src.match(/\d+\.jpg/i).toString()),m=nHtml.GetText(k).trim(),l=/(.+), Level ([0-9]+)\s*([A-Za-z ]+)\s*([0-9]+)/i.exec(m);if(l){var n=l[1].trim(),r=parseInt(l[2],10),p=l[3].trim(),q=this.rankTable[p.toLowerCase()],s=parseInt(l[4],10),o=nHtml.FindByAttrXPath(k,"input","@name='target_id'",c).value,t=(new Date).getTime();if(!(r-this.stats.level>e))if(!(this.stats.rank-q>d)){var v=this.stats.level/r;k=f*v;if(k<=0)gm.log("Recon unable to calculate army ratio: "+f+"/"+v);else if(!(s>this.stats.army*
k)){i+=1;var u=gm.getListObjVal("targetsOl",o,"invadewinsNum",-1),w=gm.getListObjVal("targetsOl",o,"invadelossesNum",-1),y=gm.getListObjVal("targetsOl",o,"duelwinsNum",-1),F=gm.getListObjVal("targetsOl",o,"duellossesNum",-1),z=gm.getListObjVal("targetsOl",o,"defendwinsNum",-1),G=gm.getListObjVal("targetsOl",o,"defendlossesNum",-1),A=gm.getListObjVal("targetsOl",o,"goldNum",-1),x=gm.getListObjVal("targetsOl",o,"attackTime",0),H=gm.getListObjVal("targetsOl",o,"selectTime",0),B=gm.getListObjVal("targetsOl",
o,"statswinsNum",-1),C=gm.getListObjVal("targetsOl",o,"statswinsNum",-1),D=gm.getValue("LimitTargets",100);gm.setListObjVal("targetsOl",o,"nameStr",n,D);gm.setListObjVal("targetsOl",o,"rankStr",p);gm.setListObjVal("targetsOl",o,"rankNum",q);gm.setListObjVal("targetsOl",o,"levelNum",r);gm.setListObjVal("targetsOl",o,"armyNum",s);gm.setListObjVal("targetsOl",o,"deityNum",j);gm.setListObjVal("targetsOl",o,"invadewinsNum",u);gm.setListObjVal("targetsOl",o,"invadelossesNum",w);gm.setListObjVal("targetsOl",
o,"duelwinsNum",y);gm.setListObjVal("targetsOl",o,"duellossesNum",F);gm.setListObjVal("targetsOl",o,"defendwinsNum",z);gm.setListObjVal("targetsOl",o,"defendlossesNum",G);gm.setListObjVal("targetsOl",o,"statswinsNum",B);gm.setListObjVal("targetsOl",o,"statslossesNum",C);gm.setListObjVal("targetsOl",o,"goldNum",A);gm.setListObjVal("targetsOl",o,"aliveTime",t);gm.setListObjVal("targetsOl",o,"attackTime",x);gm.setListObjVal("targetsOl",o,"selectTime",H)}}}else gm.log("Recon can not parse target text string"+
m)}c.location.reload(true);var E=gm.getValue("PlayerReconRetry",60);this.SetTimer("PlayerReconTimer",E);i>0?this.SetDivContent("idle_mess","Player Recon: Found:"+i+" Total:"+gm.getList("targetsOl").length):this.SetDivContent("idle_mess","Player Recon: No Targets Found");window.setTimeout(function(){caap.SetDivContent("idle_mess","")},E*1E3);return false}catch(I){gm.log("ERROR in Recon :"+I);return false}},currentPage:"",currentTab:"",waitMilliSecs:5E3,actionDescTable:{AutoIncome:"Awaiting Income",
AutoStat:"Upgrade Skill Points",MaxEnergyQuest:"At Max Energy Quest",PassiveGeneral:"Setting Idle General",Idle:"Idle Tasks",ImmediateBanking:"Immediate Banking",Battle:"Battling Players",MonsterReview:"Review Monsters/Raids",ImmediateAutoStat:"Immediate Auto Stats",AutoElite:"Fill Elite Guard",ArenaElite:"Fill Arena Elite",AutoPotions:"Auto Potions",AutoAlchemy:"Auto Alchemy",AutoBless:"Auto Bless",AutoGift:"Auto Gifting",MonsterFinder:"Monster Finder",DemiPoints:"Demi Points First",Monsters:"Fighting Monsters",
Heal:"Auto Healing",Bank:"Auto Banking",Lands:"Land Operations"},CheckLastAction:function(c){var b=gm.getValue("LastAction","none");this.actionDescTable[c]?this.SetDivContent("activity_mess","Activity: "+this.actionDescTable[c]):this.SetDivContent("activity_mess","Activity: "+c);if(b!=c){gm.log("Changed from doing "+b+" to "+c);gm.setValue("LastAction",c)}},masterActionList:{0:"AutoElite",1:"ArenaElite",2:"Heal",3:"ImmediateBanking",4:"ImmediateAutoStat",5:"MaxEnergyQuest",6:"DemiPoints",7:"MonsterReview",
8:"Monsters",9:"Battle",10:"MonsterFinder",11:"Quests",12:"PassiveGeneral",13:"Lands",14:"Bank",15:"AutoBless",16:"AutoStat",17:"AutoGift",18:"AutoPotions",19:"AutoAlchemy",20:"Idle"},actionsList:[],MakeActionsList:function(){try{if(this.actionsList.length===0){gm.log("Loading a fresh Action List");var c="",b=[],d=0,e=gm.getValue("actionOrder","");if(e!==""){gm.log("Trying user defined Action Order");b=e.split(",");for(c in this.masterActionList)if(this.masterActionList.hasOwnProperty(c))d+=1;else{gm.log("Error Getting Master Action List length!");
gm.log("Skipping 'action' from masterActionList: "+c)}}else{gm.log("Building the default Action Order");for(c in this.masterActionList)if(this.masterActionList.hasOwnProperty(c))d=b.push(c);else{gm.log("Error Building Default Action Order!");gm.log("Skipping 'action' from masterActionList: "+c)}}var f=b.length;if(f===0)throw"Action Order Array is empty! "+e===""?"(Default)":"(User)";f<d&&gm.log("Warning! Action Order Array has fewer orders than default!");f>d&&gm.log("Warning! Action Order Array has more orders than default!");
for(c=0;c!==f;c+=1){d="";d=e!==""?this.masterActionList[parseInt(b[c],16)]:this.masterActionList[b[c]];if(d.length>0&&typeof d==="string")this.actionsList.push(d);else{gm.log("Error! Skipping actionItem");gm.log("Action Item("+c+"): "+d)}}e!==""&&gm.log("Get Action List: "+this.actionsList)}return true}catch(i){gm.log("ERROR in MakeActionsList: "+i);this.actionsList=["AutoElite","ArenaElite","Heal","ImmediateBanking","ImmediateAutoStat","MaxEnergyQuest","DemiPoints","MonsterReview","Monsters","Battle",
"MonsterFinder","Quests","PassiveGeneral","Lands","Bank","AutoBless","AutoStat","AutoGift","AutoPotions","AutoAlchemy","Idle"];return false}},MainLoop:function(){this.waitMilliSecs=5E3;if(location.href.indexOf("/common/error.html")>=0){gm.log("detected error page, waiting to go back to previous page.");window.setTimeout(function(){window.history.go(-1)},3E4)}else if(document.getElementById("try_again_button")){gm.log("detected Try Again message, waiting to reload");window.setTimeout(function(){window.history.go(0)},
3E4)}else{if(gm.getValue("fbFilter",false)&&(window.location.href.indexOf("apps.facebook.com/reqs.php")>=0||window.location.href.indexOf("apps.facebook.com/home.php")>=0||window.location.href.indexOf("filter=app_46755028429")>=0))typeof GM_addStyle!="undefined"&&GM_addStyle('#contentArea div[id^="div_story_"]:not([class*="46755028429"]) {\ndisplay:none !important;\n}');var c=false;if(global.is_chrome){if(window.location.href.indexOf("apps.facebook.com/reqs.php")>=0||window.location.href.indexOf("apps.facebook.com/home.php")>=
0||window.location.href.indexOf("filter=app_46755028429")>=0)c=true}else if(window.location.href.indexOf("www.facebook.com/reqs.php")>=0||window.location.href.indexOf("www.facebook.com/home.php")>=0||window.location.href.indexOf("filter=app_46755028429")>=0)c=true;if(c){if(gm.getValue("mfStatus","")=="OpenMonster"){gm.log("Opening Monster "+gm.getValue("navLink"));this.CheckMonster()}else if(gm.getValue("mfStatus","")=="CheckMonster"){gm.log("Scanning URL for new monster");this.selectMonst()}this.MonsterFinderOnFB();
this.AcceptGiftOnFB()}else{if(c=nHtml.FindByAttrContains(document.body,"a","class","undo_link")){this.Click(c);gm.log("Undoing notification")}if(c=gm.getValue("Disabled",false))global.is_chrome&&CE_message("disabled",null,c);else if(this.GetStats()){gm.setValue("NoWindowLoad",0);if(gm.getValue("caapPause","none")!="none"){var b=document.getElementById("caap_div");document.getElementById("caap_div").style.background=gm.getValue("StyleBackgroundDark","#fee");document.getElementById("caap_div").style.opacity=
b.style.transparency=gm.getValue("StyleOpacityDark","1")}else{if(this.WhileSinceDidIt("clickedOnSomething",25)&&this.waitingForDomLoad){gm.log("Clicked on something, but nothing new loaded.  Reloading page.");this.ReloadCastleAge()}if(this.AutoIncome())this.CheckLastAction("AutoIncome");else{this.MakeActionsList();c=this.actionsList.slice();gm.getValue("ReleaseControl",false)?gm.setValue("ReleaseControl",false):c.unshift(gm.getValue("LastAction","Idle"));for(b in c)if(c.hasOwnProperty(b))if(this[c[b]]()){this.CheckLastAction(c[b]);
break}}}}else{b=gm.getValue("NoWindowLoad",0);if(b===0){this.JustDidIt("NoWindowLoadTimer");gm.setValue("NoWindowLoad",1)}else if(this.WhileSinceDidIt("NoWindowLoadTimer",Math.min(Math.pow(2,b-1)*15,3600))){this.JustDidIt("NoWindowLoadTimer");gm.setValue("NoWindowLoad",b+1);this.ReloadCastleAge()}gm.log("Page no-load count: "+b)}}this.WaitMainLoop()}},WaitMainLoop:function(){this.waitForPageChange=true;nHtml.setTimeout(function(){this.waitForPageChange=false;caap.MainLoop()},caap.waitMilliSecs*(1+
Math.random()*0.2))},ReloadCastleAge:function(){if(window.location.href.indexOf("castle_age")>=0&&!gm.getValue("Disabled")&&gm.getValue("caapPause")=="none"){global.is_chrome&&CE_message("paused",null,gm.getValue("caapPause","none"));window.location="http://apps.facebook.com/castle_age/index.php?bm=1"}},ReloadOccasionally:function(){var c=gm.getNumber("ReloadFrequency",8);if(!c||c<8)c=8;nHtml.setTimeout(function(){if(caap.WhileSinceDidIt("clickedOnSomething",300)){gm.log("Reloading if not paused after inactivity");
if(window.location.href.indexOf("castle_age")>=0&&!gm.getValue("Disabled")&&gm.getValue("caapPause")=="none"){global.is_chrome&&CE_message("paused",null,gm.getValue("caapPause","none"));window.location="http://apps.facebook.com/castle_age/index.php?bm=1"}}caap.ReloadOccasionally()},6E4*c+c*60*1E3*Math.random())}};if(typeof GM_log!="function"){alert("Your browser does not appear to support Greasemonkey scripts!");throw"Error: Your browser does not appear to support Greasemonkey scripts!";}gm.log("Starting");
if(global.is_chrome){try{var lastVersion=localStorage.getItem(global.gameName+"__LastVersion",0),shouldTryConvert=false;if(lastVersion)if(lastVersion.substr(0,1)=="s")shouldTryConvert=true;if(caapVersion<="140.21.9"||shouldTryConvert)ConvertGMtoJSON()}catch(e$$48){gm.log("Error converting DB: "+e$$48)}try{CM_Listener()}catch(e$$49){gm.log("Error loading CM_Listener"+e$$49)}}
if(gm.getValue("SetTitle")){var DocumentTitle="";if(gm.getValue("SetTitleAction",false))DocumentTitle+="Starting - ";if(gm.getValue("SetTitleName",false))DocumentTitle+=gm.getValue("PlayerName","CAAP")+" - ";document.title=DocumentTitle+global.documentTitle}
if(!global.is_chrome)try{if(gm.getValue("SUC_remote_version",0)>caapVersion)global.newVersionAvailable=true;var updateCheck=function(c){if(c||parseInt(gm.getValue("SUC_last_update","0"),10)+864E5<=(new Date).getTime())try{GM_xmlhttpRequest({method:"GET",url:"http://github.com/Xotic750/Castle-Age-Autoplayer/raw/master/Castle-Age-Autoplayer.user.js",headers:{"Cache-Control":"no-cache"},onload:function(d){var e=d.responseText;d=/@version\s*(.*?)\s*$/m.exec(e)[1];e=/@name\s*(.*?)\s*$/m.exec(e)[1];gm.setValue("SUC_last_update",
(new Date).getTime()+"");gm.setValue("SUC_target_script_name",e);gm.setValue("SUC_remote_version",d);gm.log("remote version "+d);if(d>caapVersion){global.newVersionAvailable=true;c&&confirm('There is an update available for the Greasemonkey script "'+e+'."\nWould you like to go to the install page now?')&&GM_openInTab("http://senses.ws/caap/index.php?topic=771.msg3582#msg3582")}else c&&alert('No update is available for "'+e+'."')}})}catch(b){c&&alert("An error occurred while checking for updates:\n"+
b)}};GM_registerMenuCommand(gm.getValue("SUC_target_script_name","???")+" - Manual Update Check",function(){updateCheck(true)});updateCheck(false)}catch(err$$14){gm.log("ERROR in GitHub updater: "+err$$14)}
if(gm.getValue("LastVersion",0)!=caapVersion)try{parseInt(gm.getValue("LastVersion",0),10)<121&&gm.setValue("WhenBattle",gm.getValue("WhenFight","Stamina Available"));if(parseInt(gm.getValue("LastVersion",0),10)<126)for(var storageKeys=GM_listValues(),key=0;key<storageKeys.length;key+=1)GM_getValue(storageKeys[key])&&GM_setValue(storageKeys[key],GM_getValue(storageKeys[key]).toString().replace("~",global.os).replace("`",global.vs));if(parseInt(gm.getValue("LastVersion",0),10)<130&&gm.getValue("MonsterGeneral")){gm.setValue("AttackGeneral",
gm.getValue("MonsterGeneral"));gm.deleteValue("MonsterGeneral")}if(parseInt(gm.getValue("LastVersion",0),10)<133){var clearList=["FreshMeatMaxLevel","FreshMeatARMax","FreshMeatARMin"];clearList.forEach(function(c){gm.setValue(c,"")})}if((gm.getValue("LastVersion",0)<"140.15.3"||gm.getValue("LastVersion",0)<"140.21.0")&&gm.getValue("actionOrder","")!=="")alert("You are using a user defined Action List!\nThe Master Action List has changed!\nYou must update your Action List!");if(gm.getValue("LastVersion",
0)<"140.16.2")for(var a=1;a<=5;a+=1){var attribute=gm.getValue("Attribute"+a,"");if(attribute!==""){gm.setValue("Attribute"+a,attribute.ucFirst());gm.log("Converted Attribute"+a+": "+attribute+"   to: "+attribute.ucFirst())}}gm.setValue("LastVersion",caapVersion)}catch(err$$15){gm.log("ERROR in Environment updater: "+err$$15)}
$(function(){gm.log("Full page load completed");gm.setValue("clickUrl",window.location.href);if(window.location.href.indexOf("facebook.com/castle_age/")>=0){gm.deleteValue("ArmyCount");gm.deleteValue("waiting");gm.setValue("caapPause","none");gm.setValue("ReleaseControl",true);gm.deleteValue("statsMatch");global.is_chrome&&CE_message("paused",null,gm.getValue("caapPause","none"));nHtml.setTimeout(function(){caap.init()},200)}this.waitMilliSecs=8E3;caap.WaitMainLoop()});caap.ReloadOccasionally();
